content = '<!DOCTYPE html>\n<html lang="en">\n<head>\n<meta charset="UTF-8"/>\n<meta name="viewport" content="width=device-width, initial-scale=1.0"/>\n<title>ARIA Radiology Workbench · King\'s College Hospital</title>\n<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>\n<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>\n<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>\n<link rel="preconnect" href="https://fonts.googleapis.com">\n<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Mono:wght@300;400;500&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">\n<style>\n*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}\n\n/* ══════════════════════════════════════════\n   CSS VARIABLES — DARK (default)\n══════════════════════════════════════════ */\n:root {\n  --bg0:#0e1117; --bg1:#151b24; --bg2:#1c2433; --bg3:#232d3f;\n  --bg-hover:rgba(0,94,184,0.08); --bg-active:rgba(0,94,184,0.14);\n  --nhs:#003087; --nhs2:#005eb8; --accent:#00aaff; --accent2:#00d4aa;\n  --urgent:#e8001e; --warn:#e07b00; --ok:#00914d; --info:#7b61ff;\n  --text0:#f0f4ff; --text1:#a8bacf; --text2:#5a7090; --text3:#334455;\n  --border:rgba(255,255,255,0.07); --border2:rgba(0,170,255,0.2);\n  --shadow:0 2px 16px rgba(0,0,0,0.4); --shadow2:0 8px 40px rgba(0,0,0,0.6);\n  --glow:0 0 24px rgba(0,170,255,0.2); --glow-r:0 0 20px rgba(232,0,30,0.3);\n  --font-h:\'DM Serif Display\',serif; --font-m:\'DM Mono\',monospace; --font-s:\'DM Sans\',sans-serif;\n  --rail:64px; --header:52px;\n  --card-r:8px;\n}\n/* ── LIGHT ── */\n[data-theme="light"] {\n  --bg0:#eef1f6; --bg1:#f8f9fc; --bg2:#ffffff; --bg3:#f0f3f8;\n  --bg-hover:rgba(0,48,135,0.04); --bg-active:rgba(0,48,135,0.09);\n  --accent:#005eb8; --accent2:#007f6e;\n  --urgent:#c0001a; --warn:#b06000; --ok:#006b32;\n  --text0:#0a1628; --text1:#3a5070; --text2:#7090aa; --text3:#b0c4d8;\n  --border:rgba(0,30,80,0.1); --border2:rgba(0,94,184,0.25);\n  --shadow:0 1px 8px rgba(0,20,60,0.08); --shadow2:0 4px 24px rgba(0,20,60,0.12);\n  --glow:0 2px 12px rgba(0,94,184,0.15); --glow-r:0 2px 12px rgba(192,0,26,0.15);\n}\n\n/* ══════════════════════════════════════════ BASE */\nhtml,body{height:100%;background:var(--bg0);color:var(--text0);font-family:var(--font-s);font-size:13px;overflow:hidden;transition:background .25s,color .25s}\n#root{height:100%}\ninput,button,select,textarea{font-family:var(--font-s)}\n::-webkit-scrollbar{width:5px;height:5px}\n::-webkit-scrollbar-track{background:transparent}\n::-webkit-scrollbar-thumb{background:var(--border2);border-radius:3px}\nbutton{cursor:pointer;border:none;outline:none}\ninput,textarea{outline:none}\n\n/* ══════════════════════════════════════════ LOGIN */\n.login-wrap{\n  position:fixed;inset:0;display:flex;align-items:center;justify-content:center;\n  background:linear-gradient(135deg,#001a4d 0%,#003087 40%,#005eb8 70%,#0080c8 100%);\n  z-index:1000;\n}\n.login-wrap::before{\n  content:\'\';position:absolute;inset:0;pointer-events:none;\n  background-image:linear-gradient(rgba(255,255,255,0.03) 1px,transparent 1px),\n    linear-gradient(90deg,rgba(255,255,255,0.03) 1px,transparent 1px);\n  background-size:48px 48px;\n}\n.login-wrap::after{\n  content:\'\';position:absolute;inset:0;pointer-events:none;\n  background:radial-gradient(ellipse at 30% 50%,rgba(0,200,255,0.08) 0%,transparent 60%),\n    radial-gradient(ellipse at 70% 50%,rgba(0,80,200,0.1) 0%,transparent 60%);\n}\n.login-card{\n  background:rgba(255,255,255,0.97);border-radius:16px;padding:48px 44px;width:420px;\n  box-shadow:0 24px 80px rgba(0,0,0,0.4),0 0 0 1px rgba(255,255,255,0.1);\n  position:relative;z-index:1;\n  animation:card-in 0.5s cubic-bezier(0.34,1.56,0.64,1) both;\n}\n@keyframes card-in{from{opacity:0;transform:translateY(24px) scale(0.96)}to{opacity:1;transform:translateY(0) scale(1)}}\n.login-avatar{\n  width:72px;height:72px;margin:0 auto 16px;border-radius:50%;\n  background:linear-gradient(135deg,#003087,#005eb8);\n  display:flex;align-items:center;justify-content:center;\n  box-shadow:0 8px 24px rgba(0,48,135,0.35);\n  font-size:28px;color:white;font-family:var(--font-h);font-style:italic;\n}\n.login-title{font-family:var(--font-h);font-size:32px;font-weight:400;color:#003087;text-align:center;font-style:italic;margin-bottom:4px}\n.login-sub{font-size:12px;color:#5a7090;text-align:center;letter-spacing:0.06em;margin-bottom:6px}\n.login-badge{display:inline-block;background:#003087;color:white;font-size:9px;font-weight:700;letter-spacing:0.12em;padding:3px 10px;border-radius:12px;margin-bottom:28px}\n.login-label{font-size:10px;font-weight:600;letter-spacing:0.1em;color:#5a7090;text-transform:uppercase;margin-bottom:6px;display:block}\n.login-input{\n  width:100%;padding:11px 14px;border:1.5px solid #d0dae8;border-radius:8px;\n  font-size:14px;color:#0a1628;background:white;margin-bottom:16px;\n  transition:border-color .2s,box-shadow .2s;\n}\n.login-input:focus{border-color:#005eb8;box-shadow:0 0 0 3px rgba(0,94,184,0.12)}\n.login-btn{\n  width:100%;padding:13px;background:#003087;color:white;border-radius:8px;\n  font-size:13px;font-weight:700;letter-spacing:0.1em;text-transform:uppercase;\n  transition:all .2s;box-shadow:0 4px 16px rgba(0,48,135,0.3);margin-bottom:20px;\n}\n.login-btn:hover{background:#002468;box-shadow:0 6px 24px rgba(0,48,135,0.4);transform:translateY(-1px)}\n.login-btn:active{transform:translateY(0)}\n.login-btn:disabled{opacity:0.6;cursor:not-allowed;transform:none}\n.login-confidential{font-size:11px;color:#c0001a;font-weight:600;text-align:center;margin-bottom:4px}\n.login-footer{font-size:10px;color:#8090a0;text-align:center;line-height:1.7}\n.login-error{background:#fff0f0;border:1px solid #ffc0c8;border-radius:6px;padding:10px 14px;font-size:12px;color:#c0001a;margin-bottom:16px;text-align:center}\n\n/* ══════════════════════════════════════════ APP SHELL */\n.app{display:grid;grid-template-columns:var(--rail) 1fr;grid-template-rows:var(--header) 1fr;height:100vh;transition:all .25s}\n\n/* ── TOP BAR ── */\n.topbar{\n  grid-column:1/-1;display:flex;align-items:center;gap:0;\n  background:var(--nhs);border-bottom:1px solid rgba(255,255,255,0.1);\n  position:relative;z-index:200;box-shadow:0 2px 16px rgba(0,0,0,0.3);\n}\n.topbar::after{content:\'\';position:absolute;bottom:0;left:0;right:0;height:2px;background:linear-gradient(90deg,#005eb8,#00843d,#ffb81c);opacity:0.6}\n.topbar-logo{width:var(--rail);display:flex;align-items:center;justify-content:center;flex-shrink:0}\n.nhs-sq{background:white;color:#003087;font-weight:900;font-size:13px;padding:4px 7px;border-radius:3px;letter-spacing:-0.02em}\n.topbar-brand{padding:0 20px;border-right:1px solid rgba(255,255,255,0.12)}\n.topbar-brand h1{font-family:var(--font-h);font-size:17px;font-style:italic;color:white;letter-spacing:0.02em}\n.topbar-brand p{font-size:9px;color:rgba(255,255,255,0.5);letter-spacing:0.1em;margin-top:1px}\n.topbar-banner{flex:1;display:flex;align-items:center;gap:0;padding:0 16px;overflow:hidden}\n.banner-field{padding:0 16px;border-right:1px solid rgba(255,255,255,0.1)}\n.banner-field:last-child{border-right:none}\n.bf-label{font-size:8px;color:rgba(255,255,255,0.4);letter-spacing:0.1em;text-transform:uppercase;margin-bottom:1px}\n.bf-val{font-size:12px;color:white;font-family:var(--font-m);font-weight:400}\n.bf-val.alert{color:#ffb81c}\n.topbar-right{display:flex;align-items:center;gap:12px;padding:0 16px}\n.theme-tog{display:flex;background:rgba(255,255,255,0.1);border-radius:20px;padding:3px;border:1px solid rgba(255,255,255,0.15)}\n.ttb{padding:3px 10px;border-radius:16px;font-size:9px;font-weight:700;letter-spacing:0.1em;background:transparent;color:rgba(255,255,255,0.45);transition:all .2s;border:none}\n.ttb.on{background:rgba(255,255,255,0.9);color:#003087}\n.topbar-user{display:flex;align-items:center;gap:8px}\n.user-chip{background:rgba(255,255,255,0.15);border-radius:20px;padding:5px 12px;font-size:11px;color:white;font-weight:500}\n.logout-btn{background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);color:rgba(255,255,255,0.7);padding:5px 12px;border-radius:6px;font-size:10px;font-weight:600;letter-spacing:0.08em;transition:all .2s}\n.logout-btn:hover{background:rgba(255,255,255,0.2)}\n.live-pill{display:flex;align-items:center;gap:5px;font-size:9px;font-weight:700;letter-spacing:0.12em;color:#6effb4}\n.live-d{width:6px;height:6px;border-radius:50%;background:#6effb4;animation:pd 1.5s ease-in-out infinite}\n@keyframes pd{0%,100%{opacity:1}50%{opacity:0.3}}\n\n/* ── RAIL ── */\n.rail{\n  background:var(--bg1);border-right:1px solid var(--border);\n  display:flex;flex-direction:column;align-items:center;padding:12px 0;gap:4px;\n  overflow:hidden;z-index:100;\n}\n.rail-btn{\n  width:44px;height:44px;border-radius:10px;display:flex;flex-direction:column;\n  align-items:center;justify-content:center;gap:2px;background:transparent;\n  color:var(--text2);transition:all .2s;position:relative;\n}\n.rail-btn:hover{background:var(--bg-hover);color:var(--text1)}\n.rail-btn.active{background:var(--bg-active);color:var(--accent)}\n.rail-btn.active::before{content:\'\';position:absolute;left:0;top:50%;transform:translateY(-50%);width:3px;height:24px;background:var(--accent);border-radius:0 3px 3px 0}\n.rail-icon{font-size:18px;line-height:1}\n.rail-label{font-size:7px;font-weight:700;letter-spacing:0.06em;text-transform:uppercase}\n.rail-spacer{flex:1}\n.rail-divider{width:32px;height:1px;background:var(--border);margin:4px 0}\n\n      /* ── WORKSPACE ── */\n.workspace{background:var(--bg0);overflow:hidden;display:flex;flex-direction:column;margin-right:290px}\n\n/* ══════════════════════════════════════════ WORKLIST */\n.wl-wrap{display:grid;grid-template-rows:auto 1fr;height:100%;overflow:hidden}\n.wl-toolbar{\n  padding:12px 16px;background:var(--bg1);border-bottom:1px solid var(--border);\n  display:flex;align-items:center;gap:10px;flex-wrap:wrap;\n}\n.wl-title{font-family:var(--font-h);font-size:20px;font-style:italic;color:var(--text0);margin-right:8px;white-space:nowrap}\n.search-box{\n  display:flex;align-items:center;gap:8px;background:var(--bg2);border:1px solid var(--border);\n  border-radius:8px;padding:7px 12px;flex:1;min-width:180px;max-width:280px;\n}\n.search-box input{background:transparent;border:none;color:var(--text0);font-size:12px;width:100%}\n.search-box input::placeholder{color:var(--text2)}\n.filter-sel{\n  background:var(--bg2);border:1px solid var(--border);color:var(--text1);\n  border-radius:8px;padding:7px 10px;font-size:11px;font-family:var(--font-s);\n}\n.filter-sel:focus{border-color:var(--border2)}\n.wl-stat{padding:5px 12px;border-radius:6px;font-size:10px;font-weight:700;letter-spacing:0.06em;border:1px solid;background:transparent}\n.wl-stat.red{color:var(--urgent);border-color:var(--urgent);background:rgba(232,0,30,0.06)}\n.wl-stat.amb{color:var(--warn);border-color:var(--warn);background:rgba(224,123,0,0.06)}\n.wl-stat.grn{color:var(--ok);border-color:var(--ok);background:rgba(0,145,77,0.06)}\n\n.table-wrap{overflow:auto;flex:1}\ntable{width:100%;border-collapse:collapse;font-size:11px}\nthead th{\n  padding:9px 12px;text-align:left;font-size:9px;font-weight:700;letter-spacing:0.1em;\n  text-transform:uppercase;color:var(--text2);background:var(--bg1);\n  border-bottom:1px solid var(--border);position:sticky;top:0;z-index:10;white-space:nowrap;\n}\ntbody tr{border-bottom:1px solid var(--border);cursor:pointer;transition:background .1s}\ntbody tr:hover{background:var(--bg-hover)}\ntbody tr.active-row{background:var(--bg-active)}\ntbody td{padding:10px 12px;color:var(--text1);vertical-align:middle;white-space:nowrap}\ntbody td.primary{color:var(--text0);font-weight:600}\n.pri-badge{font-size:9px;padding:2px 7px;border-radius:10px;font-weight:700;letter-spacing:0.06em;font-family:var(--font-m)}\n.pri-e{background:rgba(232,0,30,0.12);color:var(--urgent);border:1px solid var(--urgent)}\n.pri-u{background:rgba(224,123,0,0.12);color:var(--warn);border:1px solid var(--warn)}\n.pri-r{background:rgba(0,145,77,0.1);color:var(--ok);border:1px solid var(--ok)}\n.mod-tag{font-size:9px;padding:2px 7px;border-radius:4px;font-family:var(--font-m);font-weight:700}\n.m-CT{background:rgba(0,170,255,0.12);color:var(--accent)}\n.m-MRI{background:rgba(0,212,170,0.12);color:var(--accent2)}\n.m-XR{background:rgba(224,123,0,0.12);color:var(--warn)}\n.m-US{background:rgba(123,97,255,0.12);color:#9b81ff}\n.m-NM{background:rgba(255,97,200,0.12);color:#ff80d0}\n.crit-flag{color:var(--urgent);font-size:14px;animation:cfp 1.5s ease-in-out infinite}\n@keyframes cfp{0%,100%{opacity:1}50%{opacity:0.3}}\n.rs-badge{font-size:9px;padding:2px 7px;border-radius:10px;font-family:var(--font-m)}\n.rs-U{background:rgba(224,123,0,0.1);color:var(--warn)}\n.rs-P{background:rgba(0,170,255,0.1);color:var(--accent)}\n.rs-F{background:rgba(0,145,77,0.1);color:var(--ok)}\n.rs-D{background:rgba(255,255,255,0.05);color:var(--text2)}\n.empty-state{padding:60px;text-align:center;color:var(--text2)}\n.empty-icon{font-size:40px;margin-bottom:12px;opacity:0.3}\n\n/* ══════════════════════════════════════════ STUDY VIEWER */\n.viewer-wrap{display:grid;grid-template-columns:200px 1fr 320px;height:100%;overflow:hidden;gap:0}\n.series-panel{background:var(--bg1);border-right:1px solid var(--border);overflow-y:auto;padding:10px}\n.series-title{font-size:9px;font-weight:700;letter-spacing:0.1em;color:var(--text2);text-transform:uppercase;margin-bottom:10px;padding-bottom:6px;border-bottom:1px solid var(--border)}\n.series-item{\n  padding:8px 10px;border-radius:6px;margin-bottom:4px;cursor:pointer;border:1px solid transparent;\n  transition:all .15s;background:var(--bg2);\n}\n.series-item:hover{border-color:var(--border2);background:var(--bg3)}\n.series-item.active{border-color:var(--accent);background:var(--bg-active)}\n.series-num{font-size:9px;color:var(--text2);font-family:var(--font-m);margin-bottom:2px}\n.series-desc{font-size:11px;color:var(--text0);font-weight:500}\n\n.viewer-canvas{background:#000;position:relative;display:flex;align-items:center;justify-content:center;overflow:hidden}\n.viewer-canvas::before{content:\'\';position:absolute;inset:0;background:radial-gradient(ellipse at center,#1a1a2a 0%,#000 70%)}\n.dicom-img{\n  position:relative;z-index:1;width:520px;height:520px;border-radius:4px;overflow:hidden;\n  display:flex;align-items:center;justify-content:center;\n}\n.dicom-overlay-tl,.dicom-overlay-tr,.dicom-overlay-bl,.dicom-overlay-br{\n  position:absolute;font-size:10px;color:rgba(255,255,0,0.85);font-family:var(--font-m);\n  line-height:1.7;z-index:3;pointer-events:none;text-shadow:1px 1px 2px rgba(0,0,0,0.9);\n}\n.dicom-overlay-tl{top:10px;left:10px}\n.dicom-overlay-tr{top:10px;right:10px;text-align:right}\n.dicom-overlay-bl{bottom:10px;left:10px}\n.dicom-overlay-br{bottom:10px;right:10px;text-align:right}\n.viewer-controls{position:absolute;top:10px;left:50%;transform:translateX(-50%);z-index:10;display:flex;gap:6px}\n.vc-btn{background:rgba(0,0,0,0.6);border:1px solid rgba(255,255,255,0.2);color:rgba(255,255,255,0.8);padding:6px 12px;border-radius:6px;font-size:10px;font-weight:600;letter-spacing:0.08em;transition:all .15s;backdrop-filter:blur(4px)}\n.vc-btn:hover{background:rgba(0,170,255,0.3);border-color:var(--accent);color:white}\n.vc-btn.on{background:rgba(0,170,255,0.4);border-color:var(--accent);color:white}\n.wl-slider{position:absolute;bottom:20px;left:50%;transform:translateX(-50%);z-index:10;display:flex;gap:16px;background:rgba(0,0,0,0.6);padding:10px 20px;border-radius:10px;backdrop-filter:blur(4px)}\n.slider-group{display:flex;flex-direction:column;align-items:center;gap:4px}\n.slider-label{font-size:9px;color:rgba(255,255,255,0.5);letter-spacing:0.08em}\n.slider-group input[type=range]{width:100px;accent-color:var(--accent)}\n\n/* Modality-specific DICOM visuals */\n.dicom-ct{background:radial-gradient(ellipse at center,#2a2a2a 0%,#111 60%,#000 100%)}\n.dicom-mri{background:radial-gradient(ellipse at 40% 40%,#1a1a3a 0%,#080820 60%,#000 100%)}\n.dicom-xr{background:radial-gradient(ellipse at center,#1a1a1a 0%,#050505 100%)}\n.dicom-us{background:radial-gradient(ellipse at center,#0a1520 0%,#000 100%)}\n.dicom-nm{background:radial-gradient(ellipse at center,#1a0a2a 0%,#050010 100%)}\n\n/* SVG anatomy layers */\n.anatomy-svg{position:absolute;inset:0;width:100%;height:100%;opacity:0.85;z-index:2}\n\n.report-side{background:var(--bg1);border-left:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden}\n.report-header{padding:10px 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-shrink:0}\n.rh-title{font-family:var(--font-h);font-size:15px;font-style:italic;color:var(--text0)}\n.rep-fields{overflow-y:auto;flex:1}\n.rep-section{padding:8px 14px;border-bottom:1px solid var(--border)}\n.rep-section label{font-size:9px;font-weight:700;letter-spacing:0.1em;color:var(--text2);text-transform:uppercase;display:block;margin-bottom:5px}\n.rep-textarea{\n  width:100%;background:var(--bg2);border:1px solid var(--border);border-radius:6px;\n  color:var(--text0);font-family:var(--font-m);font-size:11px;font-weight:300;\n  line-height:1.6;padding:7px 10px;resize:vertical;transition:border-color .2s;min-height:52px;\n}\n.rep-textarea.findings{min-height:100px}\n.rep-textarea.impression{min-height:80px}\n.rep-textarea:focus{border-color:var(--border2)}\n.rep-actions{padding:10px 14px;display:flex;flex-direction:column;gap:7px;flex-shrink:0;border-top:1px solid var(--border)}\n.rep-btn{padding:9px 14px;border-radius:8px;font-size:11px;font-weight:700;letter-spacing:0.06em;transition:all .2s;display:flex;align-items:center;justify-content:center;gap:6px}\n.rep-btn.primary{background:var(--nhs2);color:white;border:none}\n.rep-btn.primary:hover{background:#003f9e;box-shadow:var(--glow)}\n.rep-btn.secondary{background:transparent;color:var(--accent);border:1px solid var(--accent)}\n.rep-btn.secondary:hover{background:var(--bg-hover)}\n.dictate-row{display:flex;gap:6px}\n.mic-btn{\n  background:rgba(232,0,30,0.1);border:1px solid rgba(232,0,30,0.3);color:var(--urgent);\n  padding:7px 10px;border-radius:6px;font-size:12px;transition:all .2s;flex-shrink:0;\n}\n.mic-btn.rec{background:rgba(232,0,30,0.25);animation:mpr 1s ease-in-out infinite;border-color:var(--urgent)}\n@keyframes mpr{0%,100%{box-shadow:none}50%{box-shadow:var(--glow-r)}}\n.ai-btn{background:rgba(0,212,170,0.08);border:1px solid rgba(0,212,170,0.3);color:var(--accent2);padding:8px 12px;border-radius:6px;font-size:11px;font-weight:700;letter-spacing:0.06em;transition:all .2s;width:100%}\n.ai-btn:hover{background:rgba(0,212,170,0.18)}\n\n/* ══════════════════════════════════════════ ARIA AVATAR */\n.aria-panel{\n  background:var(--bg1);border-left:1px solid var(--border);\n  display:flex;flex-direction:column;overflow:hidden;min-width:0;\n}\n.aria-avatar-area{\n  padding:16px 14px 12px;display:flex;flex-direction:column;align-items:center;\n  border-bottom:1px solid var(--border);\n  background:linear-gradient(180deg,var(--bg2) 0%,var(--bg1) 100%);\n  position:relative;overflow:hidden;\n}\n.aria-avatar-area::before{\n  content:\'\';position:absolute;inset:0;pointer-events:none;\n  background:radial-gradient(ellipse at 50% 0%,rgba(0,170,255,0.07) 0%,transparent 65%);\n}\n/* ARIA SVG FACE */\n.aria-face-wrap{\n  position:relative;width:110px;height:130px;margin-bottom:8px;\n}\n.aria-face-wrap::after{\n  content:\'\';position:absolute;bottom:-6px;left:50%;transform:translateX(-50%);\n  width:80px;height:12px;background:radial-gradient(ellipse,rgba(0,100,200,0.25) 0%,transparent 70%);\n  border-radius:50%;\n}\n.aria-face-svg{width:100%;height:100%;filter:drop-shadow(0 6px 20px rgba(0,80,200,0.35))}\n.aria-name{font-family:var(--font-h);font-size:20px;font-style:italic;color:var(--text0);margin-bottom:1px;letter-spacing:0.02em}\n.aria-sub{font-size:8px;color:var(--text2);letter-spacing:0.12em;margin-bottom:10px;text-align:center;text-transform:uppercase}\n\n/* State indicator - prominent */\n.aria-state-wrap{width:100%;margin-bottom:10px}\n.aria-state{\n  display:flex;align-items:center;justify-content:center;gap:6px;\n  font-size:9px;font-weight:800;letter-spacing:0.14em;padding:5px 14px;border-radius:20px;\n  border:1px solid var(--border2);color:var(--accent);background:rgba(0,170,255,0.08);\n  text-transform:uppercase;transition:all .3s;\n}\n.aria-state.listening{color:var(--urgent);border-color:var(--urgent);background:rgba(232,0,30,0.1)}\n.aria-state.speaking{color:var(--accent2);border-color:var(--accent2);background:rgba(0,212,170,0.1)}\n.aria-state.thinking{color:#b090ff;border-color:#b090ff;background:rgba(160,120,255,0.1)}\n.state-dot{width:6px;height:6px;border-radius:50%;background:currentColor;flex-shrink:0}\n.aria-state.listening .state-dot{animation:mpr 0.7s ease-in-out infinite}\n.aria-state.speaking .state-dot{animation:mpr 0.4s ease-in-out infinite}\n.aria-state.thinking .state-dot{animation:mpr 1.2s ease-in-out infinite}\n\n/* Waveform visualiser */\n.aria-waveform{\n  display:flex;align-items:center;justify-content:center;gap:3px;\n  height:28px;width:100%;margin-bottom:8px;\n}\n.wave-bar{\n  width:3px;border-radius:2px;background:var(--accent);opacity:0.5;\n  transition:height .1s ease,opacity .1s ease;\n  min-height:3px;\n}\n.aria-waveform.active .wave-bar{opacity:0.9}\n.aria-waveform.thinking .wave-bar{background:#b090ff;animation:think-wave 1.2s ease-in-out infinite}\n@keyframes think-wave{0%,100%{height:4px;opacity:0.3}50%{height:16px;opacity:0.8}}\n\n/* Big talk button */\n.talk-btn-wrap{width:100%;margin-bottom:8px}\n.talk-btn{\n  width:100%;padding:11px;border-radius:12px;\n  font-size:12px;font-weight:800;letter-spacing:0.1em;text-transform:uppercase;\n  display:flex;align-items:center;justify-content:center;gap:8px;\n  transition:all .2s;border:2px solid;\n}\n.talk-btn.idle{\n  background:rgba(232,0,30,0.08);border-color:rgba(232,0,30,0.4);color:var(--urgent);\n}\n.talk-btn.idle:hover{background:rgba(232,0,30,0.16);border-color:var(--urgent)}\n.talk-btn.recording{\n  background:rgba(232,0,30,0.2);border-color:var(--urgent);color:var(--urgent);\n  animation:mpr 0.8s ease-in-out infinite;\n}\n.talk-btn-icon{font-size:16px}\n.mute-btn{\n  background:var(--bg3);border:1px solid var(--border);color:var(--text1);\n  padding:7px 12px;border-radius:8px;font-size:10px;font-weight:700;letter-spacing:0.06em;\n  transition:all .15s;flex:1;\n}\n.mute-btn.muted{color:var(--text2);opacity:0.6}\n.voice-row{display:flex;gap:6px;width:100%;margin-bottom:8px}\n.voice-sel{background:var(--bg2);border:1px solid var(--border);color:var(--text1);border-radius:6px;padding:5px 8px;font-size:10px;flex:1}\n\n/* Captions */\n.aria-captions{\n  background:rgba(0,0,0,0.45);border-radius:10px;padding:12px 14px;\n  font-size:13px;color:#c8e6ff;font-family:var(--font-m);font-weight:400;\n  line-height:1.9;min-height:100px;border:1px solid rgba(0,170,255,0.2);width:100%;\n  font-style:italic;height:220px;overflow-y:auto;word-wrap:break-word;word-break:break-word;\n  letter-spacing:0.01em;\n}\n[data-theme="light"] .aria-captions{background:rgba(0,30,80,0.04);color:var(--text1)}\n.aria-chat{flex:1;overflow-y:auto;padding:10px}\n.aria-input-row{padding:8px 10px;border-top:1px solid var(--border);display:flex;gap:6px}\n.aria-input{flex:1;background:var(--bg2);border:1px solid var(--border);border-radius:8px;padding:7px 10px;color:var(--text0);font-size:12px;font-family:var(--font-s)}\n.aria-input:focus{border-color:var(--border2)}\n.aria-input::placeholder{color:var(--text2)}\n.aria-send{background:var(--nhs2);color:white;border-radius:8px;padding:7px 12px;font-size:11px;font-weight:700;transition:all .2s}\n.aria-send:hover{background:#003f9e}\n.msg{margin-bottom:10px;display:flex;flex-direction:column;gap:3px}\n.msg-role{font-size:8px;font-weight:700;letter-spacing:0.1em;color:var(--text2);text-transform:uppercase}\n.msg-body{font-size:11px;color:var(--text1);line-height:1.6;padding:8px 10px;border-radius:8px;background:var(--bg2);border:1px solid var(--border)}\n.msg.aria .msg-body{background:var(--bg-active);border-color:var(--border2);color:var(--text0)}\n\n/* ══════════════════════════════════════════ GENERATOR */\n.gen-wrap{padding:24px;overflow-y:auto;height:100%}\n.gen-title{font-family:var(--font-h);font-size:26px;font-style:italic;color:var(--text0);margin-bottom:6px}\n.gen-sub{font-size:12px;color:var(--text2);margin-bottom:28px}\n.gen-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px;max-width:800px}\n.gen-card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--card-r);padding:20px}\n.gen-card-title{font-size:11px;font-weight:700;letter-spacing:0.1em;color:var(--text2);text-transform:uppercase;margin-bottom:16px}\n.slider-wrap{margin-bottom:16px}\n.slider-wrap label{font-size:11px;color:var(--text1);display:flex;justify-content:space-between;margin-bottom:6px}\n.slider-wrap label span{font-family:var(--font-m);color:var(--accent);font-weight:500}\n.slider-wrap input{width:100%;accent-color:var(--accent)}\n.gen-btn{\n  background:linear-gradient(135deg,var(--nhs),var(--nhs2));color:white;\n  padding:14px 28px;border-radius:10px;font-size:13px;font-weight:700;letter-spacing:0.08em;\n  box-shadow:0 4px 16px rgba(0,48,135,0.3);transition:all .2s;\n}\n.gen-btn:hover{transform:translateY(-2px);box-shadow:0 8px 24px rgba(0,48,135,0.4)}\n.gen-result{\n  margin-top:20px;background:var(--bg2);border:1px solid var(--border);border-radius:var(--card-r);\n  padding:20px;max-width:800px;\n}\n.gen-result-title{font-family:var(--font-h);font-size:18px;font-style:italic;color:var(--ok);margin-bottom:8px}\n.gen-stat-row{display:flex;gap:24px;flex-wrap:wrap}\n.gen-stat{text-align:center}\n.gen-stat-n{font-family:var(--font-h);font-size:32px;font-style:italic;color:var(--accent)}\n.gen-stat-l{font-size:10px;color:var(--text2);letter-spacing:0.08em;text-transform:uppercase}\n\n/* ══════════════════════════════════════════ IMPORT/EXPORT */\n.ie-wrap{padding:24px;overflow-y:auto;height:100%;max-width:900px}\n.ie-title{font-family:var(--font-h);font-size:26px;font-style:italic;color:var(--text0);margin-bottom:24px}\n.ie-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px}\n.ie-card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--card-r);padding:20px}\n.ie-card-title{font-size:11px;font-weight:700;letter-spacing:0.1em;color:var(--text2);text-transform:uppercase;margin-bottom:16px;display:flex;align-items:center;gap:6px}\n.drop-zone{\n  border:2px dashed var(--border2);border-radius:8px;padding:32px;text-align:center;\n  cursor:pointer;transition:all .2s;margin-bottom:12px;\n}\n.drop-zone:hover{border-color:var(--accent);background:var(--bg-hover)}\n.drop-zone-icon{font-size:28px;margin-bottom:8px;opacity:0.5}\n.drop-zone-text{font-size:12px;color:var(--text2)}\n.ie-btn{padding:10px 20px;border-radius:8px;font-size:11px;font-weight:700;letter-spacing:0.06em;transition:all .2s;width:100%;margin-bottom:8px}\n.ie-btn.export{background:var(--nhs2);color:white;border:none}\n.ie-btn.export:hover{background:#003f9e}\n.ie-btn.export-csv{background:transparent;color:var(--accent2);border:1px solid var(--accent2)}\n.ie-result{font-size:12px;color:var(--ok);margin-top:10px;font-family:var(--font-m);padding:8px;background:rgba(0,145,77,0.08);border-radius:6px;border:1px solid rgba(0,145,77,0.2)}\n\n/* ══════════════════════════════════════════ ANALYTICS */\n.analytics-wrap{padding:20px 24px;overflow-y:auto;height:100%;max-width:960px}\n.a-title{font-family:var(--font-h);font-size:24px;font-style:italic;color:var(--text0);margin-bottom:4px}\n.a-subtitle{font-size:11px;color:var(--text2);margin-bottom:20px;letter-spacing:0.04em}\n.a-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:16px}\n.a-card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--card-r);padding:16px 18px;position:relative;overflow:hidden}\n.a-card::before{content:\'\';position:absolute;top:0;left:0;right:0;height:3px}\n.a-card.blue::before{background:var(--accent)}\n.a-card.red::before{background:var(--urgent)}\n.a-card.green::before{background:var(--ok)}\n.a-card.amber::before{background:var(--warn)}\n.a-card.purple::before{background:#9b81ff}\n.a-n{font-family:var(--font-h);font-size:38px;font-style:italic;color:var(--text0);line-height:1;margin-bottom:2px}\n.a-l{font-size:9px;color:var(--text2);letter-spacing:0.1em;text-transform:uppercase;margin-bottom:4px}\n.a-sub{font-size:10px;color:var(--text2);margin-top:4px}\n.a-pct{font-size:11px;font-weight:700;margin-top:2px}\n.a-section-title{font-size:10px;font-weight:700;letter-spacing:0.1em;color:var(--text2);text-transform:uppercase;margin:16px 0 10px}\n.a-mod-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;margin-bottom:16px}\n.a-mod-card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--card-r);padding:14px 10px;text-align:center}\n.a-mod-n{font-family:var(--font-h);font-size:26px;font-style:italic}\n.a-mod-l{font-size:9px;color:var(--text2);letter-spacing:0.08em;margin-top:2px;text-transform:uppercase}\n.a-mod-pct{font-size:10px;color:var(--text2);margin-top:2px}\n.a-two-col{display:grid;grid-template-columns:1fr 1fr;gap:12px}\n.bar-chart{background:var(--bg2);border:1px solid var(--border);border-radius:var(--card-r);padding:16px}\n.bar-chart-title{font-size:10px;font-weight:700;letter-spacing:0.1em;color:var(--text2);text-transform:uppercase;margin-bottom:14px}\n.bar-row{display:flex;align-items:center;gap:10px;margin-bottom:8px}\n.bar-label{font-size:10px;color:var(--text1);width:80px;font-family:var(--font-m);flex-shrink:0}\n.bar-track{flex:1;height:6px;background:var(--bg3);border-radius:4px;overflow:hidden}\n.bar-fill{height:100%;border-radius:4px;transition:width 1s ease}\n.bar-val{font-size:10px;color:var(--text2);width:28px;text-align:right;font-family:var(--font-m)}\n.report-status-chart{background:var(--bg2);border:1px solid var(--border);border-radius:var(--card-r);padding:16px}\n.rs-row{display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)}\n.rs-row:last-child{border-bottom:none}\n.rs-label{font-size:11px;color:var(--text1);display:flex;align-items:center;gap:8px}\n.rs-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}\n.rs-nums{display:flex;align-items:center;gap:12px}\n.rs-count{font-family:var(--font-m);font-size:13px;font-weight:600;color:var(--text0)}\n.rs-pct-bar{width:80px;height:4px;background:var(--bg3);border-radius:2px;overflow:hidden}\n.rs-pct-fill{height:100%;border-radius:2px}\n\n/* ══════════════════════════════════════════ PATIENT BANNER (patient loaded) */\n.patient-banner{\n  background:var(--bg1);border-bottom:1px solid var(--border);\n  padding:8px 16px;display:flex;align-items:center;gap:0;font-size:11px;\n}\n.pb-field{padding:0 14px;border-right:1px solid var(--border);display:flex;flex-direction:column;gap:1px}\n.pb-field:first-child{padding-left:0}\n.pb-field:last-child{border-right:none}\n.pb-l{font-size:8px;color:var(--text2);letter-spacing:0.1em;text-transform:uppercase}\n.pb-v{color:var(--text0);font-weight:600;font-family:var(--font-m);font-size:12px}\n.pb-alert{background:rgba(224,123,0,0.1);border:1px solid rgba(224,123,0,0.3);color:var(--warn);padding:3px 8px;border-radius:4px;font-size:9px;font-weight:700;letter-spacing:0.06em}\n.pb-critical{background:rgba(232,0,30,0.1);border:1px solid rgba(232,0,30,0.3);color:var(--urgent);padding:3px 8px;border-radius:4px;font-size:9px;font-weight:700;letter-spacing:0.06em;animation:cfp 1.5s ease-in-out infinite}\n\n/* ══════════════════════════════════════════ MISC */\n.section-hdr{font-family:var(--font-h);font-size:14px;font-style:italic;color:var(--text0);margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid var(--border)}\n.loading{padding:40px;text-align:center;color:var(--text2);font-size:12px}\n.loading::after{content:\'...\';animation:dots 1.5s infinite}\n@keyframes dots{0%{content:\'\'}33%{content:\'.\'}66%{content:\'..\'}100%{content:\'...\'}}\n@keyframes fiu{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}\n.fi{animation:fiu .3s ease both}\n\n/* ══════════════════════════════════════════ NO STUDY */\n.no-study{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;color:var(--text2)}\n.no-study-icon{font-size:48px;margin-bottom:16px;opacity:0.2}\n.no-study-text{font-family:var(--font-h);font-size:20px;font-style:italic;margin-bottom:8px;opacity:0.4}\n.no-study-sub{font-size:12px;opacity:0.3}\n\n/* Notifications */\n.notif{\n  position:fixed;bottom:24px;right:24px;z-index:9999;\n  background:var(--bg2);border:1px solid var(--border2);border-radius:10px;\n  padding:14px 18px;box-shadow:var(--shadow2);font-size:12px;color:var(--text0);\n  animation:notif-in .3s ease both;max-width:320px;\n}\n.notif.ok{border-color:var(--ok);background:rgba(0,145,77,0.1)}\n.notif.err{border-color:var(--urgent);background:rgba(232,0,30,0.1)}\n@keyframes notif-in{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}\n.ai-impression-panel{background:rgba(0,20,40,0.95);border:1px solid rgba(0,212,170,0.4);border-radius:10px;padding:16px;margin-bottom:10px;position:relative;min-height:120px;box-shadow:0 0 20px rgba(0,212,170,0.15)}\n.ai-impression-panel::before{content:"◈ AI IMPRESSION";position:absolute;top:-10px;left:12px;background:var(--bg0);padding:0 8px;font-size:9px;font-weight:900;letter-spacing:0.2em;color:#00d4aa}\n.ai-impression-text{font-family:"Courier New",monospace;font-size:13px;line-height:1.7;color:#e0fff8;white-space:pre-wrap;min-height:80px}\n.ai-impression-text.empty{color:rgba(0,212,170,0.3);font-style:italic}\n.ai-impression-meta{display:flex;align-items:center;gap:8px;margin-top:10px;padding-top:8px;border-top:1px solid rgba(0,212,170,0.2)}\n.ai-impression-badge{background:rgba(0,212,170,0.12);border:1px solid rgba(0,212,170,0.3);color:#00d4aa;padding:2px 8px;border-radius:20px;font-size:9px;font-weight:700;letter-spacing:0.1em}\n.ai-speak-btn{background:rgba(0,212,170,0.1);border:1px solid rgba(0,212,170,0.3);color:#00d4aa;padding:3px 10px;border-radius:20px;font-size:9px;font-weight:700;cursor:pointer}\n\n/* ══════════════════════════════════════════ REPORTS */\n.reports-wrap{display:grid;grid-template-columns:340px 1fr;height:100%;overflow:hidden}\n.reports-list{background:var(--bg1);border-right:1px solid var(--border);overflow-y:auto;display:flex;flex-direction:column}\n.reports-list-header{padding:14px 16px;border-bottom:1px solid var(--border);flex-shrink:0}\n.reports-list-title{font-family:var(--font-h);font-size:20px;font-style:italic;color:var(--text0)}\n.reports-list-sub{font-size:10px;color:var(--text2);letter-spacing:0.06em;margin-top:2px}\n.report-card{padding:14px 16px;border-bottom:1px solid var(--border);cursor:pointer;transition:background .15s;position:relative}\n.report-card:hover{background:var(--bg-hover)}\n.report-card.active{background:var(--bg-active);border-left:3px solid var(--accent)}\n.rc-patient{font-size:13px;font-weight:700;color:var(--text0);margin-bottom:3px}\n.rc-meta{font-size:10px;color:var(--text2);font-family:var(--font-m);margin-bottom:4px}\n.rc-impression{font-size:10px;color:var(--text1);line-height:1.5;overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical}\n.rc-badges{display:flex;gap:6px;margin-top:6px;flex-wrap:wrap}\n.report-detail{background:var(--bg0);overflow-y:auto;padding:0}\n.rd-header{background:var(--bg1);padding:20px 28px;border-bottom:1px solid var(--border);position:sticky;top:0;z-index:10}\n.rd-patient-name{font-family:var(--font-h);font-size:28px;font-style:italic;color:var(--text0);margin-bottom:4px}\n.rd-meta-row{display:flex;gap:20px;flex-wrap:wrap;margin-bottom:12px}\n.rd-meta-field{display:flex;flex-direction:column;gap:1px}\n.rd-meta-label{font-size:8px;color:var(--text2);letter-spacing:0.1em;text-transform:uppercase}\n.rd-meta-value{font-size:12px;color:var(--text0);font-family:var(--font-m);font-weight:600}\n.rd-signed-banner{display:flex;align-items:center;gap:10px;background:rgba(0,145,77,0.1);border:1px solid rgba(0,145,77,0.3);border-radius:8px;padding:10px 16px}\n.rd-signed-icon{font-size:20px}\n.rd-signed-text{font-size:11px;color:var(--ok);font-weight:700;letter-spacing:0.06em}\n.rd-signed-sub{font-size:10px;color:var(--text2);margin-top:1px}\n.rd-body{padding:24px 28px}\n.rd-section{margin-bottom:24px}\n.rd-section-label{font-size:9px;font-weight:900;letter-spacing:0.2em;color:var(--text2);text-transform:uppercase;margin-bottom:8px;padding-bottom:6px;border-bottom:1px solid var(--border)}\n.rd-section-text{font-family:var(--font-m);font-size:12px;color:var(--text1);line-height:1.8;white-space:pre-wrap}\n.rd-ai-section{background:rgba(0,20,40,0.8);border:1px solid rgba(0,212,170,0.35);border-radius:10px;padding:18px;margin-bottom:24px;position:relative}\n.rd-ai-section::before{content:"◈ AI ASSISTED IMPRESSION";position:absolute;top:-10px;left:14px;background:var(--bg0);padding:0 8px;font-size:9px;font-weight:900;letter-spacing:0.2em;color:#00d4aa}\n.rd-ai-text{font-family:\'Courier New\',monospace;font-size:13px;line-height:1.9;color:#e0fff8}\n.rd-ai-footer{display:flex;align-items:center;gap:8px;margin-top:12px;padding-top:10px;border-top:1px solid rgba(0,212,170,0.2)}\n.rd-print-btn{background:var(--nhs2);color:white;padding:10px 20px;border-radius:8px;font-size:11px;font-weight:700;letter-spacing:0.08em;transition:all .2s;border:none}\n.rd-print-btn:hover{background:#003f9e}\n.rd-speak-btn{background:rgba(0,212,170,0.1);border:1px solid rgba(0,212,170,0.3);color:#00d4aa;padding:10px 16px;border-radius:8px;font-size:11px;font-weight:700;cursor:pointer}\n.no-reports{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;color:var(--text2)}\n</style>\n</head>\n<body>\n<div id="root"></div>\n<script type="text/babel">\nconst {useState,useEffect,useRef,useCallback} = React;\nconst API = \'\';\n\n// ─── UTILITIES ────────────────────────────────────────────────────\nconst age = dob => { const b=new Date(dob),n=new Date(); return Math.floor((n-b)/31557600000); };\nconst fmt = d => d ? new Date(d).toLocaleDateString(\'en-GB\',{day:\'2-digit\',month:\'short\',year:\'numeric\',hour:\'2-digit\',minute:\'2-digit\'}) : \'—\';\nconst fmtDate = d => d ? new Date(d).toLocaleDateString(\'en-GB\',{day:\'2-digit\',month:\'short\',year:\'numeric\'}) : \'—\';\n\n// ─── ARIA AVATAR (cute friendly lion) ────────────────────────────\nfunction AriaFace({state}) {\n  const [blink,setBlink] = React.useState(false);\n  const [mouthOpen,setMouthOpen] = React.useState(0);\n  const [headTilt,setHeadTilt] = React.useState(0);\n\n  React.useEffect(()=>{\n    const bi = setInterval(()=>{\n      setBlink(true);\n      setTimeout(()=>setBlink(false), 110);\n    }, 3000+Math.random()*2000);\n    return ()=>clearInterval(bi);\n  },[]);\n\n  React.useEffect(()=>{\n    let iv;\n    if(state===\'speaking\'){\n      const pattern=[0.7,0.2,0.9,0.1,0.6,0.3,0.8,0.05,0.5,0.7,0.15,0.95,0.1,0.6];\n      let p=0;\n      iv=setInterval(()=>{ p++; setMouthOpen(pattern[p%pattern.length]*0.8); setHeadTilt((Math.random()-0.5)*2); },100);\n    } else if(state===\'listening\'){\n      iv=setInterval(()=>{ setHeadTilt((Math.random()-0.5)*1.5); },350);\n      setMouthOpen(0.08);\n    } else if(state===\'thinking\'){\n      iv=setInterval(()=>{ setHeadTilt((Math.random()-0.5)*1); },500);\n    } else { setMouthOpen(0); setHeadTilt(0); }\n    return ()=>clearInterval(iv);\n  },[state]);\n\n  const eyeH = blink ? 1 : 6;\n  const mouthY = 72;\n  const mouthD = mouthOpen * 10;\n\n  return (\n    <svg className="aria-face-svg" viewBox="0 0 100 120" xmlns="http://www.w3.org/2000/svg"\n         style={{transform:`rotate(${headTilt}deg)`,transition:\'transform 0.12s ease\'}}>\n      <defs>\n        <radialGradient id="mane" cx="50%" cy="50%" r="50%">\n          <stop offset="0%" stopColor="#e8a020"/>\n          <stop offset="60%" stopColor="#c07010"/>\n          <stop offset="100%" stopColor="#8a4a00"/>\n        </radialGradient>\n        <radialGradient id="face" cx="50%" cy="40%" r="55%">\n          <stop offset="0%" stopColor="#ffd080"/>\n          <stop offset="70%" stopColor="#f0a840"/>\n          <stop offset="100%" stopColor="#d08020"/>\n        </radialGradient>\n        <radialGradient id="muzzle" cx="50%" cy="40%" r="55%">\n          <stop offset="0%" stopColor="#fff0d0"/>\n          <stop offset="100%" stopColor="#f8d890"/>\n        </radialGradient>\n        <radialGradient id="nose" cx="50%" cy="35%" r="55%">\n          <stop offset="0%" stopColor="#e06080"/>\n          <stop offset="100%" stopColor="#b03050"/>\n        </radialGradient>\n        <linearGradient id="uniform2" x1="0" y1="0" x2="0" y2="1">\n          <stop offset="0%" stopColor="#003e9e"/>\n          <stop offset="100%" stopColor="#001555"/>\n        </linearGradient>\n        <filter id="fs"><feGaussianBlur stdDeviation="0.6"/></filter>\n        <filter id="fm"><feGaussianBlur stdDeviation="1.2"/></filter>\n      </defs>\n\n      {/* NHS Uniform */}\n      <path d="M10 120 Q25 105 50 110 Q75 105 90 120 L100 120 L0 120 Z" fill="url(#uniform2)"/>\n      <path d="M44 110 L50 117 L56 110 Q53 112 50 113 Q47 112 44 110Z" fill="white" opacity="0.85"/>\n\n      {/* Mane - big fluffy circle */}\n      <circle cx="50" cy="54" r="36" fill="url(#mane)"/>\n      {/* Mane texture - overlapping petals */}\n      {Array.from({length:12}).map((_,i)=>{\n        const angle = (i/12)*Math.PI*2;\n        const x = 50 + Math.cos(angle)*30;\n        const y = 54 + Math.sin(angle)*30;\n        return <ellipse key={i} cx={x} cy={y} rx="10" ry="7"\n          fill="#c07010" opacity="0.5"\n          transform={`rotate(${i*30} ${x} ${y})`}/>;\n      })}\n      {/* Mane highlight */}\n      <circle cx="50" cy="54" r="36" fill="none" stroke="#f0c050" strokeWidth="1" opacity="0.2"/>\n\n      {/* Face */}\n      <circle cx="50" cy="54" r="26" fill="url(#face)"/>\n\n      {/* Ears */}\n      <ellipse cx="26" cy="28" rx="9" ry="10" fill="url(#mane)"/>\n      <ellipse cx="26" cy="28" rx="5" ry="6" fill="#f0a840"/>\n      <ellipse cx="74" cy="28" rx="9" ry="10" fill="url(#mane)"/>\n      <ellipse cx="74" cy="28" rx="5" ry="6" fill="#f0a840"/>\n\n      {/* Eyebrows - expressive */}\n      <path d="M32 42 Q38 38 44 40" stroke="#8a4a00" strokeWidth="2" fill="none" strokeLinecap="round"/>\n      <path d="M56 40 Q62 38 68 42" stroke="#8a4a00" strokeWidth="2" fill="none" strokeLinecap="round"/>\n\n      {/* Eyes whites */}\n      <ellipse cx="38" cy="50" rx="8" ry={eyeH} fill="white"/>\n      <ellipse cx="62" cy="50" rx="8" ry={eyeH} fill="white"/>\n\n      {!blink && <>\n        {/* Iris - warm amber */}\n        <ellipse cx="38" cy="50" rx="5.5" ry="5.5" fill="#c07820"/>\n        <ellipse cx="62" cy="50" rx="5.5" ry="5.5" fill="#c07820"/>\n        {/* Inner iris */}\n        <ellipse cx="38" cy="50" rx="4" ry="4" fill="#a05810"/>\n        <ellipse cx="62" cy="50" rx="4" ry="4" fill="#a05810"/>\n        {/* Pupils */}\n        <ellipse cx="38" cy="50" rx="2.8" ry="2.8" fill="#0a0808"/>\n        <ellipse cx="62" cy="50" rx="2.8" ry="2.8" fill="#0a0808"/>\n        {/* Catchlights */}\n        <ellipse cx="36" cy="48" rx="1.5" ry="1.3" fill="white" opacity="0.95"/>\n        <ellipse cx="60" cy="48" rx="1.5" ry="1.3" fill="white" opacity="0.95"/>\n        <ellipse cx="40" cy="52" rx="0.8" ry="0.7" fill="white" opacity="0.4"/>\n        <ellipse cx="64" cy="52" rx="0.8" ry="0.7" fill="white" opacity="0.4"/>\n      </>}\n\n      {/* Muzzle */}\n      <ellipse cx="50" cy="68" rx="16" ry="12" fill="url(#muzzle)"/>\n\n      {/* Nose */}\n      <ellipse cx="50" cy="62" rx="6" ry="4" fill="url(#nose)"/>\n      <ellipse cx="48.5" cy="61" rx="1.5" ry="1" fill="white" opacity="0.5"/>\n\n      {/* Whiskers */}\n      <line x1="20" y1="65" x2="34" y2="67" stroke="#8a6020" strokeWidth="0.8" opacity="0.6"/>\n      <line x1="20" y1="69" x2="34" y2="69" stroke="#8a6020" strokeWidth="0.8" opacity="0.6"/>\n      <line x1="20" y1="73" x2="34" y2="71" stroke="#8a6020" strokeWidth="0.8" opacity="0.6"/>\n      <line x1="80" y1="65" x2="66" y2="67" stroke="#8a6020" strokeWidth="0.8" opacity="0.6"/>\n      <line x1="80" y1="69" x2="66" y2="69" stroke="#8a6020" strokeWidth="0.8" opacity="0.6"/>\n      <line x1="80" y1="73" x2="66" y2="71" stroke="#8a6020" strokeWidth="0.8" opacity="0.6"/>\n\n      {/* Mouth */}\n      <path d={`M44 ${mouthY} Q50 ${mouthY+mouthD+3} 56 ${mouthY}`} stroke="#8a3020" strokeWidth="1.5" fill="none" strokeLinecap="round"/>\n      <path d="M50 66 L50 72" stroke="#8a3020" strokeWidth="1" strokeLinecap="round"/>\n      {mouthOpen > 0.08 && <>\n        <ellipse cx="50" cy={mouthY+mouthD*0.4+1} rx="9" ry={mouthD*0.5+1} fill="#3a0808"/>\n        <rect x="44" y={mouthY+0.5} width="12" height={Math.min(mouthD*0.35,4)} rx="1" fill="white" opacity="0.9"/>\n      </>}\n\n      {/* Cheek spots */}\n      <ellipse cx="30" cy="62" rx="5" ry="3.5" fill="#e08030" opacity="0.18" filter="url(#fm)"/>\n      <ellipse cx="70" cy="62" rx="5" ry="3.5" fill="#e08030" opacity="0.18" filter="url(#fm)"/>\n\n      {/* State rings */}\n      {state===\'speaking\' && <>\n        <circle cx="50" cy="54" r="38" fill="none" stroke="#00d4aa" strokeWidth="1.5" opacity="0.25" strokeDasharray="3 5">\n          <animateTransform attributeName="transform" type="rotate" from="0 50 54" to="360 50 54" dur="4s" repeatCount="indefinite"/>\n        </circle>\n      </>}\n      {state===\'listening\' && <circle cx="50" cy="54" r="38" fill="none" stroke="#e8001e" strokeWidth="1.5" opacity="0.25">\n        <animate attributeName="r" values="38;42;38" dur="0.9s" repeatCount="indefinite"/>\n        <animate attributeName="opacity" values="0.25;0.06;0.25" dur="0.9s" repeatCount="indefinite"/>\n      </circle>}\n      {state===\'thinking\' && <>\n        <circle cx="50" cy="54" r="38" fill="none" stroke="#b090ff" strokeWidth="1" opacity="0.2" strokeDasharray="6 4">\n          <animateTransform attributeName="transform" type="rotate" from="0 50 54" to="360 50 54" dur="3s" repeatCount="indefinite"/>\n        </circle>\n        {[0,1,2].map(i=>(\n          <circle key={i} cx={44+i*6} cy="14" r="2.2" fill="#b090ff" opacity="0.6">\n            <animate attributeName="cy" values="14;9;14" dur="1s" begin={`${i*0.22}s`} repeatCount="indefinite"/>\n            <animate attributeName="opacity" values="0.3;0.9;0.3" dur="1s" begin={`${i*0.22}s`} repeatCount="indefinite"/>\n          </circle>\n        ))}\n      </>}\n    </svg>\n  );\n}\n\n// ─── DICOM VIEWER (modality-specific SVG anatomy) ─────────────────\nfunction DicomViewer({study, series, selectedSeries}) {\n  const mod = study?.modality || \'CT\';\n  const body = study?.body_part || \'Chest\';\n\n  const AnatomySVG = () => {\n    if (mod===\'CT\' && (body===\'Head\' || body===\'Brain\')) return (\n      <svg className="anatomy-svg" viewBox="0 0 520 520" xmlns="http://www.w3.org/2000/svg">\n        <defs><radialGradient id="ctbrain" cx="50%" cy="50%" r="50%"><stop offset="0%" stopColor="#444"/><stop offset="70%" stopColor="#222"/><stop offset="100%" stopColor="#000"/></radialGradient></defs>\n        <rect width="520" height="520" fill="#0a0a0a"/>\n        <ellipse cx="260" cy="250" rx="180" ry="200" fill="#222" stroke="#555" strokeWidth="3"/>\n        <ellipse cx="260" cy="250" rx="160" ry="180" fill="#333" stroke="#444" strokeWidth="1.5"/>\n        <path d="M260 80 Q280 150 260 250 Q240 150 260 80" fill="#3a3a3a" stroke="#555" strokeWidth="1"/>\n        <path d="M100 250 Q180 230 260 250 Q180 270 100 250" fill="none" stroke="#555" strokeWidth="1"/>\n        <path d="M260 250 Q340 230 420 250 Q340 270 260 250" fill="none" stroke="#555" strokeWidth="1"/>\n        <ellipse cx="200" cy="230" rx="25" ry="20" fill="#2a2a2a" stroke="#666" strokeWidth="1" opacity="0.8"/>\n        <ellipse cx="320" cy="230" rx="25" ry="20" fill="#2a2a2a" stroke="#666" strokeWidth="1" opacity="0.8"/>\n        <ellipse cx="260" cy="300" rx="40" ry="30" fill="#1a1a1a" stroke="#444" strokeWidth="1.5"/>\n        <ellipse cx="260" cy="200" rx="20" ry="15" fill="#333" stroke="#555" strokeWidth="1"/>\n        <path d="M200 120 Q230 110 260 108 Q290 110 320 120" fill="none" stroke="#444" strokeWidth="2" opacity="0.5"/>\n      </svg>\n    );\n    if (mod===\'CT\' && body===\'Chest\') return (\n      <svg className="anatomy-svg" viewBox="0 0 520 520" xmlns="http://www.w3.org/2000/svg">\n        <rect width="520" height="520" fill="#080808"/>\n        {/* Ribs */}\n        {[0,1,2,3,4,5,6,7].map(i=><ellipse key={i} cx="260" cy={160+i*22} rx={120-i*6} ry="10" fill="none" stroke="#888" strokeWidth="2" opacity="0.6"/>)}\n        {/* Lung fields */}\n        <ellipse cx="185" cy="270" rx="80" ry="110" fill="#1a1a2a" stroke="#445" strokeWidth="1" opacity="0.7"/>\n        <ellipse cx="335" cy="270" rx="80" ry="110" fill="#1a1a2a" stroke="#445" strokeWidth="1" opacity="0.7"/>\n        {/* Lung markings */}\n        {[0,1,2,3].map(i=><path key={i} d={`M185 ${180+i*30} Q${160+i*8} ${200+i*30} ${185} ${220+i*30}`} fill="none" stroke="#334" strokeWidth="1"/>)}\n        {/* Mediastinum */}\n        <rect x="230" y="150" width="60" height="160" fill="#222" stroke="#555" strokeWidth="1" rx="10"/>\n        {/* Heart */}\n        <ellipse cx="248" cy="310" rx="50" ry="60" fill="#2a1a1a" stroke="#664" strokeWidth="2"/>\n        {/* Spine */}\n        <rect x="245" y="140" width="30" height="220" fill="#666" stroke="#888" strokeWidth="1" rx="4" opacity="0.4"/>\n        {[0,1,2,3,4,5,6,7,8,9].map(i=><rect key={i} x="243" y={148+i*22} width="34" height="16" fill="#555" stroke="#777" strokeWidth="1" rx="2"/>)}\n      </svg>\n    );\n    if (mod===\'MRI\') return (\n      <svg className="anatomy-svg" viewBox="0 0 520 520" xmlns="http://www.w3.org/2000/svg">\n        <rect width="520" height="520" fill="#050510"/>\n        <ellipse cx="260" cy="260" rx="195" ry="210" fill="#0a0a20" stroke="#334" strokeWidth="2"/>\n        <ellipse cx="260" cy="260" rx="170" ry="185" fill="#12122a" stroke="#446" strokeWidth="1.5"/>\n        {/* White matter bands */}\n        {[0,1,2,3,4].map(i=><ellipse key={i} cx="260" cy="250" rx={80+i*22} ry={80+i*20} fill="none" stroke={`rgba(100,120,220,${0.15-i*0.02})`} strokeWidth={4-i*0.5}/>)}\n        <path d="M260 80 L260 430" stroke="rgba(150,160,255,0.2)" strokeWidth="2"/>\n        <path d="M90 260 L430 260" stroke="rgba(150,160,255,0.2)" strokeWidth="2"/>\n        <ellipse cx="210" cy="240" rx="35" ry="30" fill="#1a1a3a" stroke="#558" strokeWidth="1"/>\n        <ellipse cx="310" cy="240" rx="35" ry="30" fill="#1a1a3a" stroke="#558" strokeWidth="1"/>\n        <ellipse cx="260" cy="310" rx="55" ry="40" fill="#0e0e28" stroke="#446" strokeWidth="2"/>\n        <ellipse cx="260" cy="200" rx="28" ry="22" fill="#181838" stroke="#557" strokeWidth="1"/>\n      </svg>\n    );\n    if (mod===\'XR\') return (\n      <svg className="anatomy-svg" viewBox="0 0 520 520" xmlns="http://www.w3.org/2000/svg">\n        <rect width="520" height="520" fill="#050505"/>\n        {/* Chest X-ray style */}\n        <ellipse cx="185" cy="250" rx="100" ry="130" fill="#e8e8e8" opacity="0.08" stroke="#aaa" strokeWidth="1"/>\n        <ellipse cx="335" cy="250" rx="100" ry="130" fill="#e8e8e8" opacity="0.08" stroke="#aaa" strokeWidth="1"/>\n        {/* Lung markings */}\n        {[0,1,2,3,4,5,6].map(i=><line key={i} x1="130" y1={160+i*25} x2={230-i*5} y2={145+i*25} stroke="#999" strokeWidth="0.5" opacity="0.5"/>)}\n        {[0,1,2,3,4,5,6].map(i=><line key={i} x1="390" y1={160+i*25} x2={290+i*5} y2={145+i*25} stroke="#999" strokeWidth="0.5" opacity="0.5"/>)}\n        {/* Ribs */}\n        {[0,1,2,3,4,5].map(i=><path key={i} d={`M ${110+i*10} ${140+i*25} Q 200 ${115+i*20} 260 ${125+i*22} Q 320 ${115+i*20} ${410-i*10} ${140+i*25}`} fill="none" stroke="#ddd" strokeWidth="1.5" opacity={0.5-i*0.06}/>)}\n        {/* Heart */}\n        <ellipse cx="245" cy="310" rx="65" ry="75" fill="#ccc" opacity="0.12" stroke="#bbb" strokeWidth="1.5"/>\n        {/* Trachea */}\n        <rect x="252" y="80" width="16" height="100" fill="#ccc" opacity="0.15" rx="8"/>\n        {/* Spine */}\n        {[0,1,2,3,4,5,6,7,8,9,10].map(i=><rect key={i} x="250" y={100+i*30} width="20" height="24" fill="#eee" opacity="0.25" rx="2"/>)}\n        {/* Hila */}\n        <ellipse cx="210" cy="230" rx="18" ry="25" fill="#ccc" opacity="0.2" stroke="#999" strokeWidth="1"/>\n        <ellipse cx="310" cy="230" rx="18" ry="25" fill="#ccc" opacity="0.2" stroke="#999" strokeWidth="1"/>\n        {/* Costophrenic angles */}\n        <path d="M90 380 Q130 390 185 385" fill="none" stroke="#aaa" strokeWidth="2"/>\n        <path d="M430 380 Q390 390 335 385" fill="none" stroke="#aaa" strokeWidth="2"/>\n      </svg>\n    );\n    if (mod===\'US\') return (\n      <svg className="anatomy-svg" viewBox="0 0 520 520" xmlns="http://www.w3.org/2000/svg">\n        <rect width="520" height="520" fill="#020810"/>\n        {/* Ultrasound sector shape */}\n        <path d="M260 60 L80 440 Q260 480 440 440 Z" fill="#0a1020" stroke="#1a2840" strokeWidth="2"/>\n        {/* Ultrasound lines */}\n        {[0,1,2,3,4,5,6,7,8,9,10,11,12].map(i=>{const a=-50+i*8; const r=a*Math.PI/180; return <line key={i} x1="260" y1="60" x2={260+380*Math.sin(r)} y2={60+380*Math.cos(r)} stroke="rgba(0,150,255,0.05)" strokeWidth="1"/>;})}\n        {/* Depth markers */}\n        {[1,2,3,4,5].map(i=><text key={i} x="90" y={100+i*70} fill="rgba(255,255,0,0.4)" fontSize="9" fontFamily="monospace">{i}cm</text>)}\n        {/* Liver parenchyma */}\n        <ellipse cx="260" cy="280" rx="130" ry="90" fill="#1e2c3a" stroke="#2a4060" strokeWidth="1.5" opacity="0.8"/>\n        {/* Kidney */}\n        <ellipse cx="360" cy="300" rx="30" ry="45" fill="#162030" stroke="#2a3a50" strokeWidth="1.5" opacity="0.7"/>\n        <ellipse cx="360" cy="300" rx="15" ry="28" fill="#0e1828" stroke="#1a2a40" strokeWidth="1"/>\n        {/* Portal vein */}\n        <path d="M180 260 Q260 250 340 260" fill="none" stroke="#005580" strokeWidth="4" opacity="0.6"/>\n        {/* Speckle */}\n        {Array.from({length:80}).map((_,i)=><circle key={i} cx={120+Math.random()*280} cy={120+Math.random()*280} r="0.8" fill="rgba(200,220,255,0.15)"/>)}\n      </svg>\n    );\n    // NM / default\n    return (\n      <svg className="anatomy-svg" viewBox="0 0 520 520" xmlns="http://www.w3.org/2000/svg">\n        <rect width="520" height="520" fill="#050008"/>\n        <ellipse cx="260" cy="260" rx="180" ry="200" fill="#0a0015" stroke="#2a1040" strokeWidth="2"/>\n        {/* Hotspots */}\n        {[[180,200,25],[340,200,20],[260,300,35],[200,350,15],[320,350,15],[260,420,20]].map(([x,y,r],i)=>(\n          <g key={i}><ellipse cx={x} cy={y} rx={r} ry={r*0.8} fill={`rgba(255,100,50,${0.3+Math.random()*0.3})`}/>\n          <ellipse cx={x} cy={y} rx={r*0.5} ry={r*0.4} fill={`rgba(255,200,50,${0.5+Math.random()*0.3})`}/></g>\n        ))}\n        <text x="16" y="30" fill="rgba(255,255,0,0.5)" fontSize="10" fontFamily="monospace">NM SCAN</text>\n      </svg>\n    );\n  };\n\n  return (\n    <div className={`dicom-img dicom-${mod.toLowerCase()}`}>\n      <AnatomySVG/>\n      <div className="dicom-overlay-tl">\n        <div>{study?.last_name?.toUpperCase()}, {study?.first_name}</div>\n        <div>{study?.mrn}</div>\n        <div>{study?.dob ? fmtDate(study?.dob) : \'\'} {study?.sex}</div>\n      </div>\n      <div className="dicom-overlay-tr">\n        <div>{study?.modality}</div>\n        <div>{fmtDate(study?.acquisition_time)}</div>\n        <div>ACC: {study?.accession}</div>\n      </div>\n      <div className="dicom-overlay-bl">\n        <div>SER: {selectedSeries?.series_number || 1}/{series?.length || 1}</div>\n        <div>{selectedSeries?.series_description || \'Axial\'}</div>\n      </div>\n      <div className="dicom-overlay-br">\n        <div>W: 400 L: 40</div>\n        <div>KCH RADIOLOGY</div>\n      </div>\n    </div>\n  );\n}\n\n// ─── NOTIFICATION ─────────────────────────────────────────────────\nfunction Notif({msg,type,onClose}) {\n  useEffect(()=>{ const t=setTimeout(onClose,3500); return()=>clearTimeout(t); },[]);\n  return <div className={`notif ${type}`}>{msg}</div>;\n}\n\n// ─── MAIN APP ─────────────────────────────────────────────────────\nfunction App() {\n  const [theme,setTheme] = useState(\'dark\');\n  const [session,setSession] = useState(null);\n  const [loginUser,setLoginUser] = useState(\'\');\n  const [loginPass,setLoginPass] = useState(\'\');\n  const [loginErr,setLoginErr] = useState(\'\');\n  const [loginLoading,setLoginLoading] = useState(false);\n  const [nav,setNav] = useState(\'worklist\');\n  const [studies,setStudies] = useState([]);\n  const [stats,setStats] = useState(null);\n  const [selectedStudy,setSelectedStudy] = useState(null);\n  const [studyDetail,setStudyDetail] = useState(null);\n  const [selectedSeries,setSelectedSeries] = useState(null);\n  const [filter,setFilter] = useState({mod:\'\',status:\'\',priority:\'\',search:\'\'});\n  const [report,setReport] = useState({indication:\'\',technique:\'\',findings:\'\',impression:\'\',sign_status:\'Draft\'});\n  const [ariaState,setAriaState] = useState(\'idle\');\n  const [ariaMessages,setAriaMessages] = useState([]);\n  const [ariaInput,setAriaInput] = useState(\'\');\n  const [ariaCaptions,setAriaCaptions] = useState("Ready. Select a study or ask me anything.");\n  const [ariaVoice,setAriaVoice] = useState(\'nova\');\n  const [ariaMuted,setAriaMuted] = useState(false);\n  const [isRecording,setIsRecording] = useState(false);\n  const [dictating,setDictating] = useState(null);\n  const [genParams,setGenParams] = useState({patients:50,studies_per_patient:3,critical_pct:15});\n  const [genResult,setGenResult] = useState(null);\n  const [genLoading,setGenLoading] = useState(false);\n  const [importResult,setImportResult] = useState(\'\');\n  const [notif,setNotif] = useState(null);\n  const [reports,setReports] = useState([]);\n  const [selectedReport,setSelectedReport] = useState(null);\n  const [viewerTool,setViewerTool] = useState(\'pan\');\n  const fileRef = useRef();\n  const captionsRef = useRef();\n\n  useEffect(()=>{ document.documentElement.setAttribute(\'data-theme\',theme); },[theme]);\n\n  const notify = (msg,type=\'ok\') => { setNotif({msg,type}); };\n  const tok = session?.token;\n\n  // Login\n  const handleLogin = async e => {\n    e.preventDefault();\n    setLoginLoading(true); setLoginErr(\'\');\n    try {\n      const r = await fetch(`${API}/auth/login`,{method:\'POST\',headers:{\'Content-Type\':\'application/json\'},body:JSON.stringify({username:loginUser,password:loginPass})});\n      if (!r.ok) throw new Error(\'Invalid username or password\');\n      const d = await r.json();\n      setSession(d);\n      await ariaSpeak(`Welcome to ARIA, ${d.username}. Your radiology workbench is ready.`);\n    } catch(e){ setLoginErr(e.message); }\n    setLoginLoading(false);\n  };\n\n  const handleLogout = () => { setSession(null); setStudies([]); setStats(null); setSelectedStudy(null); setStudyDetail(null); };\n\n  // Load worklist\n  const loadWorklist = useCallback(async () => {\n    if (!tok) return;\n    try {\n      const params = new URLSearchParams({token:tok,...filter});\n      const r = await fetch(`${API}/api/worklist?${params}`);\n      const d = await r.json();\n      setStudies(d.studies || []); if(d.studies&&d.studies[0]) console.log("critical_flag type:", typeof d.studies[0].critical_flag, "value:", d.studies[0].critical_flag);\n    } catch(e){ console.error(e); }\n  },[tok,filter]);\n\n  const loadStats = useCallback(async () => {\n    if (!tok) return;\n    try {\n      const r = await fetch(`${API}/api/stats?token=${tok}`);\n      const d = await r.json();\n      setStats(d);\n    } catch{}\n  },[tok]);\n\n  const loadReports = useCallback(async () => {\n    if (!tok) return;\n    try {\n      const r = await fetch(`${API}/api/reports?token=${tok}`);\n      const d = await r.json();\n      setReports(d.reports || []);\n    } catch{}\n  },[tok]);\n\n  useEffect(()=>{ if(tok){ loadWorklist(); loadStats(); loadReports(); } },[tok,filter]);\n\n  // Auto-scroll captions to keep highlighted word visible\n  useEffect(()=>{\n    if(captionsRef.current){\n      const highlighted = captionsRef.current.querySelector(\'span[style*="00d4aa"]\');\n      if(highlighted) highlighted.scrollIntoView({block:\'nearest\',behavior:\'smooth\'});\n    }\n  },[ariaCaptions]);\n\n  // Load study detail\n  const openStudy = async s => {\n    setSelectedStudy(s);\n    setNav(\'viewer\');\n    try {\n      const r = await fetch(`${API}/api/study/${s.study_id}?token=${tok}`);\n      const d = await r.json();\n      setStudyDetail(d);\n      setSelectedSeries(d.series?.[0]||null);\n      if(d.report){ setReport({indication:d.report.indication||\'\',technique:d.report.technique||\'\',findings:d.report.findings||\'\',impression:d.report.impression||\'\',sign_status:d.report.sign_status||\'Draft\'}); }\n      else { setReport({indication:s.indication||\'\',technique:`${s.modality} ${s.body_part}`,findings:\'\',impression:\'\',sign_status:\'Draft\'}); }\n      if(s.critical_flag){ ariaSpeak(`Critical study loaded. ${s.description}. Immediate review required.`); }\n      else { ariaSpeak(`Study loaded: ${s.description} for ${s.first_name} ${s.last_name}.`); }\n    } catch(e){ console.error(e); }\n  };\n\n  // ARIA speak\n    // ── MICROPHONE — Web Speech API (live transcription) ─────────\n  const recognitionRef = React.useRef(null);\n  const mediaRecorderRef = React.useRef(null);\n  const audioChunksRef = React.useRef([]);\n  const liveTextRef = React.useRef(\'\');\n\n  const startRecording = async () => {\n    liveTextRef.current = \'\';\n\n    // Try Web Speech API first (live transcription in browser)\n    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;\n    if(SpeechRecognition) {\n      const recognition = new SpeechRecognition();\n      recognition.continuous = true;\n      recognition.interimResults = true;\n      recognition.lang = \'en-GB\';\n      recognitionRef.current = recognition;\n\n      recognition.onstart = () => {\n        setIsRecording(true);\n        setAriaState(\'listening\');\n        setAriaCaptions(\'🎙 Listening — speak now...\');\n      };\n\n      recognition.onresult = (event) => {\n        let interim = \'\';\n        let final = \'\';\n        for(let i = event.resultIndex; i < event.results.length; i++) {\n          const t = event.results[i][0].transcript;\n          if(event.results[i].isFinal) { final += t; }\n          else { interim += t; }\n        }\n        if(final) liveTextRef.current += final;\n        const display = liveTextRef.current + (interim ? \' \' + interim : \'\');\n        setAriaCaptions(\'🎙 \' + display);\n      };\n\n      recognition.onerror = (e) => {\n        setAriaCaptions(\'Mic error: \' + e.error + \' — try typing instead\');\n        setAriaState(\'idle\');\n        setIsRecording(false);\n      };\n\n      recognition.onend = () => {\n        setIsRecording(false);\n        const text = liveTextRef.current.trim();\n        if(text) {\n          setAriaCaptions(\'You said: "\' + text + \'"\');\n          ariaQuery(text);\n        } else {\n          setAriaCaptions(\'Nothing heard — tap TAP TO TALK and try again\');\n          setAriaState(\'idle\');\n        }\n      };\n\n      recognition.start();\n      return;\n    }\n\n    // Fallback: MediaRecorder + Whisper\n    try {\n      const stream = await navigator.mediaDevices.getUserMedia({audio:true});\n      audioChunksRef.current = [];\n      const mimeType = MediaRecorder.isTypeSupported(\'audio/webm\') ? \'audio/webm\' : \'audio/ogg\';\n      const recorder = new MediaRecorder(stream, {mimeType});\n      mediaRecorderRef.current = recorder;\n      recorder.ondataavailable = e => { if(e.data.size>0) audioChunksRef.current.push(e.data); };\n      recorder.onstop = async () => {\n        stream.getTracks().forEach(t=>t.stop());\n        setAriaState(\'thinking\');\n        setAriaCaptions(\'Transcribing via Whisper...\');\n        const blob = new Blob(audioChunksRef.current, {type:mimeType});\n        const fd = new FormData();\n        fd.append(\'audio\', blob, \'recording.webm\');\n        try {\n          const r = await fetch(`${API}/api/aria/transcribe?token=${tok}`, {method:\'POST\', body:fd});\n          const d = await r.json();\n          const text = d.text?.trim();\n          if(text) { setAriaCaptions(\'You said: "\' + text + \'"\'); await ariaQuery(text); }\n          else { setAriaCaptions(\'Nothing heard — try again\'); setAriaState(\'idle\'); }\n        } catch(e) { setAriaCaptions(\'Transcription failed\'); setAriaState(\'idle\'); }\n      };\n      recorder.start();\n      setIsRecording(true);\n      setAriaState(\'listening\');\n      setAriaCaptions(\'🎙 Listening via Whisper... tap STOP when done\');\n    } catch(e) { setAriaCaptions(\'Microphone access denied — check browser permissions\'); setAriaState(\'idle\'); }\n  };\n\n  const stopRecording = () => {\n    if(recognitionRef.current) { recognitionRef.current.stop(); recognitionRef.current = null; }\n    if(mediaRecorderRef.current && mediaRecorderRef.current.state !== \'inactive\') mediaRecorderRef.current.stop();\n    setIsRecording(false);\n  };\n\n  const toggleRecording = () => { if(isRecording) stopRecording(); else startRecording(); };\n\n  const ariaSpeak = async text => {\n    if(ariaMuted){\n      // Even muted, show word-by-word highlight using timing estimate\n      const words = text.split(\' \');\n      let i = 0;\n      const iv = setInterval(()=>{\n        if(i >= words.length){ clearInterval(iv); setAriaState(\'idle\'); return; }\n        const highlighted = words.map((w,j)=>\n          j < i ? `<span style="color:var(--text2)">${w}</span>` :\n          j === i ? `<span style="color:#00d4aa;font-weight:700;text-shadow:0 0 8px rgba(0,212,170,0.6)">${w}</span>` :\n          `<span>${w}</span>`\n        ).join(\' \');\n        setAriaCaptions(highlighted);\n        i++;\n      }, 120);\n      return;\n    }\n    setAriaState(\'speaking\');\n    const words = text.split(\' \');\n    try {\n      const r = await fetch(`${API}/api/aria/speak?token=${tok}`,{method:\'POST\',headers:{\'Content-Type\':\'application/json\'},body:JSON.stringify({text,voice:ariaVoice})});\n      if(!r.ok) throw new Error();\n      const blob = await r.blob();\n      const audio = new Audio(URL.createObjectURL(blob));\n      const duration = await new Promise(res => {\n        audio.onloadedmetadata = () => res(audio.duration * 1000);\n        audio.onerror = () => res(words.length * 120);\n      });\n      const msPerWord = duration / words.length;\n      let i = 0;\n      const iv = setInterval(()=>{\n        if(i >= words.length){ clearInterval(iv); return; }\n        const highlighted = words.map((w,j)=>\n          j < i ? `<span style="color:var(--text2)">${w}</span>` :\n          j === i ? `<span style="color:#00d4aa;font-weight:700;text-shadow:0 0 8px rgba(0,212,170,0.6)">${w}</span>` :\n          `<span>${w}</span>`\n        ).join(\' \');\n        setAriaCaptions(highlighted);\n        i++;\n      }, msPerWord);\n      audio.onended = ()=>{ clearInterval(iv); setAriaState(\'idle\'); setAriaCaptions(text); };\n      await audio.play();\n    } catch { \n      let i = 0;\n      const iv = setInterval(()=>{\n        if(i >= words.length){ clearInterval(iv); setAriaState(\'idle\'); setAriaCaptions(text); return; }\n        const highlighted = words.map((w,j)=>\n          j < i ? `<span style="color:var(--text2)">${w}</span>` :\n          j === i ? `<span style="color:#00d4aa;font-weight:700;text-shadow:0 0 8px rgba(0,212,170,0.6)">${w}</span>` :\n          `<span>${w}</span>`\n        ).join(\' \');\n        setAriaCaptions(highlighted);\n        i++;\n      }, 120);\n    }\n  };\n\n  // ARIA text query\n  const ariaQuery = async q => {\n    if(!q.trim()) return;\n    setAriaMessages(m=>[...m,{role:\'user\',body:q}]);\n    setAriaInput(\'\');\n    setAriaState(\'thinking\');\n    setAriaCaptions(\'Processing your query...\');\n    try {\n      const r = await fetch(`${API}/api/aria/query?token=${tok}`,{method:\'POST\',headers:{\'Content-Type\':\'application/json\'},body:JSON.stringify({query:q})});\n      const d = await r.json();\n      await ariaSpeak(d.response);\n    } catch(e){ setAriaMessages(m=>[...m,{role:\'aria\',body:\'ARIA is temporarily unavailable. Please try again.\'}]); setAriaState(\'idle\'); }\n  };\n\n  // Report save\n  const saveReport = async (forceStatus) => {\n    if(!studyDetail) return;\n    try {\n      const existing = studyDetail.report;\n      const payload = forceStatus ? {...report, sign_status: forceStatus} : report;\n      if(forceStatus) setReport(r=>({...r, sign_status: forceStatus}));\n      if(existing){\n        await fetch(`${API}/api/report/${existing.report_id}?token=${tok}`,{method:\'PUT\',headers:{\'Content-Type\':\'application/json\'},body:JSON.stringify(payload)});\n      } else {\n        await fetch(`${API}/api/report?token=${tok}`,{method:\'POST\',headers:{\'Content-Type\':\'application/json\'},body:JSON.stringify({...payload,study_id:selectedStudy.study_id})});\n      }\n      if(forceStatus===\'Final\') notify(\'Report signed and finalised ✓\');\n      else notify(\'Report saved successfully\');\n      loadReports();\n    } catch(e){ notify(\'Failed to save report\',\'err\'); }\n  };\n\n  // AI assist report\n  const aiAssistReport = async () => {\n    if(!selectedStudy) return;\n    setAriaState(\'thinking\');\n    try {\n      const r = await fetch(`${API}/api/aria/assist-report?token=${tok}`,{method:\'POST\',headers:{\'Content-Type\':\'application/json\'},body:JSON.stringify({modality:selectedStudy.modality,body_part:selectedStudy.body_part,indication:report.indication,findings:report.findings})});\n      const d = await r.json();\n      setReport(prev=>({...prev,impression:d.suggestion}));\n      ariaSpeak(d.suggestion);\n    } catch(e){ notify(\'AI assist failed\',\'err\'); }\n  };\n\n  // Generate dataset\n  const generateDataset = async () => {\n    setGenLoading(true);\n    try {\n      const r = await fetch(`${API}/api/generate?token=${tok}`,{method:\'POST\',headers:{\'Content-Type\':\'application/json\'},body:JSON.stringify(genParams)});\n      const d = await r.json();\n      setGenResult(d);\n      await loadWorklist(); await loadStats();\n      notify(`Generated ${d.patients} patients, ${d.studies} studies`);\n    } catch(e){ notify(\'Generation failed\',\'err\'); }\n    setGenLoading(false);\n  };\n\n  // Export\n  const handleExport = async fmt => {\n    try {\n      const r = await fetch(`${API}/api/export?token=${tok}&fmt=${fmt}`);\n      const blob = await r.blob();\n      const url = URL.createObjectURL(blob);\n      const a = document.createElement(\'a\'); a.href=url; a.download=`aria_worklist.${fmt}`; a.click();\n      notify(`Exported as ${fmt.toUpperCase()}`);\n    } catch(e){ notify(\'Export failed\',\'err\'); }\n  };\n\n  // Import\n  const handleImport = async file => {\n    const form = new FormData(); form.append(\'file\',file);\n    try {\n      const r = await fetch(`${API}/api/import?token=${tok}`,{method:\'POST\',body:form});\n      const d = await r.json();\n      setImportResult(`✓ Imported ${d.imported} records successfully`);\n      await loadWorklist(); await loadStats();\n      notify(`Imported ${d.imported} records`);\n    } catch(e){ setImportResult(\'Import failed — check file format\'); }\n  };\n\n  // Priority colour\n  const priClass = p => p===\'Emergency\'?\'pri-e\':p===\'Urgent\'?\'pri-u\':\'pri-r\';\n  const rsClass = s => s===\'Unreported\'?\'rs-U\':s===\'Preliminary\'?\'rs-P\':s===\'Final\'?\'rs-F\':\'rs-D\';\n\n  // ── LOGIN ──────────────────────────────────────────────────────\n  if(!session) return (\n    <div className="login-wrap">\n      <div className="login-card">\n        <div className="login-avatar">A</div>\n        <div className="login-title">ARIA</div>\n        <div className="login-sub">Advanced Radiology Intelligence Assistant</div>\n        <div style={{textAlign:\'center\',marginBottom:\'28px\'}}><span className="login-badge">NHS PROTOTYPE</span></div>\n        {loginErr && <div className="login-error">{loginErr}</div>}\n        <form onSubmit={handleLogin}>\n          <label className="login-label">Username</label>\n          <input className="login-input" type="text" placeholder="Enter username" value={loginUser} onChange={e=>setLoginUser(e.target.value)} autoFocus/>\n          <label className="login-label">Password</label>\n          <input className="login-input" type="password" placeholder="Enter password" value={loginPass} onChange={e=>setLoginPass(e.target.value)}/>\n          <button className="login-btn" type="submit" disabled={loginLoading}>{loginLoading?\'Signing in...\':\'SIGN IN TO ARIA\'}</button>\n        </form>\n        <div className="login-confidential">CONFIDENTIAL — Authorised Access Only</div>\n        <div className="login-footer">This system is for NHS staff only. Not for clinical decision making.<br/>King\'s College Hospital NHS Foundation Trust<br/><br/><span style={{opacity:0.5}}>Demo: david / kings2024</span></div>\n      </div>\n    </div>\n  );\n\n  // ── MAIN APP ────────────────────────────────────────────────────\n  const RAIL_ITEMS = [\n    {id:\'worklist\',icon:\'☰\',label:\'List\'},\n    {id:\'viewer\',icon:\'⬜\',label:\'Viewer\'},\n    {id:\'reports\',icon:\'📋\',label:\'Reports\'},\n    {id:\'analytics\',icon:\'▦\',label:\'Stats\'},\n    {id:\'import\',icon:\'↑\',label:\'I/O\'},\n    {id:\'generator\',icon:\'⚙\',label:\'Gen\'},\n  ];\n\n  return (\n    <div className="app">\n      {/* TOPBAR */}\n      <div className="topbar">\n        <div className="topbar-logo"><div className="nhs-sq">NHS</div></div>\n        <div className="topbar-brand">\n          <h1>ARIA Radiology Workbench</h1>\n          <p>KING\'S COLLEGE HOSPITAL NHS FOUNDATION TRUST · DENMARK HILL SE5</p>\n        </div>\n        <div className="topbar-banner">\n          {selectedStudy ? <>\n            <div className="banner-field"><div className="bf-label">Patient</div><div className="bf-val">{selectedStudy.last_name?.toUpperCase()}, {selectedStudy.first_name}</div></div>\n            <div className="banner-field"><div className="bf-label">MRN</div><div className="bf-val">{selectedStudy.mrn}</div></div>\n            <div className="banner-field"><div className="bf-label">DOB / Age</div><div className="bf-val">{fmtDate(selectedStudy.dob)} ({age(selectedStudy.dob)}y)</div></div>\n            <div className="banner-field"><div className="bf-label">Sex</div><div className="bf-val">{selectedStudy.sex}</div></div>\n            <div className="banner-field"><div className="bf-label">Modality</div><div className="bf-val">{selectedStudy.modality} · {selectedStudy.body_part}</div></div>\n            {Number(selectedStudy.critical_flag)===1 && <div className="banner-field"><div className="pb-critical">⚠ CRITICAL</div></div>}\n            {(() => { try { const a=JSON.parse(selectedStudy.allergies||\'[]\'); return a.length&&a[0]!==\'None known\'?<div className="banner-field"><div className="bf-label">Allergies</div><div className="bf-val alert">{a.slice(0,2).join(\', \')}</div></div>:null; } catch{ return null; } })()}\n          </> : <div style={{color:\'rgba(255,255,255,0.3)\',fontSize:\'12px\',padding:\'0 16px\'}}>No study selected — select from worklist</div>}\n        </div>\n        <div className="topbar-right">\n          <div className="live-pill"><div className="live-d"/>LIVE</div>\n          {stats && <div style={{fontSize:\'10px\',color:\'rgba(255,255,255,0.5)\',fontFamily:\'var(--font-m)\'}}>{stats.total} studies · {stats.critical} critical</div>}\n          <div className="theme-tog">\n            <button className={`ttb ${theme===\'dark\'?\'on\':\'\'}`} onClick={()=>setTheme(\'dark\')}>DARK</button>\n            <button className={`ttb ${theme===\'light\'?\'on\':\'\'}`} onClick={()=>setTheme(\'light\')}>LIGHT</button>\n          </div>\n          <div className="topbar-user">\n            <div className="user-chip">👤 {session.username}</div>\n            <button className="logout-btn" onClick={handleLogout}>SIGN OUT</button>\n          </div>\n        </div>\n      </div>\n\n      {/* RAIL */}\n      <div className="rail">\n        {RAIL_ITEMS.map(item=>(\n          <button key={item.id} className={`rail-btn ${nav===item.id?\'active\':\'\'}`} onClick={()=>setNav(item.id)}>\n            <span className="rail-icon">{item.icon}</span>\n            <span className="rail-label">{item.label}</span>\n          </button>\n        ))}\n        <div className="rail-spacer"/>\n        <div className="rail-divider"/>\n        <button className="rail-btn" onClick={handleLogout} title="Sign out">\n          <span className="rail-icon">⏻</span>\n          <span className="rail-label">Out</span>\n        </button>\n      </div>\n\n      {/* WORKSPACE */}\n      <div className="workspace">\n\n        {/* ── WORKLIST ── */}\n        {nav===\'worklist\' && (\n          <div className="wl-wrap">\n            <div className="wl-toolbar">\n              <div className="wl-title">Radiology Worklist</div>\n              <div className="search-box">\n                <span style={{color:\'var(--text2)\'}}>🔍</span>\n                <input placeholder="Search patient, MRN, description..." value={filter.search} onChange={e=>setFilter(f=>({...f,search:e.target.value}))}/>\n              </div>\n              <select className="filter-sel" value={filter.mod} onChange={e=>setFilter(f=>({...f,mod:e.target.value}))}>\n                <option value="">All Modalities</option>\n                {[\'CT\',\'MRI\',\'XR\',\'US\',\'NM\'].map(m=><option key={m} value={m}>{m}</option>)}\n              </select>\n              <select className="filter-sel" value={filter.status} onChange={e=>setFilter(f=>({...f,status:e.target.value}))}>\n                <option value="">All Statuses</option>\n                {[\'Unreported\',\'Preliminary\',\'Final\'].map(s=><option key={s} value={s}>{s}</option>)}\n              </select>\n              <select className="filter-sel" value={filter.priority} onChange={e=>setFilter(f=>({...f,priority:e.target.value}))}>\n                <option value="">All Priorities</option>\n                {[\'Emergency\',\'Urgent\',\'Routine\'].map(p=><option key={p} value={p}>{p}</option>)}\n              </select>\n              {stats && <>\n                <span className="wl-stat red">⚠ {stats.critical} Critical</span>\n                <span className="wl-stat amb">{stats.unreported} Unreported</span>\n                <span className="wl-stat grn">{stats.total} Total</span>\n              </>}\n            </div>\n            <div className="table-wrap">\n              {studies.length===0 ? (\n                <div className="empty-state">\n                  <div className="empty-icon">📋</div>\n                  <div>No studies found</div>\n                  <div style={{marginTop:\'8px\',fontSize:\'11px\'}}>Use the Generator to create demo data, or adjust filters</div>\n                </div>\n              ) : (\n                <table>\n                  <thead>\n                    <tr>\n                      <th>Priority</th><th>Patient</th><th>MRN</th><th>DOB</th><th>Sex</th>\n                      <th>Modality</th><th>Study Description</th><th>Body Part</th>\n                      <th>Ordering Clinician</th><th>Scheduled</th><th>Report Status</th><th>⚠</th>\n                    </tr>\n                  </thead>\n                  <tbody>\n                    {studies.map(s=>(\n                      <tr key={s.study_id} className={selectedStudy?.study_id===s.study_id?\'active-row\':\'\'} onClick={()=>openStudy(s)}>\n                        <td><span className={`pri-badge ${priClass(s.priority)}`}>{s.priority}</span></td>\n                        <td className="primary">{s.last_name}, {s.first_name}</td>\n                        <td style={{fontFamily:\'var(--font-m)\',fontSize:\'10px\'}}>{s.mrn}</td>\n                        <td style={{fontSize:\'10px\'}}>{fmtDate(s.dob)}</td>\n                        <td>{s.sex}</td>\n                        <td><span className={`mod-tag m-${s.modality}`}>{s.modality}</span></td>\n                        <td style={{maxWidth:\'240px\',overflow:\'hidden\',textOverflow:\'ellipsis\'}}>{s.description}</td>\n                        <td>{s.body_part}</td>\n                        <td style={{fontSize:\'10px\'}}>{s.ordering_clinician}</td>\n                        <td style={{fontFamily:\'var(--font-m)\',fontSize:\'10px\'}}>{s.scheduled_time?.slice(11,16)} {s.scheduled_time?.slice(5,10)}</td>\n                        <td><span className={`rs-badge ${rsClass(s.report_status)}`}>{s.report_status}</span></td>\n                        <td>{Number(s.critical_flag)===1 && <span className="crit-flag">⚠</span>}</td>\n                      </tr>\n                    ))}\n                  </tbody>\n                </table>\n              )}\n            </div>\n          </div>\n        )}\n\n        {/* ── VIEWER ── */}\n        {nav===\'viewer\' && (\n          !selectedStudy ? (\n            <div className="no-study">\n              <div className="no-study-icon">🔬</div>\n              <div className="no-study-text">No Study Selected</div>\n              <div className="no-study-sub">Select a study from the worklist to begin</div>\n            </div>\n          ) : (\n            <div className="viewer-wrap">\n              {/* Series Panel */}\n              <div className="series-panel">\n                <div className="series-title">Series</div>\n                {studyDetail?.series?.map(ser=>(\n                  <div key={ser.series_id} className={`series-item ${selectedSeries?.series_id===ser.series_id?\'active\':\'\'}`} onClick={()=>setSelectedSeries(ser)}>\n                    <div className="series-num">Series {ser.series_number}</div>\n                    <div className="series-desc">{ser.series_description}</div>\n                  </div>\n                ))}\n                <div className="series-title" style={{marginTop:\'16px\'}}>Study Info</div>\n                <div style={{fontSize:\'10px\',color:\'var(--text2)\',lineHeight:\'1.8\',fontFamily:\'var(--font-m)\'}}>\n                  <div><span style={{color:\'var(--text2)\'}}>MOD:</span> <span style={{color:\'var(--text0)\'}}>{selectedStudy.modality}</span></div>\n                  <div><span style={{color:\'var(--text2)\'}}>ACC:</span> <span style={{color:\'var(--text0)\',fontSize:\'9px\'}}>{selectedStudy.accession}</span></div>\n                  <div><span style={{color:\'var(--text2)\'}}>ACQ:</span> <span style={{color:\'var(--text0)\'}}>{selectedStudy.acquisition_time?.slice(0,16)}</span></div>\n                  <div style={{marginTop:\'8px\',color:\'var(--text1)\'}}>{selectedStudy.description}</div>\n                </div>\n              </div>\n\n              {/* Canvas */}\n              <div className="viewer-canvas">\n                <div className="viewer-controls">\n                  {[\'Pan\',\'Zoom\',\'Measure\',\'Annotate\',\'WL\'].map(t=>(\n                    <button key={t} className={`vc-btn ${viewerTool===t.toLowerCase()?\'on\':\'\'}`} onClick={()=>setViewerTool(t.toLowerCase())}>{t}</button>\n                  ))}\n                </div>\n                <DicomViewer study={selectedStudy} series={studyDetail?.series} selectedSeries={selectedSeries}/>\n                <div className="wl-slider">\n                  <div className="slider-group"><div className="slider-label">WINDOW</div><input type="range" min="1" max="800" defaultValue="400"/></div>\n                  <div className="slider-group"><div className="slider-label">LEVEL</div><input type="range" min="-200" max="400" defaultValue="40"/></div>\n                  <div className="slider-group"><div className="slider-label">ZOOM</div><input type="range" min="50" max="300" defaultValue="100"/></div>\n                </div>\n              </div>\n\n              {/* Report Side */}\n              <div className="report-side">\n                <div className="report-header">\n                  <div className="rh-title">Report Editor</div>\n                  <span className={`rs-badge ${rsClass(studyDetail?.report?.sign_status||report.sign_status)}`}>{studyDetail?.report?.sign_status||report.sign_status||\'Draft\'}</span>\n                </div>\n                <div className="rep-fields">\n                  <div className="rep-section">\n                    <label>Indication</label>\n                    <textarea className="rep-textarea" rows={2} value={report.indication} onChange={e=>setReport(r=>({...r,indication:e.target.value}))}/>\n                  </div>\n                  <div className="rep-section">\n                    <label>Technique</label>\n                    <textarea className="rep-textarea" rows={2} value={report.technique} onChange={e=>setReport(r=>({...r,technique:e.target.value}))}/>\n                  </div>\n                  <div className="rep-section">\n                    <label>Findings</label>\n                    <textarea className="rep-textarea findings" rows={6} value={report.findings} onChange={e=>setReport(r=>({...r,findings:e.target.value}))}/>\n                  </div>\n                  <div className="rep-section">\n                    <div className={`ai-impression-panel ${ariaState===\'thinking\'?\'generating\':\'\'}`}>\n                      <div className={`ai-impression-text ${!report.impression?\'empty\':\'\'}`}\n                        dangerouslySetInnerHTML={{__html: report.impression \n                          ? report.impression\n                            .replace(/\\*\\*([^*]+)\\*\\*/g, \'<strong style="color:#00ffcc;font-size:15px">$1</strong>\')\n                            .replace(/^- /gm, \'• \')\n                            .replace(/\n/g, \'<br/>\')\n                          : \'Click Generate AI Impression below...\'\n                        }}\n                      />\n                      {report.impression && <div className="ai-impression-meta">\n                        <span className="ai-impression-badge">⚕ AI ASSISTED</span>\n                        <span className="ai-impression-badge" style={{color:\'#ff9900\',borderColor:\'rgba(255,153,0,0.3)\'}}>REQUIRES REVIEW</span>\n                        <button className="ai-speak-btn" onClick={()=>ariaSpeak(report.impression)}>🔊 Read Aloud</button>\n                        <button className="ai-speak-btn" onClick={()=>setReport(r=>({...r,impression:\'\'}))}>✕ Clear</button>\n                      </div>}\n                    </div>\n                  </div>\n                  <div className="rep-section">\n                    <button className="ai-btn" onClick={aiAssistReport}>✦ Generate AI Impression</button>\n                  </div>\n                </div>\n                <div className="rep-actions">\n                  <button className="rep-btn primary" onClick={saveReport}>💾 Save Report</button>\n                  <button className="rep-btn primary" onClick={()=>saveReport(\'Final\')}>✓ Sign & Finalise</button>\n                  <button className="rep-btn secondary" onClick={()=>notify(\'Addendum mode — type in findings\')}>+ Add Addendum</button>\n                </div>\n              </div>\n            </div>\n          )\n        )}\n\n        {/* ── REPORTS ── */}\n        {nav===\'reports\' && (\n          <div className="reports-wrap">\n            <div className="reports-list">\n              <div className="reports-list-header">\n                <div className="reports-list-title">Signed Reports</div>\n                <div className="reports-list-sub">{reports.length} REPORTS IN SYSTEM</div>\n              </div>\n              {reports.length===0 ? (\n                <div className="no-reports" style={{padding:\'40px\',textAlign:\'center\'}}>\n                  <div style={{fontSize:\'32px\',marginBottom:\'12px\',opacity:0.3}}>📋</div>\n                  <div style={{opacity:0.4}}>No reports yet</div>\n                  <div style={{fontSize:\'11px\',marginTop:\'8px\',opacity:0.3}}>Sign and save reports from the Viewer</div>\n                </div>\n              ) : reports.map(rep=>(\n                <div key={rep.report_id} className={`report-card ${selectedReport?.report_id===rep.report_id?\'active\':\'\'}`} onClick={()=>setSelectedReport(rep)}>\n                  <div className="rc-patient">{rep.last_name}, {rep.first_name}</div>\n                  <div className="rc-meta">{rep.mrn} · {rep.modality} {rep.body_part} · {fmtDate(rep.signed_at||rep.updated_at)}</div>\n                  <div className="rc-impression">{rep.impression?.replace(/\\*\\*([^*]+)\\*\\*/g,\'$1\').slice(0,120)}...</div>\n                  <div className="rc-badges">\n                    <span className={`rs-badge ${rep.sign_status===\'Final\'?\'rs-F\':rep.sign_status===\'Preliminary\'?\'rs-P\':\'rs-D\'}`}>{rep.sign_status||\'Draft\'}</span>\n                    <span className={`mod-tag m-${rep.modality}`}>{rep.modality}</span>\n                    {rep.ai_assisted && <span className="ai-impression-badge" style={{fontSize:\'8px\'}}>⚕ AI ASSISTED</span>}\n                  </div>\n                </div>\n              ))}\n            </div>\n            <div className="report-detail">\n              {!selectedReport ? (\n                <div className="no-reports">\n                  <div style={{fontSize:\'48px\',marginBottom:\'16px\',opacity:0.15}}>📄</div>\n                  <div style={{fontFamily:\'var(--font-h)\',fontSize:\'20px\',fontStyle:\'italic\',opacity:0.3}}>Select a report</div>\n                  <div style={{fontSize:\'12px\',marginTop:\'8px\',opacity:0.2}}>Click a report from the list to view full details</div>\n                </div>\n              ) : (\n                <div>\n                  <div className="rd-header">\n                    <div className="rd-patient-name">{selectedReport.last_name}, {selectedReport.first_name}</div>\n                    <div className="rd-meta-row">\n                      <div className="rd-meta-field"><div className="rd-meta-label">MRN</div><div className="rd-meta-value">{selectedReport.mrn}</div></div>\n                      <div className="rd-meta-field"><div className="rd-meta-label">Modality</div><div className="rd-meta-value">{selectedReport.modality} · {selectedReport.body_part}</div></div>\n                      <div className="rd-meta-field"><div className="rd-meta-label">Accession</div><div className="rd-meta-value">{selectedReport.accession}</div></div>\n                      <div className="rd-meta-field"><div className="rd-meta-label">Report Date</div><div className="rd-meta-value">{fmt(selectedReport.updated_at)}</div></div>\n                    </div>\n                    <div className="rd-signed-banner">\n                      <div className="rd-signed-icon">{selectedReport.sign_status===\'Final\'?\'✅\':\'📝\'}</div>\n                      <div>\n                        <div className="rd-signed-text">{selectedReport.sign_status===\'Final\'?\'SIGNED & FINALISED\':\'PRELIMINARY REPORT\'} · {selectedReport.sign_status?.toUpperCase()}</div>\n                        <div className="rd-signed-sub">King\'s College Hospital NHS Foundation Trust · Radiology Department · Denmark Hill SE5</div>\n                      </div>\n                    </div>\n                  </div>\n                  <div className="rd-body">\n                    {selectedReport.indication && <div className="rd-section">\n                      <div className="rd-section-label">Clinical Indication</div>\n                      <div className="rd-section-text">{selectedReport.indication}</div>\n                    </div>}\n                    {selectedReport.technique && <div className="rd-section">\n                      <div className="rd-section-label">Technique</div>\n                      <div className="rd-section-text">{selectedReport.technique}</div>\n                    </div>}\n                    {selectedReport.findings && <div className="rd-section">\n                      <div className="rd-section-label">Findings</div>\n                      <div className="rd-section-text">{selectedReport.findings}</div>\n                    </div>}\n                    {selectedReport.impression && <div className="rd-ai-section">\n                      <div className="rd-ai-text" dangerouslySetInnerHTML={{__html: (selectedReport.impression||\'\')\n                        .replace(/\\*\\*([^*]+)\\*\\*/g,\'<strong style="color:#00ffcc;font-size:14px">$1</strong>\')\n                        .replace(/^- /gm,\'• \')\n                        .replace(/\n/g,\'<br/>\')\n                      }}/>\n                      <div className="rd-ai-footer">\n                        <span className="ai-impression-badge">⚕ AI ASSISTED</span>\n                        <span className="ai-impression-badge" style={{color:\'#ff9900\',borderColor:\'rgba(255,153,0,0.3)\'}}>REQUIRES CLINICAL REVIEW</span>\n                        <button className="rd-speak-btn" onClick={()=>ariaSpeak(selectedReport.impression.replace(/\\*\\*([^*]+)\\*\\*/g,\'$1\'))}>🔊 Read Aloud</button>\n                      </div>\n                    </div>}\n                    <div style={{display:\'flex\',gap:\'10px\',marginTop:\'8px\'}}>\n                      <button className="rd-print-btn" onClick={()=>window.print()}>🖨 Print Report</button>\n                      <button className="rd-speak-btn" onClick={()=>ariaSpeak(`Report for ${selectedReport.first_name} ${selectedReport.last_name}. ${selectedReport.findings||\'\'} ${selectedReport.impression?.replace(/\\*\\*([^*]+)\\*\\*/g,\'$1\')||\'\'}`)}>🔊 Read Full Report</button>\n                    </div>\n                  </div>\n                </div>\n              )}\n            </div>\n          </div>\n        )}\n\n        {/* ── ANALYTICS ── */}}\n        {nav===\'analytics\' && (\n          <div className="analytics-wrap">\n            <div className="a-title">Department Analytics</div>\n            <div className="a-subtitle">King\'s College Hospital · Radiology Department · Live data</div>\n\n            {/* Top KPI cards */}\n            <div className="a-grid">\n              <div className="a-card blue">\n                <div className="a-l">Total Studies</div>\n                <div className="a-n">{stats?.total||0}</div>\n                <div className="a-sub">All modalities in system</div>\n              </div>\n              <div className="a-card red">\n                <div className="a-l">⚠ Critical Findings</div>\n                <div className="a-n">{stats?.critical||0}</div>\n                <div className="a-pct" style={{color:\'var(--urgent)\'}}>{stats?.total?Math.round(stats.critical/stats.total*100):0}% of studies require urgent action</div>\n              </div>\n              <div className="a-card amber">\n                <div className="a-l">Unreported Studies</div>\n                <div className="a-n">{stats?.unreported||0}</div>\n                <div className="a-pct" style={{color:\'var(--warn)\'}}>{stats?.total?Math.round(stats.unreported/stats.total*100):0}% awaiting radiologist report</div>\n              </div>\n              <div className="a-card green">\n                <div className="a-l">Total Patients</div>\n                <div className="a-n">{stats?.patients||0}</div>\n                <div className="a-sub">Unique patients with imaging</div>\n              </div>\n            </div>\n\n            {/* Modality breakdown */}\n            <div className="a-section-title">Studies by Modality</div>\n            <div className="a-mod-grid">\n              {[\'CT\',\'MRI\',\'XR\',\'US\',\'NM\'].map(m=>{\n                const n = stats?.modalities?.[m]||0;\n                const pct = stats?.total ? Math.round(n/stats.total*100) : 0;\n                const colors={CT:\'var(--accent)\',MRI:\'var(--accent2)\',XR:\'var(--warn)\',US:\'#9b81ff\',NM:\'#ff80d0\'};\n                const labels={CT:\'Computed Tomography\',MRI:\'Magnetic Resonance\',XR:\'X-Ray / Plain Film\',US:\'Ultrasound\',NM:\'Nuclear Medicine\'};\n                return <div key={m} className="a-mod-card">\n                  <div className="a-mod-n" style={{color:colors[m]}}>{n}</div>\n                  <div className="a-mod-l" style={{color:colors[m]}}>{m}</div>\n                  <div className="a-mod-pct">{pct}% · {labels[m]}</div>\n                </div>;\n              })}\n            </div>\n\n            {/* Two column: bar chart + report status */}\n            <div className="a-two-col">\n              <div className="bar-chart">\n                <div className="bar-chart-title">Volume by Modality</div>\n                {[\'CT\',\'MRI\',\'XR\',\'US\',\'NM\'].map(m=>{\n                  const max=Math.max(...[\'CT\',\'MRI\',\'XR\',\'US\',\'NM\'].map(x=>stats?.modalities?.[x]||0))||1;\n                  const n=stats?.modalities?.[m]||0;\n                  const colors={CT:\'var(--accent)\',MRI:\'var(--accent2)\',XR:\'var(--warn)\',US:\'#9b81ff\',NM:\'#ff80d0\'};\n                  return <div key={m} className="bar-row">\n                    <div className="bar-label">{m}</div>\n                    <div className="bar-track"><div className="bar-fill" style={{width:`${(n/max)*100}%`,background:colors[m]}}/></div>\n                    <div className="bar-val">{n}</div>\n                  </div>;\n                })}\n              </div>\n              <div className="report-status-chart">\n                <div className="bar-chart-title">Report Status Breakdown</div>\n                {[\n                  {label:\'Final — Signed\',color:\'var(--ok)\',dot:\'#00914d\',key:\'Final\'},\n                  {label:\'Preliminary — Draft\',color:\'var(--accent)\',dot:\'#00aaff\',key:\'Preliminary\'},\n                  {label:\'Unreported — Pending\',color:\'var(--warn)\',dot:\'#e07b00\',key:\'Unreported\'},\n                ].map(({label,color,dot,key})=>{\n                  const total = stats?.total||1;\n                  const unrep = stats?.unreported||0;\n                  const crit = stats?.critical||0;\n                  const counts = {\n                    Final: total - unrep - Math.round(total*0.12),\n                    Preliminary: Math.round(total*0.12),\n                    Unreported: unrep\n                  };\n                  const n = counts[key]||0;\n                  const pct = Math.round(n/total*100);\n                  return <div key={key} className="rs-row">\n                    <div className="rs-label"><div className="rs-dot" style={{background:dot}}/>{label}</div>\n                    <div className="rs-nums">\n                      <div className="rs-count" style={{color}}>{n}</div>\n                      <div className="rs-pct-bar"><div className="rs-pct-fill" style={{width:`${pct}%`,background:dot}}/></div>\n                      <div style={{fontSize:\'10px\',color:\'var(--text2)\',width:\'28px\',fontFamily:\'var(--font-m)\'}}>{pct}%</div>\n                    </div>\n                  </div>;\n                })}\n                <div style={{marginTop:\'12px\',paddingTop:\'10px\',borderTop:\'1px solid var(--border)\'}}>\n                  <div className="rs-row" style={{paddingTop:0}}>\n                    <div className="rs-label"><div className="rs-dot" style={{background:\'var(--urgent)\'}}/><strong>Critical — Immediate Action</strong></div>\n                    <div className="rs-nums">\n                      <div className="rs-count" style={{color:\'var(--urgent)\'}}>{stats?.critical||0}</div>\n                      <div className="rs-pct-bar"><div className="rs-pct-fill" style={{width:`${stats?.total?Math.round((stats.critical/stats.total)*100):0}%`,background:\'var(--urgent)\'}}/></div>\n                      <div style={{fontSize:\'10px\',color:\'var(--urgent)\',width:\'28px\',fontFamily:\'var(--font-m)\'}}>{stats?.total?Math.round(stats.critical/stats.total*100):0}%</div>\n                    </div>\n                  </div>\n                </div>\n              </div>\n            </div>\n          </div>\n        )}\n\n        {/* ── IMPORT / EXPORT ── */}\n        {nav===\'import\' && (\n          <div className="ie-wrap">\n            <div className="ie-title">Import & Export</div>\n            <div className="ie-grid">\n              <div className="ie-card">\n                <div className="ie-card-title">↑ Import Data</div>\n                <div className="drop-zone" onClick={()=>fileRef.current?.click()} onDragOver={e=>e.preventDefault()} onDrop={e=>{e.preventDefault();const f=e.dataTransfer.files[0];if(f)handleImport(f);}}>\n                  <div className="drop-zone-icon">📂</div>\n                  <div className="drop-zone-text">Drop CSV or JSON file here<br/>or click to browse</div>\n                </div>\n                <input type="file" accept=".csv,.json" ref={fileRef} style={{display:\'none\'}} onChange={e=>e.target.files[0]&&handleImport(e.target.files[0])}/>\n                {importResult && <div className="ie-result">{importResult}</div>}\n                <div style={{marginTop:\'16px\',fontSize:\'11px\',color:\'var(--text2)\',lineHeight:\'1.8\'}}>\n                  <div style={{fontWeight:\'700\',marginBottom:\'6px\',color:\'var(--text1)\'}}>Expected CSV columns:</div>\n                  <div style={{fontFamily:\'var(--font-m)\',fontSize:\'10px\'}}>mrn, first_name, last_name, dob, sex</div>\n                </div>\n              </div>\n              <div className="ie-card">\n                <div className="ie-card-title">↓ Export Data</div>\n                <button className="ie-btn export" onClick={()=>handleExport(\'json\')}>Export as JSON</button>\n                <button className="ie-btn export-csv" onClick={()=>handleExport(\'csv\')}>Export as CSV</button>\n                <div style={{marginTop:\'16px\',fontSize:\'11px\',color:\'var(--text2)\',lineHeight:\'1.8\'}}>\n                  Exports current worklist with patient demographics, study details, modalities, priorities and report statuses.\n                </div>\n              </div>\n            </div>\n          </div>\n        )}\n\n        {/* ── GENERATOR ── */}\n        {nav===\'generator\' && (\n          <div className="gen-wrap">\n            <div className="gen-title">Dataset Generator</div>\n            <div className="gen-sub">Generate realistic synthetic radiology patients and studies for demonstration purposes</div>\n            <div className="gen-grid">\n              <div className="gen-card">\n                <div className="gen-card-title">Patient Parameters</div>\n                {[{key:\'patients\',label:\'Number of Patients\',min:10,max:200,step:10},{key:\'studies_per_patient\',label:\'Studies per Patient\',min:1,max:8,step:1},{key:\'critical_pct\',label:\'Critical Finding %\',min:0,max:50,step:5}].map(({key,label,min,max,step})=>(\n                  <div key={key} className="slider-wrap">\n                    <label>{label} <span>{genParams[key]}{key===\'critical_pct\'?\'%\':\'\'}</span></label>\n                    <input type="range" min={min} max={max} step={step} value={genParams[key]} onChange={e=>setGenParams(p=>({...p,[key]:parseInt(e.target.value)}))}/>\n                  </div>\n                ))}\n              </div>\n              <div className="gen-card">\n                <div className="gen-card-title">Study Mix Preview</div>\n                <div style={{fontSize:\'12px\',color:\'var(--text1)\',lineHeight:\'2.0\'}}>\n                  <div>📊 Est. studies: <strong style={{color:\'var(--accent)\'}}>{genParams.patients * genParams.studies_per_patient}</strong></div>\n                  <div>⚠ Est. critical: <strong style={{color:\'var(--urgent)\'}}>{Math.round(genParams.patients * genParams.studies_per_patient * genParams.critical_pct / 100)}</strong></div>\n                  <div style={{marginTop:\'12px\',fontSize:\'10px\',color:\'var(--text2)\'}}>Modality distribution: CT 30% · MRI 18% · XR 25% · US 18% · NM 9%</div>\n                  <div style={{marginTop:\'8px\',fontSize:\'10px\',color:\'var(--text2)\'}}>Includes realistic: study descriptions · clinician names · ordering locations · report statuses · contrast flags · critical findings</div>\n                </div>\n              </div>\n            </div>\n            <div style={{marginTop:\'24px\'}}>\n              <button className="gen-btn" onClick={generateDataset} disabled={genLoading}>{genLoading?\'Generating...\':\'⚙ GENERATE DATASET\'}</button>\n            </div>\n            {genResult && (\n              <div className="gen-result fi">\n                <div className="gen-result-title">✓ Dataset Generated Successfully</div>\n                <div className="gen-stat-row">\n                  <div className="gen-stat"><div className="gen-stat-n">{genResult.patients}</div><div className="gen-stat-l">Patients</div></div>\n                  <div className="gen-stat"><div className="gen-stat-n">{genResult.studies}</div><div className="gen-stat-l">Studies</div></div>\n                  <div className="gen-stat"><div className="gen-stat-n">{Math.round(genResult.studies*genParams.critical_pct/100)}</div><div className="gen-stat-l">Est. Critical</div></div>\n                </div>\n                <div style={{marginTop:\'12px\',fontSize:\'11px\',color:\'var(--text2)\'}}>Navigate to Worklist to browse generated data →</div>\n              </div>\n            )}\n          </div>\n        )}\n\n      </div>{/* end workspace */}\n\n      {/* ARIA SIDE PANEL (always visible) */}\n      <div className="aria-panel" style={{position:\'fixed\',right:0,top:\'var(--header)\',bottom:0,width:\'290px\',zIndex:50,borderLeft:\'1px solid var(--border)\',display:\'flex\',flexDirection:\'column\'}}>\n        <div className="aria-avatar-area">\n          <div className="aria-face-wrap"><AriaFace state={ariaState}/></div>\n          <div className="aria-name">ARIA</div>\n          <div className="aria-sub">Advanced Radiology Intelligence Assistant</div>\n\n          {/* State indicator */}\n          <div className="aria-state-wrap">\n            <div className={`aria-state ${ariaState===\'listening\'?\'listening\':ariaState===\'speaking\'?\'speaking\':ariaState===\'thinking\'?\'thinking\':\'\'}`}>\n              <div className="state-dot"/>\n              {ariaState===\'idle\'?\'Ready\':ariaState===\'speaking\'?\'Speaking\':ariaState===\'listening\'?\'Listening\':\'Thinking...\'}\n            </div>\n          </div>\n\n          {/* Waveform visualiser */}\n          <div className={`aria-waveform ${ariaState===\'speaking\'||ariaState===\'listening\'?\'active\':ariaState===\'thinking\'?\'thinking\':\'\'}`}>\n            {Array.from({length:18}).map((_,i)=>{\n              const isSpeaking = ariaState===\'speaking\';\n              const isListening = ariaState===\'listening\';\n              const isThinking = ariaState===\'thinking\';\n              const baseH = isSpeaking||isListening ? 4+Math.random()*18 : 3;\n              return <div key={i} className="wave-bar" style={{\n                height: `${isSpeaking||isListening ? baseH : 3}px`,\n                background: isThinking?\'#b090ff\':isListening?\'var(--urgent)\':\'var(--accent)\',\n                animationDelay: isThinking?`${i*0.07}s`:\'0s\',\n                transition: isSpeaking ? `height ${0.08+Math.random()*0.06}s ease` : \'height 0.3s ease\'\n              }}/>;\n            })}\n          </div>\n\n          {/* Big TALK button */}\n          <div className="talk-btn-wrap">\n            <button className={`talk-btn ${isRecording?\'recording\':\'idle\'}`} onClick={toggleRecording}>\n              <span className="talk-btn-icon">{isRecording?\'⏹\':\'🎙\'}</span>\n              {isRecording?\'STOP RECORDING\':\'TAP TO TALK\'}\n            </button>\n          </div>\n\n          {/* Mute + voice row */}\n          <div className="voice-row">\n            <button className={`mute-btn ${ariaMuted?\'muted\':\'\'}`} onClick={()=>setAriaMuted(m=>!m)}>\n              {ariaMuted?\'🔇 Muted\':\'🔊 Audio On\'}\n            </button>\n            <select className="voice-sel" value={ariaVoice} onChange={e=>setAriaVoice(e.target.value)}>\n              <option value="nova">Nova</option>\n              <option value="alloy">Alloy</option>\n              <option value="shimmer">Shimmer</option>\n            </select>\n          </div>\n\n          {/* Captions */}\n          <div className="aria-captions" ref={captionsRef} dangerouslySetInnerHTML={{__html: String(ariaCaptions||"")}} />\n        </div>\n        <div className="aria-chat">\n          {ariaMessages.map((m,i)=>(\n            <div key={i} className={`msg ${m.role}`}>\n              <div className="msg-role">{m.role===\'aria\'?\'ARIA\':\'You\'}</div>\n              <div className="msg-body">{m.body}</div>\n            </div>\n          ))}\n        </div>\n        <div className="aria-input-row">\n          <input className="aria-input" value={ariaInput} onChange={e=>setAriaInput(e.target.value)} placeholder="Type to ask ARIA..." onKeyDown={e=>e.key===\'Enter\'&&ariaQuery(ariaInput)}/>\n          <button className="aria-send" onClick={()=>ariaQuery(ariaInput)}>➤</button>\n        </div>\n      </div>\n\n      {/* NOTIFICATION */}\n      {notif && <Notif msg={notif.msg} type={notif.type} onClose={()=>setNotif(null)}/>}\n    </div>\n  );\n}\n\nReactDOM.createRoot(document.getElementById(\'root\')).render(<App/>);\n</script>\n</body>\n</html>'
with open(r'E:\\Claude\\Dev\\aria\\frontend\\index.html', 'w', encoding='utf-8') as f:
    f.write(content)
print('Done!')
