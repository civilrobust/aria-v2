<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ARIA Radiology Workbench · King's College Hospital</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Mono:wght@300;400;500&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}

/* ══════════════════════════════════════════
   CSS VARIABLES — DARK (default)
══════════════════════════════════════════ */
:root {
  --bg0:#0e1117; --bg1:#151b24; --bg2:#1c2433; --bg3:#232d3f;
  --bg-hover:rgba(0,94,184,0.08); --bg-active:rgba(0,94,184,0.14);
  --nhs:#003087; --nhs2:#005eb8; --accent:#00aaff; --accent2:#00d4aa;
  --urgent:#e8001e; --warn:#e07b00; --ok:#00914d; --info:#7b61ff;
  --text0:#f0f4ff; --text1:#a8bacf; --text2:#5a7090; --text3:#334455;
  --border:rgba(255,255,255,0.07); --border2:rgba(0,170,255,0.2);
  --shadow:0 2px 16px rgba(0,0,0,0.4); --shadow2:0 8px 40px rgba(0,0,0,0.6);
  --glow:0 0 24px rgba(0,170,255,0.2); --glow-r:0 0 20px rgba(232,0,30,0.3);
  --font-h:'DM Serif Display',serif; --font-m:'DM Mono',monospace; --font-s:'DM Sans',sans-serif;
  --rail:64px; --header:52px;
  --card-r:8px;
}
/* ── LIGHT ── */
[data-theme="light"] {
  --bg0:#eef1f6; --bg1:#f8f9fc; --bg2:#ffffff; --bg3:#f0f3f8;
  --bg-hover:rgba(0,48,135,0.04); --bg-active:rgba(0,48,135,0.09);
  --accent:#005eb8; --accent2:#007f6e;
  --urgent:#c0001a; --warn:#b06000; --ok:#006b32;
  --text0:#0a1628; --text1:#3a5070; --text2:#7090aa; --text3:#b0c4d8;
  --border:rgba(0,30,80,0.1); --border2:rgba(0,94,184,0.25);
  --shadow:0 1px 8px rgba(0,20,60,0.08); --shadow2:0 4px 24px rgba(0,20,60,0.12);
  --glow:0 2px 12px rgba(0,94,184,0.15); --glow-r:0 2px 12px rgba(192,0,26,0.15);
}

/* ══════════════════════════════════════════ BASE */
html,body{height:100%;background:var(--bg0);color:var(--text0);font-family:var(--font-s);font-size:13px;overflow:hidden;transition:background .25s,color .25s}
#root{height:100%}
input,button,select,textarea{font-family:var(--font-s)}
::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:3px}
button{cursor:pointer;border:none;outline:none}
input,textarea{outline:none}

/* ══════════════════════════════════════════ LOGIN */
.login-wrap{
  position:fixed;inset:0;display:flex;align-items:center;justify-content:center;
  background:linear-gradient(135deg,#001a4d 0%,#003087 40%,#005eb8 70%,#0080c8 100%);
  z-index:1000;
}
.login-wrap::before{
  content:'';position:absolute;inset:0;pointer-events:none;
  background-image:linear-gradient(rgba(255,255,255,0.03) 1px,transparent 1px),
    linear-gradient(90deg,rgba(255,255,255,0.03) 1px,transparent 1px);
  background-size:48px 48px;
}
.login-wrap::after{
  content:'';position:absolute;inset:0;pointer-events:none;
  background:radial-gradient(ellipse at 30% 50%,rgba(0,200,255,0.08) 0%,transparent 60%),
    radial-gradient(ellipse at 70% 50%,rgba(0,80,200,0.1) 0%,transparent 60%);
}
.login-card{
  background:rgba(255,255,255,0.97);border-radius:16px;padding:48px 44px;width:420px;
  box-shadow:0 24px 80px rgba(0,0,0,0.4),0 0 0 1px rgba(255,255,255,0.1);
  position:relative;z-index:1;
  animation:card-in 0.5s cubic-bezier(0.34,1.56,0.64,1) both;
}
@keyframes card-in{from{opacity:0;transform:translateY(24px) scale(0.96)}to{opacity:1;transform:translateY(0) scale(1)}}
.login-avatar{
  width:72px;height:72px;margin:0 auto 16px;border-radius:50%;
  background:linear-gradient(135deg,#003087,#005eb8);
  display:flex;align-items:center;justify-content:center;
  box-shadow:0 8px 24px rgba(0,48,135,0.35);
  font-size:28px;color:white;font-family:var(--font-h);font-style:italic;
}
.login-title{font-family:var(--font-h);font-size:32px;font-weight:400;color:#003087;text-align:center;font-style:italic;margin-bottom:4px}
.login-sub{font-size:12px;color:#5a7090;text-align:center;letter-spacing:0.06em;margin-bottom:6px}
.login-badge{display:inline-block;background:#003087;color:white;font-size:9px;font-weight:700;letter-spacing:0.12em;padding:3px 10px;border-radius:12px;margin-bottom:28px}
.login-label{font-size:10px;font-weight:600;letter-spacing:0.1em;color:#5a7090;text-transform:uppercase;margin-bottom:6px;display:block}
.login-input{
  width:100%;padding:11px 14px;border:1.5px solid #d0dae8;border-radius:8px;
  font-size:14px;color:#0a1628;background:white;margin-bottom:16px;
  transition:border-color .2s,box-shadow .2s;
}
.login-input:focus{border-color:#005eb8;box-shadow:0 0 0 3px rgba(0,94,184,0.12)}
.login-btn{
  width:100%;padding:13px;background:#003087;color:white;border-radius:8px;
  font-size:13px;font-weight:700;letter-spacing:0.1em;text-transform:uppercase;
  transition:all .2s;box-shadow:0 4px 16px rgba(0,48,135,0.3);margin-bottom:20px;
}
.login-btn:hover{background:#002468;box-shadow:0 6px 24px rgba(0,48,135,0.4);transform:translateY(-1px)}
.login-btn:active{transform:translateY(0)}
.login-btn:disabled{opacity:0.6;cursor:not-allowed;transform:none}
.login-confidential{font-size:11px;color:#c0001a;font-weight:600;text-align:center;margin-bottom:4px}
.login-footer{font-size:10px;color:#8090a0;text-align:center;line-height:1.7}
.login-error{background:#fff0f0;border:1px solid #ffc0c8;border-radius:6px;padding:10px 14px;font-size:12px;color:#c0001a;margin-bottom:16px;text-align:center}

/* ══════════════════════════════════════════ APP SHELL */
.app{display:grid;grid-template-columns:var(--rail) 1fr;grid-template-rows:var(--header) 1fr;height:100vh;transition:all .25s}

/* ── TOP BAR ── */
.topbar{
  grid-column:1/-1;display:flex;align-items:center;gap:0;
  background:var(--nhs);border-bottom:1px solid rgba(255,255,255,0.1);
  position:relative;z-index:200;box-shadow:0 2px 16px rgba(0,0,0,0.3);
}
.topbar::after{content:'';position:absolute;bottom:0;left:0;right:0;height:2px;background:linear-gradient(90deg,#005eb8,#00843d,#ffb81c);opacity:0.6}
.topbar-logo{width:var(--rail);display:flex;align-items:center;justify-content:center;flex-shrink:0}
.nhs-sq{background:white;color:#003087;font-weight:900;font-size:13px;padding:4px 7px;border-radius:3px;letter-spacing:-0.02em}
.topbar-brand{padding:0 20px;border-right:1px solid rgba(255,255,255,0.12)}
.topbar-brand h1{font-family:var(--font-h);font-size:17px;font-style:italic;color:white;letter-spacing:0.02em}
.topbar-brand p{font-size:9px;color:rgba(255,255,255,0.5);letter-spacing:0.1em;margin-top:1px}
.topbar-banner{flex:1;display:flex;align-items:center;gap:0;padding:0 16px;overflow:hidden}
.banner-field{padding:0 16px;border-right:1px solid rgba(255,255,255,0.1)}
.banner-field:last-child{border-right:none}
.bf-label{font-size:8px;color:rgba(255,255,255,0.4);letter-spacing:0.1em;text-transform:uppercase;margin-bottom:1px}
.bf-val{font-size:12px;color:white;font-family:var(--font-m);font-weight:400}
.bf-val.alert{color:#ffb81c}
.topbar-right{display:flex;align-items:center;gap:12px;padding:0 16px}
.theme-tog{display:flex;background:rgba(255,255,255,0.1);border-radius:20px;padding:3px;border:1px solid rgba(255,255,255,0.15)}
.ttb{padding:3px 10px;border-radius:16px;font-size:9px;font-weight:700;letter-spacing:0.1em;background:transparent;color:rgba(255,255,255,0.45);transition:all .2s;border:none}
.ttb.on{background:rgba(255,255,255,0.9);color:#003087}
.topbar-user{display:flex;align-items:center;gap:8px}
.user-chip{background:rgba(255,255,255,0.15);border-radius:20px;padding:5px 12px;font-size:11px;color:white;font-weight:500}
.logout-btn{background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);color:rgba(255,255,255,0.7);padding:5px 12px;border-radius:6px;font-size:10px;font-weight:600;letter-spacing:0.08em;transition:all .2s}
.logout-btn:hover{background:rgba(255,255,255,0.2)}
.live-pill{display:flex;align-items:center;gap:5px;font-size:9px;font-weight:700;letter-spacing:0.12em;color:#6effb4}
.live-d{width:6px;height:6px;border-radius:50%;background:#6effb4;animation:pd 1.5s ease-in-out infinite}
@keyframes pd{0%,100%{opacity:1}50%{opacity:0.3}}

/* ── RAIL ── */
.rail{
  background:var(--bg1);border-right:1px solid var(--border);
  display:flex;flex-direction:column;align-items:center;padding:12px 0;gap:4px;
  overflow:hidden;z-index:100;
}
.rail-btn{
  width:44px;height:44px;border-radius:10px;display:flex;flex-direction:column;
  align-items:center;justify-content:center;gap:2px;background:transparent;
  color:var(--text2);transition:all .2s;position:relative;
}
.rail-btn:hover{background:var(--bg-hover);color:var(--text1)}
.rail-btn.active{background:var(--bg-active);color:var(--accent)}
.rail-btn.active::before{content:'';position:absolute;left:0;top:50%;transform:translateY(-50%);width:3px;height:24px;background:var(--accent);border-radius:0 3px 3px 0}
.rail-icon{font-size:18px;line-height:1}
.rail-label{font-size:7px;font-weight:700;letter-spacing:0.06em;text-transform:uppercase}
.rail-spacer{flex:1}
.rail-divider{width:32px;height:1px;background:var(--border);margin:4px 0}

      /* ── WORKSPACE ── */
.workspace{background:var(--bg0);overflow:hidden;display:flex;flex-direction:column;margin-right:290px}

/* ══════════════════════════════════════════ WORKLIST */
.wl-wrap{display:grid;grid-template-rows:auto 1fr;height:100%;overflow:hidden}
.wl-toolbar{
  padding:12px 16px;background:var(--bg1);border-bottom:1px solid var(--border);
  display:flex;align-items:center;gap:10px;flex-wrap:wrap;
}
.wl-title{font-family:var(--font-h);font-size:20px;font-style:italic;color:var(--text0);margin-right:8px;white-space:nowrap}
.search-box{
  display:flex;align-items:center;gap:8px;background:var(--bg2);border:1px solid var(--border);
  border-radius:8px;padding:7px 12px;flex:1;min-width:180px;max-width:280px;
}
.search-box input{background:transparent;border:none;color:var(--text0);font-size:12px;width:100%}
.search-box input::placeholder{color:var(--text2)}
.filter-sel{
  background:var(--bg2);border:1px solid var(--border);color:var(--text1);
  border-radius:8px;padding:7px 10px;font-size:11px;font-family:var(--font-s);
}
.filter-sel:focus{border-color:var(--border2)}
.wl-stat{padding:5px 12px;border-radius:6px;font-size:10px;font-weight:700;letter-spacing:0.06em;border:1px solid;background:transparent}
.wl-stat.red{color:var(--urgent);border-color:var(--urgent);background:rgba(232,0,30,0.06)}
.wl-stat.amb{color:var(--warn);border-color:var(--warn);background:rgba(224,123,0,0.06)}
.wl-stat.grn{color:var(--ok);border-color:var(--ok);background:rgba(0,145,77,0.06)}

.table-wrap{overflow:auto;flex:1}
table{width:100%;border-collapse:collapse;font-size:11px}
thead th{
  padding:9px 12px;text-align:left;font-size:9px;font-weight:700;letter-spacing:0.1em;
  text-transform:uppercase;color:var(--text2);background:var(--bg1);
  border-bottom:1px solid var(--border);position:sticky;top:0;z-index:10;white-space:nowrap;
}
tbody tr{border-bottom:1px solid var(--border);cursor:pointer;transition:background .1s}
tbody tr:hover{background:var(--bg-hover)}
tbody tr.active-row{background:var(--bg-active)}
tbody td{padding:10px 12px;color:var(--text1);vertical-align:middle;white-space:nowrap}
tbody td.primary{color:var(--text0);font-weight:600}
.pri-badge{font-size:9px;padding:2px 7px;border-radius:10px;font-weight:700;letter-spacing:0.06em;font-family:var(--font-m)}
.pri-e{background:rgba(232,0,30,0.12);color:var(--urgent);border:1px solid var(--urgent)}
.pri-u{background:rgba(224,123,0,0.12);color:var(--warn);border:1px solid var(--warn)}
.pri-r{background:rgba(0,145,77,0.1);color:var(--ok);border:1px solid var(--ok)}
.mod-tag{font-size:9px;padding:2px 7px;border-radius:4px;font-family:var(--font-m);font-weight:700}
.m-CT{background:rgba(0,170,255,0.12);color:var(--accent)}
.m-MRI{background:rgba(0,212,170,0.12);color:var(--accent2)}
.m-XR{background:rgba(224,123,0,0.12);color:var(--warn)}
.m-US{background:rgba(123,97,255,0.12);color:#9b81ff}
.m-NM{background:rgba(255,97,200,0.12);color:#ff80d0}
.crit-flag{color:var(--urgent);font-size:14px;animation:cfp 1.5s ease-in-out infinite}
@keyframes cfp{0%,100%{opacity:1}50%{opacity:0.3}}
.rs-badge{font-size:9px;padding:2px 7px;border-radius:10px;font-family:var(--font-m)}
.rs-U{background:rgba(224,123,0,0.1);color:var(--warn)}
.rs-P{background:rgba(0,170,255,0.1);color:var(--accent)}
.rs-F{background:rgba(0,145,77,0.1);color:var(--ok)}
.rs-D{background:rgba(255,255,255,0.05);color:var(--text2)}
.empty-state{padding:60px;text-align:center;color:var(--text2)}
.empty-icon{font-size:40px;margin-bottom:12px;opacity:0.3}

/* ══════════════════════════════════════════ STUDY VIEWER */
.viewer-wrap{display:grid;grid-template-columns:200px 1fr 320px;height:100%;overflow:hidden;gap:0}
.series-panel{background:var(--bg1);border-right:1px solid var(--border);overflow-y:auto;padding:10px}
.series-title{font-size:9px;font-weight:700;letter-spacing:0.1em;color:var(--text2);text-transform:uppercase;margin-bottom:10px;padding-bottom:6px;border-bottom:1px solid var(--border)}
.series-item{
  padding:8px 10px;border-radius:6px;margin-bottom:4px;cursor:pointer;border:1px solid transparent;
  transition:all .15s;background:var(--bg2);
}
.series-item:hover{border-color:var(--border2);background:var(--bg3)}
.series-item.active{border-color:var(--accent);background:var(--bg-active)}
.series-num{font-size:9px;color:var(--text2);font-family:var(--font-m);margin-bottom:2px}
.series-desc{font-size:11px;color:var(--text0);font-weight:500}

.viewer-canvas{background:#000;position:relative;display:flex;align-items:center;justify-content:center;overflow:hidden}
.viewer-canvas::before{content:'';position:absolute;inset:0;background:radial-gradient(ellipse at center,#1a1a2a 0%,#000 70%)}
.dicom-img{
  position:relative;z-index:1;width:520px;height:520px;border-radius:4px;overflow:hidden;
  display:flex;align-items:center;justify-content:center;
}
.dicom-overlay-tl,.dicom-overlay-tr,.dicom-overlay-bl,.dicom-overlay-br{
  position:absolute;font-size:10px;color:rgba(255,255,0,0.85);font-family:var(--font-m);
  line-height:1.7;z-index:3;pointer-events:none;text-shadow:1px 1px 2px rgba(0,0,0,0.9);
}
.dicom-overlay-tl{top:10px;left:10px}
.dicom-overlay-tr{top:10px;right:10px;text-align:right}
.dicom-overlay-bl{bottom:10px;left:10px}
.dicom-overlay-br{bottom:10px;right:10px;text-align:right}
.viewer-controls{position:absolute;top:10px;left:50%;transform:translateX(-50%);z-index:10;display:flex;gap:6px}
.vc-btn{background:rgba(0,0,0,0.6);border:1px solid rgba(255,255,255,0.2);color:rgba(255,255,255,0.8);padding:6px 12px;border-radius:6px;font-size:10px;font-weight:600;letter-spacing:0.08em;transition:all .15s;backdrop-filter:blur(4px)}
.vc-btn:hover{background:rgba(0,170,255,0.3);border-color:var(--accent);color:white}
.vc-btn.on{background:rgba(0,170,255,0.4);border-color:var(--accent);color:white}
.wl-slider{position:absolute;bottom:20px;left:50%;transform:translateX(-50%);z-index:10;display:flex;gap:16px;background:rgba(0,0,0,0.6);padding:10px 20px;border-radius:10px;backdrop-filter:blur(4px)}
.slider-group{display:flex;flex-direction:column;align-items:center;gap:4px}
.slider-label{font-size:9px;color:rgba(255,255,255,0.5);letter-spacing:0.08em}
.slider-group input[type=range]{width:100px;accent-color:var(--accent)}

/* Modality-specific DICOM visuals */
.dicom-ct{background:radial-gradient(ellipse at center,#2a2a2a 0%,#111 60%,#000 100%)}
.dicom-mri{background:radial-gradient(ellipse at 40% 40%,#1a1a3a 0%,#080820 60%,#000 100%)}
.dicom-xr{background:radial-gradient(ellipse at center,#1a1a1a 0%,#050505 100%)}
.dicom-us{background:radial-gradient(ellipse at center,#0a1520 0%,#000 100%)}
.dicom-nm{background:radial-gradient(ellipse at center,#1a0a2a 0%,#050010 100%)}

/* SVG anatomy layers */
.anatomy-svg{position:absolute;inset:0;width:100%;height:100%;opacity:0.85;z-index:2}

.report-side{background:var(--bg1);border-left:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden}
.report-header{padding:10px 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
.rh-title{font-family:var(--font-h);font-size:15px;font-style:italic;color:var(--text0)}
.rep-fields{overflow-y:auto;flex:1}
.rep-section{padding:8px 14px;border-bottom:1px solid var(--border)}
.rep-section label{font-size:9px;font-weight:700;letter-spacing:0.1em;color:var(--text2);text-transform:uppercase;display:block;margin-bottom:5px}
.rep-textarea{
  width:100%;background:var(--bg2);border:1px solid var(--border);border-radius:6px;
  color:var(--text0);font-family:var(--font-m);font-size:11px;font-weight:300;
  line-height:1.6;padding:7px 10px;resize:vertical;transition:border-color .2s;min-height:52px;
}
.rep-textarea.findings{min-height:100px}
.rep-textarea.impression{min-height:80px}
.rep-textarea:focus{border-color:var(--border2)}
.rep-actions{padding:10px 14px;display:flex;flex-direction:column;gap:7px;flex-shrink:0;border-top:1px solid var(--border)}
.rep-btn{padding:9px 14px;border-radius:8px;font-size:11px;font-weight:700;letter-spacing:0.06em;transition:all .2s;display:flex;align-items:center;justify-content:center;gap:6px}
.rep-btn.primary{background:var(--nhs2);color:white;border:none}
.rep-btn.primary:hover{background:#003f9e;box-shadow:var(--glow)}
.rep-btn.secondary{background:transparent;color:var(--accent);border:1px solid var(--accent)}
.rep-btn.secondary:hover{background:var(--bg-hover)}
.dictate-row{display:flex;gap:6px}
.mic-btn{
  background:rgba(232,0,30,0.1);border:1px solid rgba(232,0,30,0.3);color:var(--urgent);
  padding:7px 10px;border-radius:6px;font-size:12px;transition:all .2s;flex-shrink:0;
}
.mic-btn.rec{background:rgba(232,0,30,0.25);animation:mpr 1s ease-in-out infinite;border-color:var(--urgent)}
@keyframes mpr{0%,100%{box-shadow:none}50%{box-shadow:var(--glow-r)}}
.ai-btn{background:rgba(0,212,170,0.08);border:1px solid rgba(0,212,170,0.3);color:var(--accent2);padding:8px 12px;border-radius:6px;font-size:11px;font-weight:700;letter-spacing:0.06em;transition:all .2s;width:100%}
.ai-btn:hover{background:rgba(0,212,170,0.18)}

/* ══════════════════════════════════════════ ARIA AVATAR */
.aria-panel{
  background:var(--bg1);border-left:1px solid var(--border);
  display:flex;flex-direction:column;overflow:hidden;min-width:0;
}
.aria-avatar-area{
  padding:16px 14px 12px;display:flex;flex-direction:column;align-items:center;
  border-bottom:1px solid var(--border);
  background:linear-gradient(180deg,var(--bg2) 0%,var(--bg1) 100%);
  position:relative;overflow:hidden;
}
.aria-avatar-area::before{
  content:'';position:absolute;inset:0;pointer-events:none;
  background:radial-gradient(ellipse at 50% 0%,rgba(0,170,255,0.07) 0%,transparent 65%);
}
/* ARIA SVG FACE */
.aria-face-wrap{
  position:relative;width:110px;height:130px;margin-bottom:8px;
}
.aria-face-wrap::after{
  content:'';position:absolute;bottom:-6px;left:50%;transform:translateX(-50%);
  width:80px;height:12px;background:radial-gradient(ellipse,rgba(0,100,200,0.25) 0%,transparent 70%);
  border-radius:50%;
}
.aria-face-svg{width:100%;height:100%;filter:drop-shadow(0 6px 20px rgba(0,80,200,0.35))}
.aria-name{font-family:var(--font-h);font-size:20px;font-style:italic;color:var(--text0);margin-bottom:1px;letter-spacing:0.02em}
.aria-sub{font-size:8px;color:var(--text2);letter-spacing:0.12em;margin-bottom:10px;text-align:center;text-transform:uppercase}

/* State indicator - prominent */
.aria-state-wrap{width:100%;margin-bottom:10px}
.aria-state{
  display:flex;align-items:center;justify-content:center;gap:6px;
  font-size:9px;font-weight:800;letter-spacing:0.14em;padding:5px 14px;border-radius:20px;
  border:1px solid var(--border2);color:var(--accent);background:rgba(0,170,255,0.08);
  text-transform:uppercase;transition:all .3s;
}
.aria-state.listening{color:var(--urgent);border-color:var(--urgent);background:rgba(232,0,30,0.1)}
.aria-state.speaking{color:var(--accent2);border-color:var(--accent2);background:rgba(0,212,170,0.1)}
.aria-state.thinking{color:#b090ff;border-color:#b090ff;background:rgba(160,120,255,0.1)}
.state-dot{width:6px;height:6px;border-radius:50%;background:currentColor;flex-shrink:0}
.aria-state.listening .state-dot{animation:mpr 0.7s ease-in-out infinite}
.aria-state.speaking .state-dot{animation:mpr 0.4s ease-in-out infinite}
.aria-state.thinking .state-dot{animation:mpr 1.2s ease-in-out infinite}

/* Waveform visualiser */
.aria-waveform{
  display:flex;align-items:center;justify-content:center;gap:3px;
  height:28px;width:100%;margin-bottom:8px;
}
.wave-bar{
  width:3px;border-radius:2px;background:var(--accent);opacity:0.5;
  transition:height .1s ease,opacity .1s ease;
  min-height:3px;
}
.aria-waveform.active .wave-bar{opacity:0.9}
.aria-waveform.thinking .wave-bar{background:#b090ff;animation:think-wave 1.2s ease-in-out infinite}
@keyframes think-wave{0%,100%{height:4px;opacity:0.3}50%{height:16px;opacity:0.8}}

/* Big talk button */
.talk-btn-wrap{width:100%;margin-bottom:8px}
.talk-btn{
  width:100%;padding:11px;border-radius:12px;
  font-size:12px;font-weight:800;letter-spacing:0.1em;text-transform:uppercase;
  display:flex;align-items:center;justify-content:center;gap:8px;
  transition:all .2s;border:2px solid;
}
.talk-btn.idle{
  background:rgba(232,0,30,0.08);border-color:rgba(232,0,30,0.4);color:var(--urgent);
}
.talk-btn.idle:hover{background:rgba(232,0,30,0.16);border-color:var(--urgent)}
.talk-btn.recording{
  background:rgba(232,0,30,0.2);border-color:var(--urgent);color:var(--urgent);
  animation:mpr 0.8s ease-in-out infinite;
}
.talk-btn-icon{font-size:16px}
.mute-btn{
  background:var(--bg3);border:1px solid var(--border);color:var(--text1);
  padding:7px 12px;border-radius:8px;font-size:10px;font-weight:700;letter-spacing:0.06em;
  transition:all .15s;flex:1;
}
.mute-btn.muted{color:var(--text2);opacity:0.6}
.voice-row{display:flex;gap:6px;width:100%;margin-bottom:8px}
.voice-sel{background:var(--bg2);border:1px solid var(--border);color:var(--text1);border-radius:6px;padding:5px 8px;font-size:10px;flex:1}

/* Captions */
.aria-captions{
  background:rgba(0,0,0,0.45);border-radius:10px;padding:12px 14px;
  font-size:13px;color:#c8e6ff;font-family:var(--font-m);font-weight:400;
  line-height:1.9;min-height:100px;border:1px solid rgba(0,170,255,0.2);width:100%;
  font-style:italic;height:220px;overflow-y:auto;word-wrap:break-word;word-break:break-word;
  letter-spacing:0.01em;
}
[data-theme="light"] .aria-captions{background:rgba(0,30,80,0.04);color:var(--text1)}
.aria-chat{flex:1;overflow-y:auto;padding:10px}
.aria-input-row{padding:8px 10px;border-top:1px solid var(--border);display:flex;gap:6px}
.aria-input{flex:1;background:var(--bg2);border:1px solid var(--border);border-radius:8px;padding:7px 10px;color:var(--text0);font-size:12px;font-family:var(--font-s)}
.aria-input:focus{border-color:var(--border2)}
.aria-input::placeholder{color:var(--text2)}
.aria-send{background:var(--nhs2);color:white;border-radius:8px;padding:7px 12px;font-size:11px;font-weight:700;transition:all .2s}
.aria-send:hover{background:#003f9e}
.msg{margin-bottom:10px;display:flex;flex-direction:column;gap:3px}
.msg-role{font-size:8px;font-weight:700;letter-spacing:0.1em;color:var(--text2);text-transform:uppercase}
.msg-body{font-size:11px;color:var(--text1);line-height:1.6;padding:8px 10px;border-radius:8px;background:var(--bg2);border:1px solid var(--border)}
.msg.aria .msg-body{background:var(--bg-active);border-color:var(--border2);color:var(--text0)}

/* ══════════════════════════════════════════ GENERATOR */
.gen-wrap{padding:24px;overflow-y:auto;height:100%}
.gen-title{font-family:var(--font-h);font-size:26px;font-style:italic;color:var(--text0);margin-bottom:6px}
.gen-sub{font-size:12px;color:var(--text2);margin-bottom:28px}
.gen-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px;max-width:800px}
.gen-card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--card-r);padding:20px}
.gen-card-title{font-size:11px;font-weight:700;letter-spacing:0.1em;color:var(--text2);text-transform:uppercase;margin-bottom:16px}
.slider-wrap{margin-bottom:16px}
.slider-wrap label{font-size:11px;color:var(--text1);display:flex;justify-content:space-between;margin-bottom:6px}
.slider-wrap label span{font-family:var(--font-m);color:var(--accent);font-weight:500}
.slider-wrap input{width:100%;accent-color:var(--accent)}
.gen-btn{
  background:linear-gradient(135deg,var(--nhs),var(--nhs2));color:white;
  padding:14px 28px;border-radius:10px;font-size:13px;font-weight:700;letter-spacing:0.08em;
  box-shadow:0 4px 16px rgba(0,48,135,0.3);transition:all .2s;
}
.gen-btn:hover{transform:translateY(-2px);box-shadow:0 8px 24px rgba(0,48,135,0.4)}
.gen-result{
  margin-top:20px;background:var(--bg2);border:1px solid var(--border);border-radius:var(--card-r);
  padding:20px;max-width:800px;
}
.gen-result-title{font-family:var(--font-h);font-size:18px;font-style:italic;color:var(--ok);margin-bottom:8px}
.gen-stat-row{display:flex;gap:24px;flex-wrap:wrap}
.gen-stat{text-align:center}
.gen-stat-n{font-family:var(--font-h);font-size:32px;font-style:italic;color:var(--accent)}
.gen-stat-l{font-size:10px;color:var(--text2);letter-spacing:0.08em;text-transform:uppercase}

/* ══════════════════════════════════════════ IMPORT/EXPORT */
.ie-wrap{padding:24px;overflow-y:auto;height:100%;max-width:900px}
.ie-title{font-family:var(--font-h);font-size:26px;font-style:italic;color:var(--text0);margin-bottom:24px}
.ie-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px}
.ie-card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--card-r);padding:20px}
.ie-card-title{font-size:11px;font-weight:700;letter-spacing:0.1em;color:var(--text2);text-transform:uppercase;margin-bottom:16px;display:flex;align-items:center;gap:6px}
.drop-zone{
  border:2px dashed var(--border2);border-radius:8px;padding:32px;text-align:center;
  cursor:pointer;transition:all .2s;margin-bottom:12px;
}
.drop-zone:hover{border-color:var(--accent);background:var(--bg-hover)}
.drop-zone-icon{font-size:28px;margin-bottom:8px;opacity:0.5}
.drop-zone-text{font-size:12px;color:var(--text2)}
.ie-btn{padding:10px 20px;border-radius:8px;font-size:11px;font-weight:700;letter-spacing:0.06em;transition:all .2s;width:100%;margin-bottom:8px}
.ie-btn.export{background:var(--nhs2);color:white;border:none}
.ie-btn.export:hover{background:#003f9e}
.ie-btn.export-csv{background:transparent;color:var(--accent2);border:1px solid var(--accent2)}
.ie-result{font-size:12px;color:var(--ok);margin-top:10px;font-family:var(--font-m);padding:8px;background:rgba(0,145,77,0.08);border-radius:6px;border:1px solid rgba(0,145,77,0.2)}

/* ══════════════════════════════════════════ ANALYTICS */
.analytics-wrap{padding:20px 24px;overflow-y:auto;height:100%;max-width:960px}
.a-title{font-family:var(--font-h);font-size:24px;font-style:italic;color:var(--text0);margin-bottom:4px}
.a-subtitle{font-size:11px;color:var(--text2);margin-bottom:20px;letter-spacing:0.04em}
.a-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:16px}
.a-card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--card-r);padding:16px 18px;position:relative;overflow:hidden}
.a-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px}
.a-card.blue::before{background:var(--accent)}
.a-card.red::before{background:var(--urgent)}
.a-card.green::before{background:var(--ok)}
.a-card.amber::before{background:var(--warn)}
.a-card.purple::before{background:#9b81ff}
.a-n{font-family:var(--font-h);font-size:38px;font-style:italic;color:var(--text0);line-height:1;margin-bottom:2px}
.a-l{font-size:9px;color:var(--text2);letter-spacing:0.1em;text-transform:uppercase;margin-bottom:4px}
.a-sub{font-size:10px;color:var(--text2);margin-top:4px}
.a-pct{font-size:11px;font-weight:700;margin-top:2px}
.a-section-title{font-size:10px;font-weight:700;letter-spacing:0.1em;color:var(--text2);text-transform:uppercase;margin:16px 0 10px}
.a-mod-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;margin-bottom:16px}
.a-mod-card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--card-r);padding:14px 10px;text-align:center}
.a-mod-n{font-family:var(--font-h);font-size:26px;font-style:italic}
.a-mod-l{font-size:9px;color:var(--text2);letter-spacing:0.08em;margin-top:2px;text-transform:uppercase}
.a-mod-pct{font-size:10px;color:var(--text2);margin-top:2px}
.a-two-col{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.bar-chart{background:var(--bg2);border:1px solid var(--border);border-radius:var(--card-r);padding:16px}
.bar-chart-title{font-size:10px;font-weight:700;letter-spacing:0.1em;color:var(--text2);text-transform:uppercase;margin-bottom:14px}
.bar-row{display:flex;align-items:center;gap:10px;margin-bottom:8px}
.bar-label{font-size:10px;color:var(--text1);width:80px;font-family:var(--font-m);flex-shrink:0}
.bar-track{flex:1;height:6px;background:var(--bg3);border-radius:4px;overflow:hidden}
.bar-fill{height:100%;border-radius:4px;transition:width 1s ease}
.bar-val{font-size:10px;color:var(--text2);width:28px;text-align:right;font-family:var(--font-m)}
.report-status-chart{background:var(--bg2);border:1px solid var(--border);border-radius:var(--card-r);padding:16px}
.rs-row{display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)}
.rs-row:last-child{border-bottom:none}
.rs-label{font-size:11px;color:var(--text1);display:flex;align-items:center;gap:8px}
.rs-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.rs-nums{display:flex;align-items:center;gap:12px}
.rs-count{font-family:var(--font-m);font-size:13px;font-weight:600;color:var(--text0)}
.rs-pct-bar{width:80px;height:4px;background:var(--bg3);border-radius:2px;overflow:hidden}
.rs-pct-fill{height:100%;border-radius:2px}

/* ══════════════════════════════════════════ PATIENT BANNER (patient loaded) */
.patient-banner{
  background:var(--bg1);border-bottom:1px solid var(--border);
  padding:8px 16px;display:flex;align-items:center;gap:0;font-size:11px;
}
.pb-field{padding:0 14px;border-right:1px solid var(--border);display:flex;flex-direction:column;gap:1px}
.pb-field:first-child{padding-left:0}
.pb-field:last-child{border-right:none}
.pb-l{font-size:8px;color:var(--text2);letter-spacing:0.1em;text-transform:uppercase}
.pb-v{color:var(--text0);font-weight:600;font-family:var(--font-m);font-size:12px}
.pb-alert{background:rgba(224,123,0,0.1);border:1px solid rgba(224,123,0,0.3);color:var(--warn);padding:3px 8px;border-radius:4px;font-size:9px;font-weight:700;letter-spacing:0.06em}
.pb-critical{background:rgba(232,0,30,0.1);border:1px solid rgba(232,0,30,0.3);color:var(--urgent);padding:3px 8px;border-radius:4px;font-size:9px;font-weight:700;letter-spacing:0.06em;animation:cfp 1.5s ease-in-out infinite}

/* ══════════════════════════════════════════ MISC */
.section-hdr{font-family:var(--font-h);font-size:14px;font-style:italic;color:var(--text0);margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid var(--border)}
.loading{padding:40px;text-align:center;color:var(--text2);font-size:12px}
.loading::after{content:'...';animation:dots 1.5s infinite}
@keyframes dots{0%{content:''}33%{content:'.'}66%{content:'..'}100%{content:'...'}}
@keyframes fiu{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
.fi{animation:fiu .3s ease both}

/* ══════════════════════════════════════════ NO STUDY */
.no-study{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;color:var(--text2)}
.no-study-icon{font-size:48px;margin-bottom:16px;opacity:0.2}
.no-study-text{font-family:var(--font-h);font-size:20px;font-style:italic;margin-bottom:8px;opacity:0.4}
.no-study-sub{font-size:12px;opacity:0.3}

/* Notifications */
.notif{
  position:fixed;bottom:24px;right:24px;z-index:9999;
  background:var(--bg2);border:1px solid var(--border2);border-radius:10px;
  padding:14px 18px;box-shadow:var(--shadow2);font-size:12px;color:var(--text0);
  animation:notif-in .3s ease both;max-width:320px;
}
.notif.ok{border-color:var(--ok);background:rgba(0,145,77,0.1)}
.notif.err{border-color:var(--urgent);background:rgba(232,0,30,0.1)}
@keyframes notif-in{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
.ai-impression-panel{background:rgba(0,20,40,0.95);border:1px solid rgba(0,212,170,0.4);border-radius:10px;padding:16px;margin-bottom:10px;position:relative;min-height:120px;box-shadow:0 0 20px rgba(0,212,170,0.15)}
.ai-impression-panel::before{content:"◈ AI IMPRESSION";position:absolute;top:-10px;left:12px;background:var(--bg0);padding:0 8px;font-size:9px;font-weight:900;letter-spacing:0.2em;color:#00d4aa}
.ai-impression-text{font-family:"Courier New",monospace;font-size:13px;line-height:1.7;color:#e0fff8;white-space:pre-wrap;min-height:80px}
.ai-impression-text.empty{color:rgba(0,212,170,0.3);font-style:italic}
.ai-impression-meta{display:flex;align-items:center;gap:8px;margin-top:10px;padding-top:8px;border-top:1px solid rgba(0,212,170,0.2)}
.ai-impression-badge{background:rgba(0,212,170,0.12);border:1px solid rgba(0,212,170,0.3);color:#00d4aa;padding:2px 8px;border-radius:20px;font-size:9px;font-weight:700;letter-spacing:0.1em}
.ai-speak-btn{background:rgba(0,212,170,0.1);border:1px solid rgba(0,212,170,0.3);color:#00d4aa;padding:3px 10px;border-radius:20px;font-size:9px;font-weight:700;cursor:pointer}

/* ══════════════════════════════════════════ REPORTS */
.reports-wrap{display:grid;grid-template-columns:340px 1fr;height:100%;overflow:hidden}
.reports-list{background:var(--bg1);border-right:1px solid var(--border);overflow-y:auto;display:flex;flex-direction:column}
.reports-list-header{padding:14px 16px;border-bottom:1px solid var(--border);flex-shrink:0}
.reports-list-title{font-family:var(--font-h);font-size:20px;font-style:italic;color:var(--text0)}
.reports-list-sub{font-size:10px;color:var(--text2);letter-spacing:0.06em;margin-top:2px}
.report-card{padding:14px 16px;border-bottom:1px solid var(--border);cursor:pointer;transition:background .15s;position:relative}
.report-card:hover{background:var(--bg-hover)}
.report-card.active{background:var(--bg-active);border-left:3px solid var(--accent)}
.rc-patient{font-size:13px;font-weight:700;color:var(--text0);margin-bottom:3px}
.rc-meta{font-size:10px;color:var(--text2);font-family:var(--font-m);margin-bottom:4px}
.rc-impression{font-size:10px;color:var(--text1);line-height:1.5;overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical}
.rc-badges{display:flex;gap:6px;margin-top:6px;flex-wrap:wrap}
.report-detail{background:var(--bg0);overflow-y:auto;padding:0}
.rd-header{background:var(--bg1);padding:20px 28px;border-bottom:1px solid var(--border);position:sticky;top:0;z-index:10}
.rd-patient-name{font-family:var(--font-h);font-size:28px;font-style:italic;color:var(--text0);margin-bottom:4px}
.rd-meta-row{display:flex;gap:20px;flex-wrap:wrap;margin-bottom:12px}
.rd-meta-field{display:flex;flex-direction:column;gap:1px}
.rd-meta-label{font-size:8px;color:var(--text2);letter-spacing:0.1em;text-transform:uppercase}
.rd-meta-value{font-size:12px;color:var(--text0);font-family:var(--font-m);font-weight:600}
.rd-signed-banner{display:flex;align-items:center;gap:10px;background:rgba(0,145,77,0.1);border:1px solid rgba(0,145,77,0.3);border-radius:8px;padding:10px 16px}
.rd-signed-icon{font-size:20px}
.rd-signed-text{font-size:11px;color:var(--ok);font-weight:700;letter-spacing:0.06em}
.rd-signed-sub{font-size:10px;color:var(--text2);margin-top:1px}
.rd-body{padding:24px 28px}
.rd-section{margin-bottom:24px}
.rd-section-label{font-size:9px;font-weight:900;letter-spacing:0.2em;color:var(--text2);text-transform:uppercase;margin-bottom:8px;padding-bottom:6px;border-bottom:1px solid var(--border)}
.rd-section-text{font-family:var(--font-m);font-size:12px;color:var(--text1);line-height:1.8;white-space:pre-wrap}
.rd-ai-section{background:rgba(0,20,40,0.8);border:1px solid rgba(0,212,170,0.35);border-radius:10px;padding:18px;margin-bottom:24px;position:relative}
.rd-ai-section::before{content:"◈ AI ASSISTED IMPRESSION";position:absolute;top:-10px;left:14px;background:var(--bg0);padding:0 8px;font-size:9px;font-weight:900;letter-spacing:0.2em;color:#00d4aa}
.rd-ai-text{font-family:'Courier New',monospace;font-size:13px;line-height:1.9;color:#e0fff8}
.rd-ai-footer{display:flex;align-items:center;gap:8px;margin-top:12px;padding-top:10px;border-top:1px solid rgba(0,212,170,0.2)}
.rd-print-btn{background:var(--nhs2);color:white;padding:10px 20px;border-radius:8px;font-size:11px;font-weight:700;letter-spacing:0.08em;transition:all .2s;border:none}
.rd-print-btn:hover{background:#003f9e}
.rd-speak-btn{background:rgba(0,212,170,0.1);border:1px solid rgba(0,212,170,0.3);color:#00d4aa;padding:10px 16px;border-radius:8px;font-size:11px;font-weight:700;cursor:pointer}
.no-reports{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;color:var(--text2)}
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const {useState,useEffect,useRef,useCallback} = React;
const API = '';

// ─── UTILITIES ────────────────────────────────────────────────────
const age = dob => { const b=new Date(dob),n=new Date(); return Math.floor((n-b)/31557600000); };
const fmt = d => d ? new Date(d).toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric',hour:'2-digit',minute:'2-digit'}) : '—';
const fmtDate = d => d ? new Date(d).toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric'}) : '—';

// ─── ARIA AVATAR (cute friendly lion) ────────────────────────────
function AriaFace({state}) {
  const [blink,setBlink] = React.useState(false);
  const [mouthOpen,setMouthOpen] = React.useState(0);
  const [headTilt,setHeadTilt] = React.useState(0);

  React.useEffect(()=>{
    const bi = setInterval(()=>{
      setBlink(true);
      setTimeout(()=>setBlink(false), 110);
    }, 3000+Math.random()*2000);
    return ()=>clearInterval(bi);
  },[]);

  React.useEffect(()=>{
    let iv;
    if(state==='speaking'){
      const pattern=[0.7,0.2,0.9,0.1,0.6,0.3,0.8,0.05,0.5,0.7,0.15,0.95,0.1,0.6];
      let p=0;
      iv=setInterval(()=>{ p++; setMouthOpen(pattern[p%pattern.length]*0.8); setHeadTilt((Math.random()-0.5)*2); },100);
    } else if(state==='listening'){
      iv=setInterval(()=>{ setHeadTilt((Math.random()-0.5)*1.5); },350);
      setMouthOpen(0.08);
    } else if(state==='thinking'){
      iv=setInterval(()=>{ setHeadTilt((Math.random()-0.5)*1); },500);
    } else { setMouthOpen(0); setHeadTilt(0); }
    return ()=>clearInterval(iv);
  },[state]);

  const eyeH = blink ? 1 : 6;
  const mouthY = 72;
  const mouthD = mouthOpen * 10;

  return (
    <svg className="aria-face-svg" viewBox="0 0 100 120" xmlns="http://www.w3.org/2000/svg"
         style={{transform:`rotate(${headTilt}deg)`,transition:'transform 0.12s ease'}}>
      <defs>
        <radialGradient id="mane" cx="50%" cy="50%" r="50%">
          <stop offset="0%" stopColor="#e8a020"/>
          <stop offset="60%" stopColor="#c07010"/>
          <stop offset="100%" stopColor="#8a4a00"/>
        </radialGradient>
        <radialGradient id="face" cx="50%" cy="40%" r="55%">
          <stop offset="0%" stopColor="#ffd080"/>
          <stop offset="70%" stopColor="#f0a840"/>
          <stop offset="100%" stopColor="#d08020"/>
        </radialGradient>
        <radialGradient id="muzzle" cx="50%" cy="40%" r="55%">
          <stop offset="0%" stopColor="#fff0d0"/>
          <stop offset="100%" stopColor="#f8d890"/>
        </radialGradient>
        <radialGradient id="nose" cx="50%" cy="35%" r="55%">
          <stop offset="0%" stopColor="#e06080"/>
          <stop offset="100%" stopColor="#b03050"/>
        </radialGradient>
        <linearGradient id="uniform2" x1="0" y1="0" x2="0" y2="1">
          <stop offset="0%" stopColor="#003e9e"/>
          <stop offset="100%" stopColor="#001555"/>
        </linearGradient>
        <filter id="fs"><feGaussianBlur stdDeviation="0.6"/></filter>
        <filter id="fm"><feGaussianBlur stdDeviation="1.2"/></filter>
      </defs>

      {/* NHS Uniform */}
      <path d="M10 120 Q25 105 50 110 Q75 105 90 120 L100 120 L0 120 Z" fill="url(#uniform2)"/>
      <path d="M44 110 L50 117 L56 110 Q53 112 50 113 Q47 112 44 110Z" fill="white" opacity="0.85"/>

      {/* Mane - big fluffy circle */}
      <circle cx="50" cy="54" r="36" fill="url(#mane)"/>
      {/* Mane texture - overlapping petals */}
      {Array.from({length:12}).map((_,i)=>{
        const angle = (i/12)*Math.PI*2;
        const x = 50 + Math.cos(angle)*30;
        const y = 54 + Math.sin(angle)*30;
        return <ellipse key={i} cx={x} cy={y} rx="10" ry="7"
          fill="#c07010" opacity="0.5"
          transform={`rotate(${i*30} ${x} ${y})`}/>;
      })}
      {/* Mane highlight */}
      <circle cx="50" cy="54" r="36" fill="none" stroke="#f0c050" strokeWidth="1" opacity="0.2"/>

      {/* Face */}
      <circle cx="50" cy="54" r="26" fill="url(#face)"/>

      {/* Ears */}
      <ellipse cx="26" cy="28" rx="9" ry="10" fill="url(#mane)"/>
      <ellipse cx="26" cy="28" rx="5" ry="6" fill="#f0a840"/>
      <ellipse cx="74" cy="28" rx="9" ry="10" fill="url(#mane)"/>
      <ellipse cx="74" cy="28" rx="5" ry="6" fill="#f0a840"/>

      {/* Eyebrows - expressive */}
      <path d="M32 42 Q38 38 44 40" stroke="#8a4a00" strokeWidth="2" fill="none" strokeLinecap="round"/>
      <path d="M56 40 Q62 38 68 42" stroke="#8a4a00" strokeWidth="2" fill="none" strokeLinecap="round"/>

      {/* Eyes whites */}
      <ellipse cx="38" cy="50" rx="8" ry={eyeH} fill="white"/>
      <ellipse cx="62" cy="50" rx="8" ry={eyeH} fill="white"/>

      {!blink && <>
        {/* Iris - warm amber */}
        <ellipse cx="38" cy="50" rx="5.5" ry="5.5" fill="#c07820"/>
        <ellipse cx="62" cy="50" rx="5.5" ry="5.5" fill="#c07820"/>
        {/* Inner iris */}
        <ellipse cx="38" cy="50" rx="4" ry="4" fill="#a05810"/>
        <ellipse cx="62" cy="50" rx="4" ry="4" fill="#a05810"/>
        {/* Pupils */}
        <ellipse cx="38" cy="50" rx="2.8" ry="2.8" fill="#0a0808"/>
        <ellipse cx="62" cy="50" rx="2.8" ry="2.8" fill="#0a0808"/>
        {/* Catchlights */}
        <ellipse cx="36" cy="48" rx="1.5" ry="1.3" fill="white" opacity="0.95"/>
        <ellipse cx="60" cy="48" rx="1.5" ry="1.3" fill="white" opacity="0.95"/>
        <ellipse cx="40" cy="52" rx="0.8" ry="0.7" fill="white" opacity="0.4"/>
        <ellipse cx="64" cy="52" rx="0.8" ry="0.7" fill="white" opacity="0.4"/>
      </>}

      {/* Muzzle */}
      <ellipse cx="50" cy="68" rx="16" ry="12" fill="url(#muzzle)"/>

      {/* Nose */}
      <ellipse cx="50" cy="62" rx="6" ry="4" fill="url(#nose)"/>
      <ellipse cx="48.5" cy="61" rx="1.5" ry="1" fill="white" opacity="0.5"/>

      {/* Whiskers */}
      <line x1="20" y1="65" x2="34" y2="67" stroke="#8a6020" strokeWidth="0.8" opacity="0.6"/>
      <line x1="20" y1="69" x2="34" y2="69" stroke="#8a6020" strokeWidth="0.8" opacity="0.6"/>
      <line x1="20" y1="73" x2="34" y2="71" stroke="#8a6020" strokeWidth="0.8" opacity="0.6"/>
      <line x1="80" y1="65" x2="66" y2="67" stroke="#8a6020" strokeWidth="0.8" opacity="0.6"/>
      <line x1="80" y1="69" x2="66" y2="69" stroke="#8a6020" strokeWidth="0.8" opacity="0.6"/>
      <line x1="80" y1="73" x2="66" y2="71" stroke="#8a6020" strokeWidth="0.8" opacity="0.6"/>

      {/* Mouth */}
      <path d={`M44 ${mouthY} Q50 ${mouthY+mouthD+3} 56 ${mouthY}`} stroke="#8a3020" strokeWidth="1.5" fill="none" strokeLinecap="round"/>
      <path d="M50 66 L50 72" stroke="#8a3020" strokeWidth="1" strokeLinecap="round"/>
      {mouthOpen > 0.08 && <>
        <ellipse cx="50" cy={mouthY+mouthD*0.4+1} rx="9" ry={mouthD*0.5+1} fill="#3a0808"/>
        <rect x="44" y={mouthY+0.5} width="12" height={Math.min(mouthD*0.35,4)} rx="1" fill="white" opacity="0.9"/>
      </>}

      {/* Cheek spots */}
      <ellipse cx="30" cy="62" rx="5" ry="3.5" fill="#e08030" opacity="0.18" filter="url(#fm)"/>
      <ellipse cx="70" cy="62" rx="5" ry="3.5" fill="#e08030" opacity="0.18" filter="url(#fm)"/>

      {/* State rings */}
      {state==='speaking' && <>
        <circle cx="50" cy="54" r="38" fill="none" stroke="#00d4aa" strokeWidth="1.5" opacity="0.25" strokeDasharray="3 5">
          <animateTransform attributeName="transform" type="rotate" from="0 50 54" to="360 50 54" dur="4s" repeatCount="indefinite"/>
        </circle>
      </>}
      {state==='listening' && <circle cx="50" cy="54" r="38" fill="none" stroke="#e8001e" strokeWidth="1.5" opacity="0.25">
        <animate attributeName="r" values="38;42;38" dur="0.9s" repeatCount="indefinite"/>
        <animate attributeName="opacity" values="0.25;0.06;0.25" dur="0.9s" repeatCount="indefinite"/>
      </circle>}
      {state==='thinking' && <>
        <circle cx="50" cy="54" r="38" fill="none" stroke="#b090ff" strokeWidth="1" opacity="0.2" strokeDasharray="6 4">
          <animateTransform attributeName="transform" type="rotate" from="0 50 54" to="360 50 54" dur="3s" repeatCount="indefinite"/>
        </circle>
        {[0,1,2].map(i=>(
          <circle key={i} cx={44+i*6} cy="14" r="2.2" fill="#b090ff" opacity="0.6">
            <animate attributeName="cy" values="14;9;14" dur="1s" begin={`${i*0.22}s`} repeatCount="indefinite"/>
            <animate attributeName="opacity" values="0.3;0.9;0.3" dur="1s" begin={`${i*0.22}s`} repeatCount="indefinite"/>
          </circle>
        ))}
      </>}
    </svg>
  );
}

// ─── DICOM VIEWER (modality-specific SVG anatomy) ─────────────────
function DicomViewer({study, series, selectedSeries}) {
  const mod = study?.modality || 'CT';
  const body = study?.body_part || 'Chest';

  const AnatomySVG = () => {
    if (mod==='CT' && (body==='Head' || body==='Brain')) return (
      <svg className="anatomy-svg" viewBox="0 0 520 520" xmlns="http://www.w3.org/2000/svg">
        <defs><radialGradient id="ctbrain" cx="50%" cy="50%" r="50%"><stop offset="0%" stopColor="#444"/><stop offset="70%" stopColor="#222"/><stop offset="100%" stopColor="#000"/></radialGradient></defs>
        <rect width="520" height="520" fill="#0a0a0a"/>
        <ellipse cx="260" cy="250" rx="180" ry="200" fill="#222" stroke="#555" strokeWidth="3"/>
        <ellipse cx="260" cy="250" rx="160" ry="180" fill="#333" stroke="#444" strokeWidth="1.5"/>
        <path d="M260 80 Q280 150 260 250 Q240 150 260 80" fill="#3a3a3a" stroke="#555" strokeWidth="1"/>
        <path d="M100 250 Q180 230 260 250 Q180 270 100 250" fill="none" stroke="#555" strokeWidth="1"/>
        <path d="M260 250 Q340 230 420 250 Q340 270 260 250" fill="none" stroke="#555" strokeWidth="1"/>
        <ellipse cx="200" cy="230" rx="25" ry="20" fill="#2a2a2a" stroke="#666" strokeWidth="1" opacity="0.8"/>
        <ellipse cx="320" cy="230" rx="25" ry="20" fill="#2a2a2a" stroke="#666" strokeWidth="1" opacity="0.8"/>
        <ellipse cx="260" cy="300" rx="40" ry="30" fill="#1a1a1a" stroke="#444" strokeWidth="1.5"/>
        <ellipse cx="260" cy="200" rx="20" ry="15" fill="#333" stroke="#555" strokeWidth="1"/>
        <path d="M200 120 Q230 110 260 108 Q290 110 320 120" fill="none" stroke="#444" strokeWidth="2" opacity="0.5"/>
      </svg>
    );
    if (mod==='CT' && body==='Chest') return (
      <svg className="anatomy-svg" viewBox="0 0 520 520" xmlns="http://www.w3.org/2000/svg">
        <rect width="520" height="520" fill="#080808"/>
        {/* Ribs */}
        {[0,1,2,3,4,5,6,7].map(i=><ellipse key={i} cx="260" cy={160+i*22} rx={120-i*6} ry="10" fill="none" stroke="#888" strokeWidth="2" opacity="0.6"/>)}
        {/* Lung fields */}
        <ellipse cx="185" cy="270" rx="80" ry="110" fill="#1a1a2a" stroke="#445" strokeWidth="1" opacity="0.7"/>
        <ellipse cx="335" cy="270" rx="80" ry="110" fill="#1a1a2a" stroke="#445" strokeWidth="1" opacity="0.7"/>
        {/* Lung markings */}
        {[0,1,2,3].map(i=><path key={i} d={`M185 ${180+i*30} Q${160+i*8} ${200+i*30} ${185} ${220+i*30}`} fill="none" stroke="#334" strokeWidth="1"/>)}
        {/* Mediastinum */}
        <rect x="230" y="150" width="60" height="160" fill="#222" stroke="#555" strokeWidth="1" rx="10"/>
        {/* Heart */}
        <ellipse cx="248" cy="310" rx="50" ry="60" fill="#2a1a1a" stroke="#664" strokeWidth="2"/>
        {/* Spine */}
        <rect x="245" y="140" width="30" height="220" fill="#666" stroke="#888" strokeWidth="1" rx="4" opacity="0.4"/>
        {[0,1,2,3,4,5,6,7,8,9].map(i=><rect key={i} x="243" y={148+i*22} width="34" height="16" fill="#555" stroke="#777" strokeWidth="1" rx="2"/>)}
      </svg>
    );
    if (mod==='MRI') return (
      <svg className="anatomy-svg" viewBox="0 0 520 520" xmlns="http://www.w3.org/2000/svg">
        <rect width="520" height="520" fill="#050510"/>
        <ellipse cx="260" cy="260" rx="195" ry="210" fill="#0a0a20" stroke="#334" strokeWidth="2"/>
        <ellipse cx="260" cy="260" rx="170" ry="185" fill="#12122a" stroke="#446" strokeWidth="1.5"/>
        {/* White matter bands */}
        {[0,1,2,3,4].map(i=><ellipse key={i} cx="260" cy="250" rx={80+i*22} ry={80+i*20} fill="none" stroke={`rgba(100,120,220,${0.15-i*0.02})`} strokeWidth={4-i*0.5}/>)}
        <path d="M260 80 L260 430" stroke="rgba(150,160,255,0.2)" strokeWidth="2"/>
        <path d="M90 260 L430 260" stroke="rgba(150,160,255,0.2)" strokeWidth="2"/>
        <ellipse cx="210" cy="240" rx="35" ry="30" fill="#1a1a3a" stroke="#558" strokeWidth="1"/>
        <ellipse cx="310" cy="240" rx="35" ry="30" fill="#1a1a3a" stroke="#558" strokeWidth="1"/>
        <ellipse cx="260" cy="310" rx="55" ry="40" fill="#0e0e28" stroke="#446" strokeWidth="2"/>
        <ellipse cx="260" cy="200" rx="28" ry="22" fill="#181838" stroke="#557" strokeWidth="1"/>
      </svg>
    );
    if (mod==='XR') return (
      <svg className="anatomy-svg" viewBox="0 0 520 520" xmlns="http://www.w3.org/2000/svg">
        <rect width="520" height="520" fill="#050505"/>
        {/* Chest X-ray style */}
        <ellipse cx="185" cy="250" rx="100" ry="130" fill="#e8e8e8" opacity="0.08" stroke="#aaa" strokeWidth="1"/>
        <ellipse cx="335" cy="250" rx="100" ry="130" fill="#e8e8e8" opacity="0.08" stroke="#aaa" strokeWidth="1"/>
        {/* Lung markings */}
        {[0,1,2,3,4,5,6].map(i=><line key={i} x1="130" y1={160+i*25} x2={230-i*5} y2={145+i*25} stroke="#999" strokeWidth="0.5" opacity="0.5"/>)}
        {[0,1,2,3,4,5,6].map(i=><line key={i} x1="390" y1={160+i*25} x2={290+i*5} y2={145+i*25} stroke="#999" strokeWidth="0.5" opacity="0.5"/>)}
        {/* Ribs */}
        {[0,1,2,3,4,5].map(i=><path key={i} d={`M ${110+i*10} ${140+i*25} Q 200 ${115+i*20} 260 ${125+i*22} Q 320 ${115+i*20} ${410-i*10} ${140+i*25}`} fill="none" stroke="#ddd" strokeWidth="1.5" opacity={0.5-i*0.06}/>)}
        {/* Heart */}
        <ellipse cx="245" cy="310" rx="65" ry="75" fill="#ccc" opacity="0.12" stroke="#bbb" strokeWidth="1.5"/>
        {/* Trachea */}
        <rect x="252" y="80" width="16" height="100" fill="#ccc" opacity="0.15" rx="8"/>
        {/* Spine */}
        {[0,1,2,3,4,5,6,7,8,9,10].map(i=><rect key={i} x="250" y={100+i*30} width="20" height="24" fill="#eee" opacity="0.25" rx="2"/>)}
        {/* Hila */}
        <ellipse cx="210" cy="230" rx="18" ry="25" fill="#ccc" opacity="0.2" stroke="#999" strokeWidth="1"/>
        <ellipse cx="310" cy="230" rx="18" ry="25" fill="#ccc" opacity="0.2" stroke="#999" strokeWidth="1"/>
        {/* Costophrenic angles */}
        <path d="M90 380 Q130 390 185 385" fill="none" stroke="#aaa" strokeWidth="2"/>
        <path d="M430 380 Q390 390 335 385" fill="none" stroke="#aaa" strokeWidth="2"/>
      </svg>
    );
    if (mod==='US') return (
      <svg className="anatomy-svg" viewBox="0 0 520 520" xmlns="http://www.w3.org/2000/svg">
        <rect width="520" height="520" fill="#020810"/>
        {/* Ultrasound sector shape */}
        <path d="M260 60 L80 440 Q260 480 440 440 Z" fill="#0a1020" stroke="#1a2840" strokeWidth="2"/>
        {/* Ultrasound lines */}
        {[0,1,2,3,4,5,6,7,8,9,10,11,12].map(i=>{const a=-50+i*8; const r=a*Math.PI/180; return <line key={i} x1="260" y1="60" x2={260+380*Math.sin(r)} y2={60+380*Math.cos(r)} stroke="rgba(0,150,255,0.05)" strokeWidth="1"/>;})}
        {/* Depth markers */}
        {[1,2,3,4,5].map(i=><text key={i} x="90" y={100+i*70} fill="rgba(255,255,0,0.4)" fontSize="9" fontFamily="monospace">{i}cm</text>)}
        {/* Liver parenchyma */}
        <ellipse cx="260" cy="280" rx="130" ry="90" fill="#1e2c3a" stroke="#2a4060" strokeWidth="1.5" opacity="0.8"/>
        {/* Kidney */}
        <ellipse cx="360" cy="300" rx="30" ry="45" fill="#162030" stroke="#2a3a50" strokeWidth="1.5" opacity="0.7"/>
        <ellipse cx="360" cy="300" rx="15" ry="28" fill="#0e1828" stroke="#1a2a40" strokeWidth="1"/>
        {/* Portal vein */}
        <path d="M180 260 Q260 250 340 260" fill="none" stroke="#005580" strokeWidth="4" opacity="0.6"/>
        {/* Speckle */}
        {Array.from({length:80}).map((_,i)=><circle key={i} cx={120+Math.random()*280} cy={120+Math.random()*280} r="0.8" fill="rgba(200,220,255,0.15)"/>)}
      </svg>
    );
    // NM / default
    return (
      <svg className="anatomy-svg" viewBox="0 0 520 520" xmlns="http://www.w3.org/2000/svg">
        <rect width="520" height="520" fill="#050008"/>
        <ellipse cx="260" cy="260" rx="180" ry="200" fill="#0a0015" stroke="#2a1040" strokeWidth="2"/>
        {/* Hotspots */}
        {[[180,200,25],[340,200,20],[260,300,35],[200,350,15],[320,350,15],[260,420,20]].map(([x,y,r],i)=>(
          <g key={i}><ellipse cx={x} cy={y} rx={r} ry={r*0.8} fill={`rgba(255,100,50,${0.3+Math.random()*0.3})`}/>
          <ellipse cx={x} cy={y} rx={r*0.5} ry={r*0.4} fill={`rgba(255,200,50,${0.5+Math.random()*0.3})`}/></g>
        ))}
        <text x="16" y="30" fill="rgba(255,255,0,0.5)" fontSize="10" fontFamily="monospace">NM SCAN</text>
      </svg>
    );
  };

  return (
    <div className={`dicom-img dicom-${mod.toLowerCase()}`}>
      <AnatomySVG/>
      <div className="dicom-overlay-tl">
        <div>{study?.last_name?.toUpperCase()}, {study?.first_name}</div>
        <div>{study?.mrn}</div>
        <div>{study?.dob ? fmtDate(study?.dob) : ''} {study?.sex}</div>
      </div>
      <div className="dicom-overlay-tr">
        <div>{study?.modality}</div>
        <div>{fmtDate(study?.acquisition_time)}</div>
        <div>ACC: {study?.accession}</div>
      </div>
      <div className="dicom-overlay-bl">
        <div>SER: {selectedSeries?.series_number || 1}/{series?.length || 1}</div>
        <div>{selectedSeries?.series_description || 'Axial'}</div>
      </div>
      <div className="dicom-overlay-br">
        <div>W: 400 L: 40</div>
        <div>KCH RADIOLOGY</div>
      </div>
    </div>
  );
}

// ─── NOTIFICATION ─────────────────────────────────────────────────
function Notif({msg,type,onClose}) {
  useEffect(()=>{ const t=setTimeout(onClose,3500); return()=>clearTimeout(t); },[]);
  return <div className={`notif ${type}`}>{msg}</div>;
}

// ─── MAIN APP ─────────────────────────────────────────────────────
function App() {
  const [theme,setTheme] = useState('dark');
  const [session,setSession] = useState(null);
  const [loginUser,setLoginUser] = useState('');
  const [loginPass,setLoginPass] = useState('');
  const [loginErr,setLoginErr] = useState('');
  const [loginLoading,setLoginLoading] = useState(false);
  const [nav,setNav] = useState('worklist');
  const [studies,setStudies] = useState([]);
  const [stats,setStats] = useState(null);
  const [selectedStudy,setSelectedStudy] = useState(null);
  const [studyDetail,setStudyDetail] = useState(null);
  const [selectedSeries,setSelectedSeries] = useState(null);
  const [filter,setFilter] = useState({mod:'',status:'',priority:'',search:''});
  const [report,setReport] = useState({indication:'',technique:'',findings:'',impression:'',sign_status:'Draft'});
  const [ariaState,setAriaState] = useState('idle');
  const [ariaMessages,setAriaMessages] = useState([]);
  const [ariaInput,setAriaInput] = useState('');
  const [ariaCaptions,setAriaCaptions] = useState("Ready. Select a study or ask me anything.");
  const [ariaVoice,setAriaVoice] = useState('nova');
  const [ariaMuted,setAriaMuted] = useState(false);
  const [isRecording,setIsRecording] = useState(false);
  const [dictating,setDictating] = useState(null);
  const [genParams,setGenParams] = useState({patients:50,studies_per_patient:3,critical_pct:15});
  const [genResult,setGenResult] = useState(null);
  const [genLoading,setGenLoading] = useState(false);
  const [importResult,setImportResult] = useState('');
  const [notif,setNotif] = useState(null);
  const [reports,setReports] = useState([]);
  const [selectedReport,setSelectedReport] = useState(null);
  const [viewerTool,setViewerTool] = useState('pan');
  const fileRef = useRef();
  const captionsRef = useRef();

  useEffect(()=>{ document.documentElement.setAttribute('data-theme',theme); },[theme]);

  const notify = (msg,type='ok') => { setNotif({msg,type}); };
  const tok = session?.token;

  // Login
  const handleLogin = async e => {
    e.preventDefault();
    setLoginLoading(true); setLoginErr('');
    try {
      const r = await fetch(`${API}/auth/login`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username:loginUser,password:loginPass})});
      if (!r.ok) throw new Error('Invalid username or password');
      const d = await r.json();
      setSession(d);
      await ariaSpeak(`Welcome to ARIA, ${d.username}. Your radiology workbench is ready.`);
    } catch(e){ setLoginErr(e.message); }
    setLoginLoading(false);
  };

  const handleLogout = () => { setSession(null); setStudies([]); setStats(null); setSelectedStudy(null); setStudyDetail(null); };

  // Load worklist
  const loadWorklist = useCallback(async () => {
    if (!tok) return;
    try {
      const params = new URLSearchParams({token:tok,...filter});
      const r = await fetch(`${API}/api/worklist?${params}`);
      const d = await r.json();
      setStudies(d.studies || []); if(d.studies&&d.studies[0]) console.log("critical_flag type:", typeof d.studies[0].critical_flag, "value:", d.studies[0].critical_flag);
    } catch(e){ console.error(e); }
  },[tok,filter]);

  const loadStats = useCallback(async () => {
    if (!tok) return;
    try {
      const r = await fetch(`${API}/api/stats?token=${tok}`);
      const d = await r.json();
      setStats(d);
    } catch{}
  },[tok]);

  const loadReports = useCallback(async () => {
    if (!tok) return;
    try {
      const r = await fetch(`${API}/api/reports?token=${tok}`);
      const d = await r.json();
      setReports(d.reports || []);
    } catch{}
  },[tok]);

  useEffect(()=>{ if(tok){ loadWorklist(); loadStats(); loadReports(); } },[tok,filter]);

  // Auto-scroll captions to keep highlighted word visible
  useEffect(()=>{
    if(captionsRef.current){
      const highlighted = captionsRef.current.querySelector('span[style*="00d4aa"]');
      if(highlighted) highlighted.scrollIntoView({block:'nearest',behavior:'smooth'});
    }
  },[ariaCaptions]);

  // Load study detail
  const openStudy = async s => {
    setSelectedStudy(s);
    setNav('viewer');
    try {
      const r = await fetch(`${API}/api/study/${s.study_id}?token=${tok}`);
      const d = await r.json();
      setStudyDetail(d);
      setSelectedSeries(d.series?.[0]||null);
      if(d.report){ setReport({indication:d.report.indication||'',technique:d.report.technique||'',findings:d.report.findings||'',impression:d.report.impression||'',sign_status:d.report.sign_status||'Draft'}); }
      else { setReport({indication:s.indication||'',technique:`${s.modality} ${s.body_part}`,findings:'',impression:'',sign_status:'Draft'}); }
      if(s.critical_flag){ ariaSpeak(`Critical study loaded. ${s.description}. Immediate review required.`); }
      else { ariaSpeak(`Study loaded: ${s.description} for ${s.first_name} ${s.last_name}.`); }
    } catch(e){ console.error(e); }
  };

  // ARIA speak
    // ── MICROPHONE — Web Speech API (live transcription) ─────────
  const recognitionRef = React.useRef(null);
  const mediaRecorderRef = React.useRef(null);
  const audioChunksRef = React.useRef([]);
  const liveTextRef = React.useRef('');

  const startRecording = async () => {
    liveTextRef.current = '';

    // Try Web Speech API first (live transcription in browser)
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if(SpeechRecognition) {
      const recognition = new SpeechRecognition();
      recognition.continuous = true;
      recognition.interimResults = true;
      recognition.lang = 'en-GB';
      recognitionRef.current = recognition;

      recognition.onstart = () => {
        setIsRecording(true);
        setAriaState('listening');
        setAriaCaptions('🎙 Listening — speak now...');
      };

      recognition.onresult = (event) => {
        let interim = '';
        let final = '';
        for(let i = event.resultIndex; i < event.results.length; i++) {
          const t = event.results[i][0].transcript;
          if(event.results[i].isFinal) { final += t; }
          else { interim += t; }
        }
        if(final) liveTextRef.current += final;
        const display = liveTextRef.current + (interim ? ' ' + interim : '');
        setAriaCaptions('🎙 ' + display);
      };

      recognition.onerror = (e) => {
        setAriaCaptions('Mic error: ' + e.error + ' — try typing instead');
        setAriaState('idle');
        setIsRecording(false);
      };

      recognition.onend = () => {
        setIsRecording(false);
        const text = liveTextRef.current.trim();
        if(text) {
          setAriaCaptions('You said: "' + text + '"');
          ariaQuery(text);
        } else {
          setAriaCaptions('Nothing heard — tap TAP TO TALK and try again');
          setAriaState('idle');
        }
      };

      recognition.start();
      return;
    }

    // Fallback: MediaRecorder + Whisper
    try {
      const stream = await navigator.mediaDevices.getUserMedia({audio:true});
      audioChunksRef.current = [];
      const mimeType = MediaRecorder.isTypeSupported('audio/webm') ? 'audio/webm' : 'audio/ogg';
      const recorder = new MediaRecorder(stream, {mimeType});
      mediaRecorderRef.current = recorder;
      recorder.ondataavailable = e => { if(e.data.size>0) audioChunksRef.current.push(e.data); };
      recorder.onstop = async () => {
        stream.getTracks().forEach(t=>t.stop());
        setAriaState('thinking');
        setAriaCaptions('Transcribing via Whisper...');
        const blob = new Blob(audioChunksRef.current, {type:mimeType});
        const fd = new FormData();
        fd.append('audio', blob, 'recording.webm');
        try {
          const r = await fetch(`${API}/api/aria/transcribe?token=${tok}`, {method:'POST', body:fd});
          const d = await r.json();
          const text = d.text?.trim();
          if(text) { setAriaCaptions('You said: "' + text + '"'); await ariaQuery(text); }
          else { setAriaCaptions('Nothing heard — try again'); setAriaState('idle'); }
        } catch(e) { setAriaCaptions('Transcription failed'); setAriaState('idle'); }
      };
      recorder.start();
      setIsRecording(true);
      setAriaState('listening');
      setAriaCaptions('🎙 Listening via Whisper... tap STOP when done');
    } catch(e) { setAriaCaptions('Microphone access denied — check browser permissions'); setAriaState('idle'); }
  };

  const stopRecording = () => {
    if(recognitionRef.current) { recognitionRef.current.stop(); recognitionRef.current = null; }
    if(mediaRecorderRef.current && mediaRecorderRef.current.state !== 'inactive') mediaRecorderRef.current.stop();
    setIsRecording(false);
  };

  const toggleRecording = () => { if(isRecording) stopRecording(); else startRecording(); };

  const ariaSpeak = async text => {
    if(ariaMuted){
      // Even muted, show word-by-word highlight using timing estimate
      const words = text.split(' ');
      let i = 0;
      const iv = setInterval(()=>{
        if(i >= words.length){ clearInterval(iv); setAriaState('idle'); return; }
        const highlighted = words.map((w,j)=>
          j < i ? `<span style="color:var(--text2)">${w}</span>` :
          j === i ? `<span style="color:#00d4aa;font-weight:700;text-shadow:0 0 8px rgba(0,212,170,0.6)">${w}</span>` :
          `<span>${w}</span>`
        ).join(' ');
        setAriaCaptions(highlighted);
        i++;
      }, 120);
      return;
    }
    setAriaState('speaking');
    const words = text.split(' ');
    try {
      const r = await fetch(`${API}/api/aria/speak?token=${tok}`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text,voice:ariaVoice})});
      if(!r.ok) throw new Error();
      const blob = await r.blob();
      const audio = new Audio(URL.createObjectURL(blob));
      const duration = await new Promise(res => {
        audio.onloadedmetadata = () => res(audio.duration * 1000);
        audio.onerror = () => res(words.length * 120);
      });
      const msPerWord = duration / words.length;
      let i = 0;
      const iv = setInterval(()=>{
        if(i >= words.length){ clearInterval(iv); return; }
        const highlighted = words.map((w,j)=>
          j < i ? `<span style="color:var(--text2)">${w}</span>` :
          j === i ? `<span style="color:#00d4aa;font-weight:700;text-shadow:0 0 8px rgba(0,212,170,0.6)">${w}</span>` :
          `<span>${w}</span>`
        ).join(' ');
        setAriaCaptions(highlighted);
        i++;
      }, msPerWord);
      audio.onended = ()=>{ clearInterval(iv); setAriaState('idle'); setAriaCaptions(text); };
      await audio.play();
    } catch { 
      let i = 0;
      const iv = setInterval(()=>{
        if(i >= words.length){ clearInterval(iv); setAriaState('idle'); setAriaCaptions(text); return; }
        const highlighted = words.map((w,j)=>
          j < i ? `<span style="color:var(--text2)">${w}</span>` :
          j === i ? `<span style="color:#00d4aa;font-weight:700;text-shadow:0 0 8px rgba(0,212,170,0.6)">${w}</span>` :
          `<span>${w}</span>`
        ).join(' ');
        setAriaCaptions(highlighted);
        i++;
      }, 120);
    }
  };

  // ARIA text query
  const ariaQuery = async q => {
    if(!q.trim()) return;
    setAriaMessages(m=>[...m,{role:'user',body:q}]);
    setAriaInput('');
    setAriaState('thinking');
    setAriaCaptions('Processing your query...');
    try {
      const r = await fetch(`${API}/api/aria/query?token=${tok}`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({query:q})});
      const d = await r.json();
      await ariaSpeak(d.response);
    } catch(e){ setAriaMessages(m=>[...m,{role:'aria',body:'ARIA is temporarily unavailable. Please try again.'}]); setAriaState('idle'); }
  };

  // Report save
  const saveReport = async (forceStatus) => {
    if(!studyDetail) return;
    try {
      const existing = studyDetail.report;
      const payload = forceStatus ? {...report, sign_status: forceStatus} : report;
      if(forceStatus) setReport(r=>({...r, sign_status: forceStatus}));
      let res;
      if(existing && existing.report_id){
        res = await fetch(`${API}/api/report/${existing.report_id}?token=${tok}`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
      } else {
        res = await fetch(`${API}/api/report?token=${tok}`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({...payload,study_id:selectedStudy.study_id})});
        if(res && res.ok){ const nd = await res.json(); setStudyDetail(sd=>({...sd,report:nd})); }
      }
      if(res && !res.ok) throw new Error(res.status);
      if(forceStatus==='Final') notify('Report signed and finalised ✓');
      else notify('Report saved successfully');
      loadReports();
    } catch(e){ notify('Failed to save: ' + e.message,'err'); }
  };

  // AI assist report
  const aiAssistReport = async () => {
    if(!selectedStudy) return;
    setAriaState('thinking');
    try {
      const r = await fetch(`${API}/api/aria/assist-report?token=${tok}`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({modality:selectedStudy.modality,body_part:selectedStudy.body_part,indication:report.indication,findings:report.findings})});
      const d = await r.json();
      setReport(prev=>({...prev,impression:d.suggestion}));
      ariaSpeak(d.suggestion);
    } catch(e){ notify('AI assist failed','err'); }
  };

  // Generate dataset
  const generateDataset = async () => {
    setGenLoading(true);
    try {
      const r = await fetch(`${API}/api/generate?token=${tok}`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(genParams)});
      const d = await r.json();
      setGenResult(d);
      await loadWorklist(); await loadStats();
      notify(`Generated ${d.patients} patients, ${d.studies} studies`);
    } catch(e){ notify('Generation failed','err'); }
    setGenLoading(false);
  };

  // Export
  const handleExport = async fmt => {
    try {
      const r = await fetch(`${API}/api/export?token=${tok}&fmt=${fmt}`);
      const blob = await r.blob();
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download=`aria_worklist.${fmt}`; a.click();
      notify(`Exported as ${fmt.toUpperCase()}`);
    } catch(e){ notify('Export failed','err'); }
  };

  // Import
  const handleImport = async file => {
    const form = new FormData(); form.append('file',file);
    try {
      const r = await fetch(`${API}/api/import?token=${tok}`,{method:'POST',body:form});
      const d = await r.json();
      setImportResult(`✓ Imported ${d.imported} records successfully`);
      await loadWorklist(); await loadStats();
      notify(`Imported ${d.imported} records`);
    } catch(e){ setImportResult('Import failed — check file format'); }
  };

  // Priority colour
  const priClass = p => p==='Emergency'?'pri-e':p==='Urgent'?'pri-u':'pri-r';
  const rsClass = s => s==='Unreported'?'rs-U':s==='Preliminary'?'rs-P':s==='Final'?'rs-F':'rs-D';

  // ── LOGIN ──────────────────────────────────────────────────────
  if(!session) return (
    <div className="login-wrap">
      <div className="login-card">
        <div className="login-avatar">A</div>
        <div className="login-title">ARIA</div>
        <div className="login-sub">Advanced Radiology Intelligence Assistant</div>
        <div style={{textAlign:'center',marginBottom:'28px'}}><span className="login-badge">NHS PROTOTYPE</span></div>
        {loginErr && <div className="login-error">{loginErr}</div>}
        <form onSubmit={handleLogin}>
          <label className="login-label">Username</label>
          <input className="login-input" type="text" placeholder="Enter username" value={loginUser} onChange={e=>setLoginUser(e.target.value)} autoFocus/>
          <label className="login-label">Password</label>
          <input className="login-input" type="password" placeholder="Enter password" value={loginPass} onChange={e=>setLoginPass(e.target.value)}/>
          <button className="login-btn" type="submit" disabled={loginLoading}>{loginLoading?'Signing in...':'SIGN IN TO ARIA'}</button>
        </form>
        <div className="login-confidential">CONFIDENTIAL — Authorised Access Only</div>
        <div className="login-footer">This system is for NHS staff only. Not for clinical decision making.<br/>King's College Hospital NHS Foundation Trust<br/><br/><span style={{opacity:0.5}}>Demo: david / kings2024</span></div>
      </div>
    </div>
  );

  // ── MAIN APP ────────────────────────────────────────────────────
  const RAIL_ITEMS = [
    {id:'worklist',icon:'☰',label:'List'},
    {id:'viewer',icon:'⬜',label:'Viewer'},
    {id:'reports',icon:'📋',label:'Reports'},
    {id:'analytics',icon:'▦',label:'Stats'},
    {id:'import',icon:'↑',label:'I/O'},
    {id:'generator',icon:'⚙',label:'Gen'},
  ];

  return (
    <div className="app">
      {/* TOPBAR */}
      <div className="topbar">
        <div className="topbar-logo"><div className="nhs-sq">NHS</div></div>
        <div className="topbar-brand">
          <h1>ARIA Radiology Workbench</h1>
          <p>KING'S COLLEGE HOSPITAL NHS FOUNDATION TRUST · DENMARK HILL SE5</p>
        </div>
        <div className="topbar-banner">
          {selectedStudy ? <>
            <div className="banner-field"><div className="bf-label">Patient</div><div className="bf-val">{selectedStudy.last_name?.toUpperCase()}, {selectedStudy.first_name}</div></div>
            <div className="banner-field"><div className="bf-label">MRN</div><div className="bf-val">{selectedStudy.mrn}</div></div>
            <div className="banner-field"><div className="bf-label">DOB / Age</div><div className="bf-val">{fmtDate(selectedStudy.dob)} ({age(selectedStudy.dob)}y)</div></div>
            <div className="banner-field"><div className="bf-label">Sex</div><div className="bf-val">{selectedStudy.sex}</div></div>
            <div className="banner-field"><div className="bf-label">Modality</div><div className="bf-val">{selectedStudy.modality} · {selectedStudy.body_part}</div></div>
            {Number(selectedStudy.critical_flag)===1 && <div className="banner-field"><div className="pb-critical">⚠ CRITICAL</div></div>}
            {(() => { try { const a=JSON.parse(selectedStudy.allergies||'[]'); return a.length&&a[0]!=='None known'?<div className="banner-field"><div className="bf-label">Allergies</div><div className="bf-val alert">{a.slice(0,2).join(', ')}</div></div>:null; } catch{ return null; } })()}
          </> : <div style={{color:'rgba(255,255,255,0.3)',fontSize:'12px',padding:'0 16px'}}>No study selected — select from worklist</div>}
        </div>
        <div className="topbar-right">
          <div className="live-pill"><div className="live-d"/>LIVE</div>
          {stats && <div style={{fontSize:'10px',color:'rgba(255,255,255,0.5)',fontFamily:'var(--font-m)'}}>{stats.total} studies · {stats.critical} critical</div>}
          <div className="theme-tog">
            <button className={`ttb ${theme==='dark'?'on':''}`} onClick={()=>setTheme('dark')}>DARK</button>
            <button className={`ttb ${theme==='light'?'on':''}`} onClick={()=>setTheme('light')}>LIGHT</button>
          </div>
          <div className="topbar-user">
            <div className="user-chip">👤 {session.username}</div>
            <button className="logout-btn" onClick={handleLogout}>SIGN OUT</button>
          </div>
        </div>
      </div>

      {/* RAIL */}
      <div className="rail">
        {RAIL_ITEMS.map(item=>(
          <button key={item.id} className={`rail-btn ${nav===item.id?'active':''}`} onClick={()=>setNav(item.id)}>
            <span className="rail-icon">{item.icon}</span>
            <span className="rail-label">{item.label}</span>
          </button>
        ))}
        <div className="rail-spacer"/>
        <div className="rail-divider"/>
        <button className="rail-btn" onClick={handleLogout} title="Sign out">
          <span className="rail-icon">⏻</span>
          <span className="rail-label">Out</span>
        </button>
      </div>

      {/* WORKSPACE */}
      <div className="workspace">

        {/* ── WORKLIST ── */}
        {nav==='worklist' && (
          <div className="wl-wrap">
            <div className="wl-toolbar">
              <div className="wl-title">Radiology Worklist</div>
              <div className="search-box">
                <span style={{color:'var(--text2)'}}>🔍</span>
                <input placeholder="Search patient, MRN, description..." value={filter.search} onChange={e=>setFilter(f=>({...f,search:e.target.value}))}/>
              </div>
              <select className="filter-sel" value={filter.mod} onChange={e=>setFilter(f=>({...f,mod:e.target.value}))}>
                <option value="">All Modalities</option>
                {['CT','MRI','XR','US','NM'].map(m=><option key={m} value={m}>{m}</option>)}
              </select>
              <select className="filter-sel" value={filter.status} onChange={e=>setFilter(f=>({...f,status:e.target.value}))}>
                <option value="">All Statuses</option>
                {['Unreported','Preliminary','Final'].map(s=><option key={s} value={s}>{s}</option>)}
              </select>
              <select className="filter-sel" value={filter.priority} onChange={e=>setFilter(f=>({...f,priority:e.target.value}))}>
                <option value="">All Priorities</option>
                {['Emergency','Urgent','Routine'].map(p=><option key={p} value={p}>{p}</option>)}
              </select>
              {stats && <>
                <span className="wl-stat red">⚠ {stats.critical} Critical</span>
                <span className="wl-stat amb">{stats.unreported} Unreported</span>
                <span className="wl-stat grn">{stats.total} Total</span>
              </>}
            </div>
            <div className="table-wrap">
              {studies.length===0 ? (
                <div className="empty-state">
                  <div className="empty-icon">📋</div>
                  <div>No studies found</div>
                  <div style={{marginTop:'8px',fontSize:'11px'}}>Use the Generator to create demo data, or adjust filters</div>
                </div>
              ) : (
                <table>
                  <thead>
                    <tr>
                      <th>Priority</th><th>Patient</th><th>MRN</th><th>DOB</th><th>Sex</th>
                      <th>Modality</th><th>Study Description</th><th>Body Part</th>
                      <th>Ordering Clinician</th><th>Scheduled</th><th>Report Status</th><th>⚠</th>
                    </tr>
                  </thead>
                  <tbody>
                    {studies.map(s=>(
                      <tr key={s.study_id} className={selectedStudy?.study_id===s.study_id?'active-row':''} onClick={()=>openStudy(s)}>
                        <td><span className={`pri-badge ${priClass(s.priority)}`}>{s.priority}</span></td>
                        <td className="primary">{s.last_name}, {s.first_name}</td>
                        <td style={{fontFamily:'var(--font-m)',fontSize:'10px'}}>{s.mrn}</td>
                        <td style={{fontSize:'10px'}}>{fmtDate(s.dob)}</td>
                        <td>{s.sex}</td>
                        <td><span className={`mod-tag m-${s.modality}`}>{s.modality}</span></td>
                        <td style={{maxWidth:'240px',overflow:'hidden',textOverflow:'ellipsis'}}>{s.description}</td>
                        <td>{s.body_part}</td>
                        <td style={{fontSize:'10px'}}>{s.ordering_clinician}</td>
                        <td style={{fontFamily:'var(--font-m)',fontSize:'10px'}}>{s.scheduled_time?.slice(11,16)} {s.scheduled_time?.slice(5,10)}</td>
                        <td><span className={`rs-badge ${rsClass(s.report_status)}`}>{s.report_status}</span></td>
                        <td>{Number(s.critical_flag)===1 && <span className="crit-flag">⚠</span>}</td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              )}
            </div>
          </div>
        )}

        {/* ── VIEWER ── */}
        {nav==='viewer' && (
          !selectedStudy ? (
            <div className="no-study">
              <div className="no-study-icon">🔬</div>
              <div className="no-study-text">No Study Selected</div>
              <div className="no-study-sub">Select a study from the worklist to begin</div>
            </div>
          ) : (
            <div className="viewer-wrap">
              {/* Series Panel */}
              <div className="series-panel">
                <div className="series-title">Series</div>
                {studyDetail?.series?.map(ser=>(
                  <div key={ser.series_id} className={`series-item ${selectedSeries?.series_id===ser.series_id?'active':''}`} onClick={()=>setSelectedSeries(ser)}>
                    <div className="series-num">Series {ser.series_number}</div>
                    <div className="series-desc">{ser.series_description}</div>
                  </div>
                ))}
                <div className="series-title" style={{marginTop:'16px'}}>Study Info</div>
                <div style={{fontSize:'10px',color:'var(--text2)',lineHeight:'1.8',fontFamily:'var(--font-m)'}}>
                  <div><span style={{color:'var(--text2)'}}>MOD:</span> <span style={{color:'var(--text0)'}}>{selectedStudy.modality}</span></div>
                  <div><span style={{color:'var(--text2)'}}>ACC:</span> <span style={{color:'var(--text0)',fontSize:'9px'}}>{selectedStudy.accession}</span></div>
                  <div><span style={{color:'var(--text2)'}}>ACQ:</span> <span style={{color:'var(--text0)'}}>{selectedStudy.acquisition_time?.slice(0,16)}</span></div>
                  <div style={{marginTop:'8px',color:'var(--text1)'}}>{selectedStudy.description}</div>
                </div>
              </div>

              {/* Canvas */}
              <div className="viewer-canvas">
                <div className="viewer-controls">
                  {['Pan','Zoom','Measure','Annotate','WL'].map(t=>(
                    <button key={t} className={`vc-btn ${viewerTool===t.toLowerCase()?'on':''}`} onClick={()=>setViewerTool(t.toLowerCase())}>{t}</button>
                  ))}
                </div>
                <DicomViewer study={selectedStudy} series={studyDetail?.series} selectedSeries={selectedSeries}/>
                <div className="wl-slider">
                  <div className="slider-group"><div className="slider-label">WINDOW</div><input type="range" min="1" max="800" defaultValue="400"/></div>
                  <div className="slider-group"><div className="slider-label">LEVEL</div><input type="range" min="-200" max="400" defaultValue="40"/></div>
                  <div className="slider-group"><div className="slider-label">ZOOM</div><input type="range" min="50" max="300" defaultValue="100"/></div>
                </div>
              </div>

              {/* Report Side */}
              <div className="report-side">
                <div className="report-header">
                  <div className="rh-title">Report Editor</div>
                  <span className={`rs-badge ${rsClass(studyDetail?.report?.sign_status||report.sign_status)}`}>{studyDetail?.report?.sign_status||report.sign_status||'Draft'}</span>
                </div>
                <div className="rep-fields">
                  <div className="rep-section">
                    <label>Indication</label>
                    <textarea className="rep-textarea" rows={2} value={report.indication} onChange={e=>setReport(r=>({...r,indication:e.target.value}))}/>
                  </div>
                  <div className="rep-section">
                    <label>Technique</label>
                    <textarea className="rep-textarea" rows={2} value={report.technique} onChange={e=>setReport(r=>({...r,technique:e.target.value}))}/>
                  </div>
                  <div className="rep-section">
                    <label>Findings</label>
                    <textarea className="rep-textarea findings" rows={6} value={report.findings} onChange={e=>setReport(r=>({...r,findings:e.target.value}))}/>
                  </div>
                  <div className="rep-section">
                    <div className={`ai-impression-panel ${ariaState==='thinking'?'generating':''}`}>
                      <div className={`ai-impression-text ${!report.impression?'empty':''}`}
                        dangerouslySetInnerHTML={{__html: report.impression 
                          ? report.impression
                            .replace(/\*\*([^*]+)\*\*/g, '<strong style="color:#00ffcc;font-size:15px">$1</strong>')
                            .replace(/^- /gm, '• ')
                            .replace(/\n/g, '<br/>')
                          : 'Click Generate AI Impression below...'
                        }}
                      />
                      {report.impression && <div className="ai-impression-meta">
                        <span className="ai-impression-badge">⚕ AI ASSISTED</span>
                        <span className="ai-impression-badge" style={{color:'#ff9900',borderColor:'rgba(255,153,0,0.3)'}}>REQUIRES REVIEW</span>
                        <button className="ai-speak-btn" onClick={()=>ariaSpeak(report.impression)}>🔊 Read Aloud</button>
                        <button className="ai-speak-btn" onClick={()=>setReport(r=>({...r,impression:''}))}>✕ Clear</button>
                      </div>}
                    </div>
                  </div>
                  <div className="rep-section">
                    <button className="ai-btn" onClick={aiAssistReport}>✦ Generate AI Impression</button>
                  </div>
                </div>
                <div className="rep-actions">
                  <button className="rep-btn primary" onClick={saveReport}>💾 Save Report</button>
                  <button className="rep-btn primary" onClick={()=>saveReport('Final')}>✓ Sign & Finalise</button>
                  <button className="rep-btn secondary" onClick={()=>notify('Addendum mode — type in findings')}>+ Add Addendum</button>
                </div>
              </div>
            </div>
          )
        )}

        {/* ── REPORTS ── */}
        {nav==='reports' && (
          <div className="reports-wrap">
            <div className="reports-list">
              <div className="reports-list-header">
                <div className="reports-list-title">Signed Reports</div>
                <div className="reports-list-sub">{reports.length} REPORTS IN SYSTEM</div>
              </div>
              {reports.length===0 ? (
                <div className="no-reports" style={{padding:'40px',textAlign:'center'}}>
                  <div style={{fontSize:'32px',marginBottom:'12px',opacity:0.3}}>📋</div>
                  <div style={{opacity:0.4}}>No reports yet</div>
                  <div style={{fontSize:'11px',marginTop:'8px',opacity:0.3}}>Sign and save reports from the Viewer</div>
                </div>
              ) : reports.map(rep=>(
                <div key={rep.report_id} className={`report-card ${selectedReport?.report_id===rep.report_id?'active':''}`} onClick={()=>setSelectedReport(rep)}>
                  <div className="rc-patient">{rep.last_name}, {rep.first_name}</div>
                  <div className="rc-meta">{rep.mrn} · {rep.modality} {rep.body_part} · {fmtDate(rep.signed_at||rep.updated_at)}</div>
                  <div className="rc-impression">{rep.impression?.replace(/\*\*([^*]+)\*\*/g,'$1').slice(0,120)}...</div>
                  <div className="rc-badges">
                    <span className={`rs-badge ${rep.sign_status==='Final'?'rs-F':rep.sign_status==='Preliminary'?'rs-P':'rs-D'}`}>{rep.sign_status||'Draft'}</span>
                    <span className={`mod-tag m-${rep.modality}`}>{rep.modality}</span>
                    {rep.ai_assisted && <span className="ai-impression-badge" style={{fontSize:'8px'}}>⚕ AI ASSISTED</span>}
                  </div>
                </div>
              ))}
            </div>
            <div className="report-detail">
              {!selectedReport ? (
                <div className="no-reports">
                  <div style={{fontSize:'48px',marginBottom:'16px',opacity:0.15}}>📄</div>
                  <div style={{fontFamily:'var(--font-h)',fontSize:'20px',fontStyle:'italic',opacity:0.3}}>Select a report</div>
                  <div style={{fontSize:'12px',marginTop:'8px',opacity:0.2}}>Click a report from the list to view full details</div>
                </div>
              ) : (
                <div>
                  <div className="rd-header">
                    <div className="rd-patient-name">{selectedReport.last_name}, {selectedReport.first_name}</div>
                    <div className="rd-meta-row">
                      <div className="rd-meta-field"><div className="rd-meta-label">MRN</div><div className="rd-meta-value">{selectedReport.mrn}</div></div>
                      <div className="rd-meta-field"><div className="rd-meta-label">Modality</div><div className="rd-meta-value">{selectedReport.modality} · {selectedReport.body_part}</div></div>
                      <div className="rd-meta-field"><div className="rd-meta-label">Accession</div><div className="rd-meta-value">{selectedReport.accession}</div></div>
                      <div className="rd-meta-field"><div className="rd-meta-label">Report Date</div><div className="rd-meta-value">{fmt(selectedReport.updated_at)}</div></div>
                    </div>
                    <div className="rd-signed-banner">
                      <div className="rd-signed-icon">{selectedReport.sign_status==='Final'?'✅':'📝'}</div>
                      <div>
                        <div className="rd-signed-text">{selectedReport.sign_status==='Final'?'SIGNED & FINALISED':'PRELIMINARY REPORT'} · {selectedReport.sign_status?.toUpperCase()}</div>
                        <div className="rd-signed-sub">King's College Hospital NHS Foundation Trust · Radiology Department · Denmark Hill SE5</div>
                      </div>
                    </div>
                  </div>
                  <div className="rd-body">
                    {selectedReport.indication && <div className="rd-section">
                      <div className="rd-section-label">Clinical Indication</div>
                      <div className="rd-section-text">{selectedReport.indication}</div>
                    </div>}
                    {selectedReport.technique && <div className="rd-section">
                      <div className="rd-section-label">Technique</div>
                      <div className="rd-section-text">{selectedReport.technique}</div>
                    </div>}
                    {selectedReport.findings && <div className="rd-section">
                      <div className="rd-section-label">Findings</div>
                      <div className="rd-section-text">{selectedReport.findings}</div>
                    </div>}
                    {selectedReport.impression && <div className="rd-ai-section">
                      <div className="rd-ai-text" dangerouslySetInnerHTML={{__html: (selectedReport.impression||'')
                        .replace(/\*\*([^*]+)\*\*/g,'<strong style="color:#00ffcc;font-size:14px">$1</strong>')
                        .replace(/^- /gm,'• ')
                        .replace(/\n/g,'<br/>')
                      }}/>
                      <div className="rd-ai-footer">
                        <span className="ai-impression-badge">⚕ AI ASSISTED</span>
                        <span className="ai-impression-badge" style={{color:'#ff9900',borderColor:'rgba(255,153,0,0.3)'}}>REQUIRES CLINICAL REVIEW</span>
                        <button className="rd-speak-btn" onClick={()=>ariaSpeak(selectedReport.impression.replace(/\*\*([^*]+)\*\*/g,'$1'))}>🔊 Read Aloud</button>
                      </div>
                    </div>}
                    <div style={{display:'flex',gap:'10px',marginTop:'8px'}}>
                      <button className="rd-print-btn" onClick={()=>window.print()}>🖨 Print Report</button>
                      <button className="rd-speak-btn" onClick={()=>ariaSpeak(`Report for ${selectedReport.first_name} ${selectedReport.last_name}. ${selectedReport.findings||''} ${selectedReport.impression?.replace(/\*\*([^*]+)\*\*/g,'$1')||''}`)}>🔊 Read Full Report</button>
                    </div>
                  </div>
                </div>
              )}
            </div>
          </div>
        )}

        {/* ── ANALYTICS ── */}}
        {nav==='analytics' && (
          <div className="analytics-wrap">
            <div className="a-title">Department Analytics</div>
            <div className="a-subtitle">King's College Hospital · Radiology Department · Live data</div>

            {/* Top KPI cards */}
            <div className="a-grid">
              <div className="a-card blue">
                <div className="a-l">Total Studies</div>
                <div className="a-n">{stats?.total||0}</div>
                <div className="a-sub">All modalities in system</div>
              </div>
              <div className="a-card red">
                <div className="a-l">⚠ Critical Findings</div>
                <div className="a-n">{stats?.critical||0}</div>
                <div className="a-pct" style={{color:'var(--urgent)'}}>{stats?.total?Math.round(stats.critical/stats.total*100):0}% of studies require urgent action</div>
              </div>
              <div className="a-card amber">
                <div className="a-l">Unreported Studies</div>
                <div className="a-n">{stats?.unreported||0}</div>
                <div className="a-pct" style={{color:'var(--warn)'}}>{stats?.total?Math.round(stats.unreported/stats.total*100):0}% awaiting radiologist report</div>
              </div>
              <div className="a-card green">
                <div className="a-l">Total Patients</div>
                <div className="a-n">{stats?.patients||0}</div>
                <div className="a-sub">Unique patients with imaging</div>
              </div>
            </div>

            {/* Modality breakdown */}
            <div className="a-section-title">Studies by Modality</div>
            <div className="a-mod-grid">
              {['CT','MRI','XR','US','NM'].map(m=>{
                const n = stats?.modalities?.[m]||0;
                const pct = stats?.total ? Math.round(n/stats.total*100) : 0;
                const colors={CT:'var(--accent)',MRI:'var(--accent2)',XR:'var(--warn)',US:'#9b81ff',NM:'#ff80d0'};
                const labels={CT:'Computed Tomography',MRI:'Magnetic Resonance',XR:'X-Ray / Plain Film',US:'Ultrasound',NM:'Nuclear Medicine'};
                return <div key={m} className="a-mod-card">
                  <div className="a-mod-n" style={{color:colors[m]}}>{n}</div>
                  <div className="a-mod-l" style={{color:colors[m]}}>{m}</div>
                  <div className="a-mod-pct">{pct}% · {labels[m]}</div>
                </div>;
              })}
            </div>

            {/* Two column: bar chart + report status */}
            <div className="a-two-col">
              <div className="bar-chart">
                <div className="bar-chart-title">Volume by Modality</div>
                {['CT','MRI','XR','US','NM'].map(m=>{
                  const max=Math.max(...['CT','MRI','XR','US','NM'].map(x=>stats?.modalities?.[x]||0))||1;
                  const n=stats?.modalities?.[m]||0;
                  const colors={CT:'var(--accent)',MRI:'var(--accent2)',XR:'var(--warn)',US:'#9b81ff',NM:'#ff80d0'};
                  return <div key={m} className="bar-row">
                    <div className="bar-label">{m}</div>
                    <div className="bar-track"><div className="bar-fill" style={{width:`${(n/max)*100}%`,background:colors[m]}}/></div>
                    <div className="bar-val">{n}</div>
                  </div>;
                })}
              </div>
              <div className="report-status-chart">
                <div className="bar-chart-title">Report Status Breakdown</div>
                {[
                  {label:'Final — Signed',color:'var(--ok)',dot:'#00914d',key:'Final'},
                  {label:'Preliminary — Draft',color:'var(--accent)',dot:'#00aaff',key:'Preliminary'},
                  {label:'Unreported — Pending',color:'var(--warn)',dot:'#e07b00',key:'Unreported'},
                ].map(({label,color,dot,key})=>{
                  const total = stats?.total||1;
                  const unrep = stats?.unreported||0;
                  const crit = stats?.critical||0;
                  const counts = {
                    Final: total - unrep - Math.round(total*0.12),
                    Preliminary: Math.round(total*0.12),
                    Unreported: unrep
                  };
                  const n = counts[key]||0;
                  const pct = Math.round(n/total*100);
                  return <div key={key} className="rs-row">
                    <div className="rs-label"><div className="rs-dot" style={{background:dot}}/>{label}</div>
                    <div className="rs-nums">
                      <div className="rs-count" style={{color}}>{n}</div>
                      <div className="rs-pct-bar"><div className="rs-pct-fill" style={{width:`${pct}%`,background:dot}}/></div>
                      <div style={{fontSize:'10px',color:'var(--text2)',width:'28px',fontFamily:'var(--font-m)'}}>{pct}%</div>
                    </div>
                  </div>;
                })}
                <div style={{marginTop:'12px',paddingTop:'10px',borderTop:'1px solid var(--border)'}}>
                  <div className="rs-row" style={{paddingTop:0}}>
                    <div className="rs-label"><div className="rs-dot" style={{background:'var(--urgent)'}}/><strong>Critical — Immediate Action</strong></div>
                    <div className="rs-nums">
                      <div className="rs-count" style={{color:'var(--urgent)'}}>{stats?.critical||0}</div>
                      <div className="rs-pct-bar"><div className="rs-pct-fill" style={{width:`${stats?.total?Math.round((stats.critical/stats.total)*100):0}%`,background:'var(--urgent)'}}/></div>
                      <div style={{fontSize:'10px',color:'var(--urgent)',width:'28px',fontFamily:'var(--font-m)'}}>{stats?.total?Math.round(stats.critical/stats.total*100):0}%</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* ── IMPORT / EXPORT ── */}
        {nav==='import' && (
          <div className="ie-wrap">
            <div className="ie-title">Import & Export</div>
            <div className="ie-grid">
              <div className="ie-card">
                <div className="ie-card-title">↑ Import Data</div>
                <div className="drop-zone" onClick={()=>fileRef.current?.click()} onDragOver={e=>e.preventDefault()} onDrop={e=>{e.preventDefault();const f=e.dataTransfer.files[0];if(f)handleImport(f);}}>
                  <div className="drop-zone-icon">📂</div>
                  <div className="drop-zone-text">Drop CSV or JSON file here<br/>or click to browse</div>
                </div>
                <input type="file" accept=".csv,.json" ref={fileRef} style={{display:'none'}} onChange={e=>e.target.files[0]&&handleImport(e.target.files[0])}/>
                {importResult && <div className="ie-result">{importResult}</div>}
                <div style={{marginTop:'16px',fontSize:'11px',color:'var(--text2)',lineHeight:'1.8'}}>
                  <div style={{fontWeight:'700',marginBottom:'6px',color:'var(--text1)'}}>Expected CSV columns:</div>
                  <div style={{fontFamily:'var(--font-m)',fontSize:'10px'}}>mrn, first_name, last_name, dob, sex</div>
                </div>
              </div>
              <div className="ie-card">
                <div className="ie-card-title">↓ Export Data</div>
                <button className="ie-btn export" onClick={()=>handleExport('json')}>Export as JSON</button>
                <button className="ie-btn export-csv" onClick={()=>handleExport('csv')}>Export as CSV</button>
                <div style={{marginTop:'16px',fontSize:'11px',color:'var(--text2)',lineHeight:'1.8'}}>
                  Exports current worklist with patient demographics, study details, modalities, priorities and report statuses.
                </div>
              </div>
            </div>
          </div>
        )}

        {/* ── GENERATOR ── */}
        {nav==='generator' && (
          <div className="gen-wrap">
            <div className="gen-title">Dataset Generator</div>
            <div className="gen-sub">Generate realistic synthetic radiology patients and studies for demonstration purposes</div>
            <div className="gen-grid">
              <div className="gen-card">
                <div className="gen-card-title">Patient Parameters</div>
                {[{key:'patients',label:'Number of Patients',min:10,max:200,step:10},{key:'studies_per_patient',label:'Studies per Patient',min:1,max:8,step:1},{key:'critical_pct',label:'Critical Finding %',min:0,max:50,step:5}].map(({key,label,min,max,step})=>(
                  <div key={key} className="slider-wrap">
                    <label>{label} <span>{genParams[key]}{key==='critical_pct'?'%':''}</span></label>
                    <input type="range" min={min} max={max} step={step} value={genParams[key]} onChange={e=>setGenParams(p=>({...p,[key]:parseInt(e.target.value)}))}/>
                  </div>
                ))}
              </div>
              <div className="gen-card">
                <div className="gen-card-title">Study Mix Preview</div>
                <div style={{fontSize:'12px',color:'var(--text1)',lineHeight:'2.0'}}>
                  <div>📊 Est. studies: <strong style={{color:'var(--accent)'}}>{genParams.patients * genParams.studies_per_patient}</strong></div>
                  <div>⚠ Est. critical: <strong style={{color:'var(--urgent)'}}>{Math.round(genParams.patients * genParams.studies_per_patient * genParams.critical_pct / 100)}</strong></div>
                  <div style={{marginTop:'12px',fontSize:'10px',color:'var(--text2)'}}>Modality distribution: CT 30% · MRI 18% · XR 25% · US 18% · NM 9%</div>
                  <div style={{marginTop:'8px',fontSize:'10px',color:'var(--text2)'}}>Includes realistic: study descriptions · clinician names · ordering locations · report statuses · contrast flags · critical findings</div>
                </div>
              </div>
            </div>
            <div style={{marginTop:'24px'}}>
              <button className="gen-btn" onClick={generateDataset} disabled={genLoading}>{genLoading?'Generating...':'⚙ GENERATE DATASET'}</button>
            </div>
            {genResult && (
              <div className="gen-result fi">
                <div className="gen-result-title">✓ Dataset Generated Successfully</div>
                <div className="gen-stat-row">
                  <div className="gen-stat"><div className="gen-stat-n">{genResult.patients}</div><div className="gen-stat-l">Patients</div></div>
                  <div className="gen-stat"><div className="gen-stat-n">{genResult.studies}</div><div className="gen-stat-l">Studies</div></div>
                  <div className="gen-stat"><div className="gen-stat-n">{Math.round(genResult.studies*genParams.critical_pct/100)}</div><div className="gen-stat-l">Est. Critical</div></div>
                </div>
                <div style={{marginTop:'12px',fontSize:'11px',color:'var(--text2)'}}>Navigate to Worklist to browse generated data →</div>
              </div>
            )}
          </div>
        )}

      </div>{/* end workspace */}

      {/* ARIA SIDE PANEL (always visible) */}
      <div className="aria-panel" style={{position:'fixed',right:0,top:'var(--header)',bottom:0,width:'290px',zIndex:50,borderLeft:'1px solid var(--border)',display:'flex',flexDirection:'column'}}>
        <div className="aria-avatar-area">
          <div className="aria-face-wrap"><AriaFace state={ariaState}/></div>
          <div className="aria-name">ARIA</div>
          <div className="aria-sub">Advanced Radiology Intelligence Assistant</div>

          {/* State indicator */}
          <div className="aria-state-wrap">
            <div className={`aria-state ${ariaState==='listening'?'listening':ariaState==='speaking'?'speaking':ariaState==='thinking'?'thinking':''}`}>
              <div className="state-dot"/>
              {ariaState==='idle'?'Ready':ariaState==='speaking'?'Speaking':ariaState==='listening'?'Listening':'Thinking...'}
            </div>
          </div>

          {/* Waveform visualiser */}
          <div className={`aria-waveform ${ariaState==='speaking'||ariaState==='listening'?'active':ariaState==='thinking'?'thinking':''}`}>
            {Array.from({length:18}).map((_,i)=>{
              const isSpeaking = ariaState==='speaking';
              const isListening = ariaState==='listening';
              const isThinking = ariaState==='thinking';
              const baseH = isSpeaking||isListening ? 4+Math.random()*18 : 3;
              return <div key={i} className="wave-bar" style={{
                height: `${isSpeaking||isListening ? baseH : 3}px`,
                background: isThinking?'#b090ff':isListening?'var(--urgent)':'var(--accent)',
                animationDelay: isThinking?`${i*0.07}s`:'0s',
                transition: isSpeaking ? `height ${0.08+Math.random()*0.06}s ease` : 'height 0.3s ease'
              }}/>;
            })}
          </div>

          {/* Big TALK button */}
          <div className="talk-btn-wrap">
            <button className={`talk-btn ${isRecording?'recording':'idle'}`} onClick={toggleRecording}>
              <span className="talk-btn-icon">{isRecording?'⏹':'🎙'}</span>
              {isRecording?'STOP RECORDING':'TAP TO TALK'}
            </button>
          </div>

          {/* Mute + voice row */}
          <div className="voice-row">
            <button className={`mute-btn ${ariaMuted?'muted':''}`} onClick={()=>setAriaMuted(m=>!m)}>
              {ariaMuted?'🔇 Muted':'🔊 Audio On'}
            </button>
            <select className="voice-sel" value={ariaVoice} onChange={e=>setAriaVoice(e.target.value)}>
              <option value="nova">Nova</option>
              <option value="alloy">Alloy</option>
              <option value="shimmer">Shimmer</option>
            </select>
          </div>

          {/* Captions */}
          <div className="aria-captions" ref={captionsRef} dangerouslySetInnerHTML={{__html: String(ariaCaptions||"")}} />
        </div>
        <div className="aria-chat">
          {ariaMessages.map((m,i)=>(
            <div key={i} className={`msg ${m.role}`}>
              <div className="msg-role">{m.role==='aria'?'ARIA':'You'}</div>
              <div className="msg-body">{m.body}</div>
            </div>
          ))}
        </div>
        <div className="aria-input-row">
          <input className="aria-input" value={ariaInput} onChange={e=>setAriaInput(e.target.value)} placeholder="Type to ask ARIA..." onKeyDown={e=>e.key==='Enter'&&ariaQuery(ariaInput)}/>
          <button className="aria-send" onClick={()=>ariaQuery(ariaInput)}>➤</button>
        </div>
      </div>

      {/* NOTIFICATION */}
      {notif && <Notif msg={notif.msg} type={notif.type} onClose={()=>setNotif(null)}/>}
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>
</body>
</html>